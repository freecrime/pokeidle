<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pok√©mon Idle Fighter</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323:wght@400&display=swap');

:root {
  --bg: #0a0a1a;
  --bg2: #111128;
  --panel: #1a1a35;
  --border: #3a3a6a;
  --accent: #4fc3f7;
  --gold: #ffd700;
  --red: #ef5350;
  --green: #66bb6a;
  --purple: #ab47bc;
  --shiny: #ff69b4;
  --text: #e0e0ff;
  --text2: #8888bb;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'VT323', monospace;
  font-size: 18px;
  overflow: hidden;
  height: 100vh;
  width: 100vw;
}

/* Starfield background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: 
    radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,0.4) 0%, transparent 100%),
    radial-gradient(1px 1px at 30% 70%, rgba(255,255,255,0.3) 0%, transparent 100%),
    radial-gradient(1px 1px at 60% 10%, rgba(255,255,255,0.4) 0%, transparent 100%),
    radial-gradient(1px 1px at 80% 50%, rgba(255,255,255,0.3) 0%, transparent 100%),
    radial-gradient(1px 1px at 50% 90%, rgba(255,255,255,0.2) 0%, transparent 100%);
  pointer-events: none;
  z-index: 0;
}

/* STARTER SCREEN */
#starter-screen {
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2e 50%, #0a1a1a 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

#starter-screen h1 {
  font-family: 'Press Start 2P', monospace;
  font-size: 22px;
  color: var(--gold);
  text-shadow: 0 0 20px rgba(255,215,0,0.7), 0 0 40px rgba(255,215,0,0.3);
  margin-bottom: 10px;
  animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
  from { text-shadow: 0 0 20px rgba(255,215,0,0.7), 0 0 40px rgba(255,215,0,0.3); }
  to { text-shadow: 0 0 30px rgba(255,215,0,1), 0 0 60px rgba(255,215,0,0.5), 0 0 80px rgba(255,100,0,0.3); }
}

#starter-screen p {
  color: var(--text2);
  margin-bottom: 40px;
  font-size: 20px;
}

.starter-grid {
  display: flex;
  gap: 30px;
  flex-wrap: wrap;
  justify-content: center;
}

.starter-card {
  background: var(--panel);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
  width: 160px;
}

.starter-card:hover {
  border-color: var(--accent);
  transform: translateY(-8px) scale(1.05);
  box-shadow: 0 10px 30px rgba(79,195,247,0.3);
}

.starter-card img {
  width: 96px;
  height: 96px;
  image-rendering: pixelated;
}

.starter-card .name {
  font-family: 'Press Start 2P', monospace;
  font-size: 9px;
  color: var(--gold);
  margin-top: 10px;
}

.starter-card .types {
  display: flex;
  gap: 4px;
  justify-content: center;
  margin-top: 6px;
}

/* MAIN GAME */
#game {
  display: none;
  height: 100vh;
  width: 100vw;
  flex-direction: column;
  position: relative;
  z-index: 1;
}

/* TOP BAR */
#topbar {
  background: var(--panel);
  border-bottom: 2px solid var(--border);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 20px;
  height: 50px;
  flex-shrink: 0;
}

#topbar h2 {
  font-family: 'Press Start 2P', monospace;
  font-size: 10px;
  color: var(--gold);
}

.resource {
  display: flex;
  align-items: center;
  gap: 6px;
  background: rgba(255,255,255,0.05);
  padding: 4px 12px;
  border-radius: 20px;
  border: 1px solid var(--border);
  font-size: 16px;
}

.resource .icon { font-size: 18px; }
.resource .val { color: var(--gold); font-weight: bold; }

/* MAIN LAYOUT */
#main-layout {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* BATTLE ARENA */
#arena {
  flex: 1;
  position: relative;
  background: linear-gradient(180deg, #0d1b3e 0%, #1a2a50 40%, #2d4a30 40%, #1a3020 100%);
  overflow: hidden;
  min-width: 0;
}

/* clouds */
#arena::before {
  content: '';
  position: absolute;
  top: 60px;
  left: -100px;
  width: 200px;
  height: 60px;
  background: rgba(255,255,255,0.06);
  border-radius: 50%;
  box-shadow: 300px 20px 0 rgba(255,255,255,0.04), 600px -10px 0 rgba(255,255,255,0.05);
  animation: clouds 30s linear infinite;
}

@keyframes clouds {
  to { transform: translateX(1200px); }
}

/* ground line */
#arena::after {
  content: '';
  position: absolute;
  bottom: 120px;
  left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent, rgba(100,200,100,0.3), transparent);
}

.fighter-area {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#player-area {
  left: 40px;
  bottom: 135px;
}

#enemy-area {
  right: 40px;
  bottom: 260px; /* higher than player for classic Pokemon battle feel */
}

.fighter-sprite {
  width: 450px;
  height: 450px;
  image-rendering: pixelated;
  position: relative;
}

#player-area .fighter-sprite { transform: scaleX(-1); }

/* Player attack: lunges forward with a hop */
.fighter-sprite.attack-anim {
  animation: attack 0.5s cubic-bezier(0.25,0.46,0.45,0.94);
}

@keyframes attack {
  0%   { transform: scaleX(-1) translate(0px, 0px) rotate(0deg); }
  20%  { transform: scaleX(-1) translate(30px, -25px) rotate(-5deg); }
  45%  { transform: scaleX(-1) translate(190px, 0px) rotate(3deg); }
  70%  { transform: scaleX(-1) translate(80px, -10px) rotate(-2deg); }
  100% { transform: scaleX(-1) translate(0px, 0px) rotate(0deg); }
}

/* Enemy attack: swoops forward */
#enemy-area .fighter-sprite.attack-anim {
  animation: enemy-attack 0.5s cubic-bezier(0.25,0.46,0.45,0.94);
}
@keyframes enemy-attack {
  0%   { transform: translate(0px, 0px) rotate(0deg); }
  20%  { transform: translate(-30px, -25px) rotate(5deg); }
  45%  { transform: translate(-190px, 0px) rotate(-3deg); }
  70%  { transform: translate(-80px, -10px) rotate(2deg); }
  100% { transform: translate(0px, 0px) rotate(0deg); }
}

/* Hit flash + shake */
.fighter-sprite.hurt-anim {
  animation: hurt 0.45s ease-out;
}
@keyframes hurt {
  0%   { filter: brightness(1); transform: translateX(0); }
  15%  { filter: brightness(4) sepia(1) hue-rotate(300deg); transform: translateX(-12px); }
  30%  { filter: brightness(1); transform: translateX(10px); }
  50%  { filter: brightness(3) sepia(1) hue-rotate(300deg); transform: translateX(-8px); }
  70%  { filter: brightness(1); transform: translateX(6px); }
  100% { filter: brightness(1); transform: translateX(0); }
}

/* Player hurt needs to preserve the flip */
#player-area .fighter-sprite.hurt-anim {
  animation: hurt-player 0.45s ease-out;
}
@keyframes hurt-player {
  0%   { filter: brightness(1); transform: scaleX(-1) translateX(0); }
  15%  { filter: brightness(4) sepia(1) hue-rotate(300deg); transform: scaleX(-1) translateX(-12px); }
  30%  { filter: brightness(1); transform: scaleX(-1) translateX(10px); }
  50%  { filter: brightness(3) sepia(1) hue-rotate(300deg); transform: scaleX(-1) translateX(-8px); }
  70%  { filter: brightness(1); transform: scaleX(-1) translateX(6px); }
  100% { filter: brightness(1); transform: scaleX(-1) translateX(0); }
}

.shiny-sprite {
  filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)) drop-shadow(0 0 16px rgba(255,100,200,0.6));
  animation: shiny-pulse 2s ease-in-out infinite alternate;
}
@keyframes shiny-pulse {
  from { filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)) drop-shadow(0 0 16px rgba(255,100,200,0.6)); }
  to { filter: drop-shadow(0 0 16px rgba(255,215,0,1)) drop-shadow(0 0 30px rgba(0,200,255,0.8)) brightness(1.2); }
}

.info-box {
  background: rgba(0,0,0,0.75);
  border: 2px solid var(--border);
  border-radius: 8px;
  padding: 8px 12px;
  min-width: 180px;
  backdrop-filter: blur(4px);
}

.info-box .pname {
  font-family: 'Press Start 2P', monospace;
  font-size: 8px;
  color: var(--gold);
}

.info-box .plevel {
  font-size: 14px;
  color: var(--text2);
}

.bar-wrap {
  margin-top: 4px;
}

.bar-label {
  font-size: 13px;
  color: var(--text2);
}

.bar {
  height: 8px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  overflow: hidden;
  margin-top: 2px;
}

.bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}

.hp-fill { background: linear-gradient(90deg, #ef5350, #ff7043); }
.exp-fill { background: linear-gradient(90deg, #7e57c2, #ab47bc); }

/* Battle log */
#battle-log {
  position: absolute;
  bottom: 10px;
  left: 10px;
  right: 10px;
  background: rgba(0,0,0,0.8);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px;
  height: 100px;
  overflow-y: auto;
  font-size: 14px;
}

#battle-log::-webkit-scrollbar { width: 4px; }
#battle-log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.log-entry {
  padding: 2px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; } }

.log-dmg { color: var(--red); }
.log-heal { color: var(--green); }
.log-exp { color: var(--purple); }
.log-evolve { color: var(--gold); font-weight: bold; }
.log-shiny { color: var(--shiny); }

/* Damage numbers */
.dmg-num {
  position: absolute;
  font-family: 'Press Start 2P', monospace;
  font-size: 14px;
  font-weight: bold;
  pointer-events: none;
  animation: floatUp 1.2s ease-out forwards;
  z-index: 10;
}
@keyframes floatUp {
  0% { opacity: 1; transform: translateY(0) scale(1); }
  50% { transform: translateY(-40px) scale(1.2); }
  100% { opacity: 0; transform: translateY(-70px) scale(0.8); }
}

/* RIGHT PANEL */
#right-panel {
  width: 340px;
  background: var(--panel);
  border-left: 2px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
}

.panel-tabs {
  display: flex;
  border-bottom: 2px solid var(--border);
}

.tab-btn {
  flex: 1;
  background: none;
  border: none;
  color: var(--text2);
  cursor: pointer;
  padding: 10px 4px;
  font-family: 'VT323', monospace;
  font-size: 15px;
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
}

.tab-btn.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
  background: rgba(79,195,247,0.08);
}

.tab-content {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: none;
}

.tab-content.active { display: block; }
.tab-content::-webkit-scrollbar { width: 4px; }
.tab-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* TEAM SLOTS */
.team-slots {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 12px;
}

.team-slot {
  background: rgba(255,255,255,0.04);
  border: 2px solid var(--border);
  border-radius: 8px;
  padding: 8px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  min-height: 90px;
  text-align: center;
}

.team-slot.active-fighter {
  border-color: var(--accent);
  box-shadow: 0 0 12px rgba(79,195,247,0.3);
}

.team-slot:hover {
  border-color: var(--text2);
}

.team-slot.shiny-slot {
  background: linear-gradient(135deg, rgba(255,105,180,0.1), rgba(0,200,255,0.1));
  border-color: var(--shiny);
  animation: rainbow-border 3s linear infinite;
}

@keyframes rainbow-border {
  0% { border-color: #ff69b4; box-shadow: 0 0 10px rgba(255,105,180,0.5); }
  25% { border-color: #4fc3f7; box-shadow: 0 0 10px rgba(79,195,247,0.5); }
  50% { border-color: #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
  75% { border-color: #ab47bc; box-shadow: 0 0 10px rgba(171,71,188,0.5); }
  100% { border-color: #ff69b4; box-shadow: 0 0 10px rgba(255,105,180,0.5); }
}

.team-slot img {
  width: 52px;
  height: 52px;
  image-rendering: pixelated;
}

.team-slot .slot-name {
  font-family: 'Press Start 2P', monospace;
  font-size: 6px;
  color: var(--gold);
  display: block;
  margin-top: 2px;
}

.team-slot .slot-level {
  font-size: 13px;
  color: var(--text2);
}

.team-slot .shiny-badge {
  position: absolute;
  top: 4px;
  right: 4px;
  font-size: 14px;
}

.empty-slot {
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--border);
  font-size: 26px;
}

/* Gacha */
.gacha-section {
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 12px;
}

.gacha-section h3 {
  font-family: 'Press Start 2P', monospace;
  font-size: 8px;
  color: var(--gold);
  margin-bottom: 10px;
  text-align: center;
}

.gacha-btns {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.btn {
  background: linear-gradient(135deg, var(--panel), rgba(255,255,255,0.05));
  border: 2px solid var(--border);
  color: var(--text);
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'VT323', monospace;
  font-size: 16px;
  transition: all 0.2s;
  flex: 1;
}

.btn:hover {
  border-color: var(--accent);
  color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(79,195,247,0.2);
}

.btn.gold {
  background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,165,0,0.1));
  border-color: var(--gold);
  color: var(--gold);
}

.btn.gold:hover {
  box-shadow: 0 4px 12px rgba(255,215,0,0.3);
  transform: translateY(-2px);
}

.btn.disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none !important;
}

/* BOX / POKEMON LIST */
.poke-box {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.poke-card {
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  position: relative;
}

.poke-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
}

.poke-card.shiny-card {
  background: linear-gradient(135deg, rgba(255,105,180,0.08), rgba(0,200,255,0.08));
  animation: rainbow-border 3s linear infinite;
}

.poke-card img {
  width: 56px;
  height: 56px;
  image-rendering: pixelated;
}

.poke-card .cname {
  font-family: 'Press Start 2P', monospace;
  font-size: 6px;
  color: var(--gold);
  display: block;
  margin-top: 2px;
}

.poke-card .clevel {
  font-size: 13px;
  color: var(--text2);
}

/* ITEMS */
.item-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-bottom: 12px;
}

.item-cell {
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: 6px;
  width: 60px;
  height: 60px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 26px;
  position: relative;
}

.item-cell:hover { border-color: var(--accent); transform: scale(1.08); }
.item-cell .item-count {
  position: absolute;
  bottom: 2px;
  right: 4px;
  font-size: 12px;
  color: var(--gold);
}

/* MODAL */
#modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  z-index: 500;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}

#modal-overlay.active { display: flex; }

#modal-box {
  background: var(--panel);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  max-width: 480px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
}

#modal-box::-webkit-scrollbar { width: 4px; }
#modal-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

#modal-close {
  position: absolute;
  top: 12px;
  right: 12px;
  background: none;
  border: none;
  color: var(--text2);
  font-size: 22px;
  cursor: pointer;
}

#modal-title {
  font-family: 'Press Start 2P', monospace;
  font-size: 11px;
  color: var(--gold);
  margin-bottom: 16px;
}

/* Type badges */
.type-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
  text-transform: uppercase;
}

/* Gacha pull result */
.gacha-result {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.gacha-result img {
  image-rendering: pixelated;
  animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popIn {
  0% { transform: scale(0) rotate(-10deg); opacity: 0; }
  100% { transform: scale(1) rotate(0); opacity: 1; }
}

.gacha-result.is-shiny img {
  filter: drop-shadow(0 0 16px rgba(255,215,0,1)) drop-shadow(0 0 32px rgba(255,100,200,0.8));
  animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), shiny-pulse 2s 0.5s ease-in-out infinite alternate;
}

.shiny-text {
  font-family: 'Press Start 2P', monospace;
  font-size: 12px;
  background: linear-gradient(90deg, #ff69b4, #ffd700, #4fc3f7, #ab47bc, #ff69b4);
  background-size: 200%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: shimmer 2s linear infinite;
}

@keyframes shimmer {
  to { background-position: 200% center; }
}

/* Stats display */
.stat-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.stat-name {
  width: 60px;
  font-size: 14px;
  color: var(--text2);
  flex-shrink: 0;
}

.stat-bar-bg {
  flex: 1;
  height: 10px;
  background: rgba(255,255,255,0.1);
  border-radius: 5px;
  overflow: hidden;
}

.stat-bar-fill {
  height: 100%;
  border-radius: 5px;
  background: linear-gradient(90deg, var(--accent), var(--purple));
  transition: width 0.5s ease;
}

.stat-val {
  width: 40px;
  text-align: right;
  font-size: 15px;
  color: var(--gold);
}

/* EVOLVE flash */
.evolve-flash {
  animation: evolveFlash 1s ease-out;
}

@keyframes evolveFlash {
  0% { filter: brightness(1); }
  25% { filter: brightness(5) blur(4px); }
  50% { filter: brightness(1); }
  75% { filter: brightness(5) blur(4px); }
  100% { filter: brightness(1); }
}

/* Bottom team bar */
#bottom-bar {
  background: var(--panel);
  border-top: 2px solid var(--border);
  padding: 8px 16px;
  display: flex;
  gap: 10px;
  height: 90px;
  flex-shrink: 0;
  align-items: center;
}

.bottom-slot {
  width: 70px;
  height: 70px;
  background: rgba(255,255,255,0.04);
  border: 2px solid var(--border);
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  flex-shrink: 0;
}

.bottom-slot:hover { border-color: var(--accent); }
.bottom-slot.active-slot { border-color: var(--accent); box-shadow: 0 0 12px rgba(79,195,247,0.4); }
.bottom-slot.shiny-slot-b { animation: rainbow-border 3s linear infinite; }

.bottom-slot img {
  width: 44px;
  height: 44px;
  image-rendering: pixelated;
}

.bottom-slot .b-name {
  font-family: 'Press Start 2P', monospace;
  font-size: 5px;
  color: var(--gold);
}

.bottom-slot .b-hp-bar {
  position: absolute;
  bottom: 3px;
  left: 4px;
  right: 4px;
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  overflow: hidden;
}

.b-hp-fill {
  height: 100%;
  background: var(--green);
  transition: width 0.4s;
}

.bottom-slot .b-shiny {
  position: absolute;
  top: 2px;
  right: 3px;
  font-size: 11px;
}

/* Wild pokemon indicator */
#wild-indicator {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 4px 16px;
  font-size: 14px;
  color: var(--text2);
  display: flex;
  gap: 12px;
  align-items: center;
}

.region-badge {
  background: rgba(255,215,0,0.15);
  border: 1px solid var(--gold);
  border-radius: 12px;
  padding: 2px 10px;
  color: var(--gold);
  font-size: 13px;
}

/* Encounter flash - subtle, not eye-burning */
#encounter-flash {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, rgba(150,200,255,0.5) 0%, rgba(80,120,200,0.2) 100%);
  opacity: 0;
  pointer-events: none;
  z-index: 50;
}

/* Notification toast */
#toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--panel);
  border: 2px solid var(--accent);
  border-radius: 8px;
  padding: 10px 20px;
  font-size: 16px;
  opacity: 0;
  transition: all 0.4s;
  z-index: 999;
  pointer-events: none;
  max-width: 400px;
  text-align: center;
}

#toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* Diamond Road */
#road-ui {
  padding: 4px;
}

.road-header {
  font-family: 'Press Start 2P', monospace;
  font-size: 9px;
  color: #b388ff;
  text-align: center;
  margin-bottom: 6px;
  text-shadow: 0 0 12px rgba(179,136,255,0.6);
}

.road-floor-card {
  background: linear-gradient(135deg, rgba(30,0,60,0.9), rgba(10,0,40,0.9));
  border: 1px solid #5c35a0;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.road-floor-card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 50% 0%, rgba(179,136,255,0.1), transparent 70%);
  pointer-events: none;
}

.road-floor-card:hover {
  border-color: #9c64f5;
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(140,80,255,0.3);
}

.road-floor-card.active-floor {
  border-color: #b388ff;
  box-shadow: 0 0 20px rgba(179,136,255,0.5);
}

.road-floor-title {
  font-family: 'Press Start 2P', monospace;
  font-size: 7px;
  color: #b388ff;
  margin-bottom: 4px;
}

.road-floor-lvl {
  font-size: 13px;
  color: var(--text2);
  margin-bottom: 4px;
}

.road-floor-reward {
  font-size: 13px;
  color: #ffd700;
}

.road-progress-bar {
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  overflow: hidden;
  margin-top: 5px;
}

.road-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #7b1fa2, #e040fb);
  transition: width 0.5s;
}

/* Diamond Road battle arena override */
#arena.road-mode {
  background: 
    radial-gradient(ellipse at 20% 50%, rgba(80,0,180,0.4) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 50%, rgba(0,80,180,0.4) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 100%, rgba(140,0,255,0.3) 0%, transparent 40%),
    linear-gradient(180deg, #000005 0%, #020010 40%, #050020 100%);
}

/* Animated stars for road mode */
#arena.road-mode::after {
  content: '';
  position: absolute;
  inset: 0;
  background-image: 
    radial-gradient(1px 1px at 5% 10%, white 0%, transparent 100%),
    radial-gradient(1px 1px at 15% 30%, rgba(200,150,255,0.8) 0%, transparent 100%),
    radial-gradient(2px 2px at 25% 60%, white 0%, transparent 100%),
    radial-gradient(1px 1px at 35% 20%, rgba(150,200,255,0.8) 0%, transparent 100%),
    radial-gradient(1px 1px at 45% 80%, white 0%, transparent 100%),
    radial-gradient(2px 2px at 55% 40%, rgba(255,200,150,0.8) 0%, transparent 100%),
    radial-gradient(1px 1px at 65% 70%, white 0%, transparent 100%),
    radial-gradient(1px 1px at 75% 15%, rgba(200,255,150,0.8) 0%, transparent 100%),
    radial-gradient(2px 2px at 85% 55%, white 0%, transparent 100%),
    radial-gradient(1px 1px at 92% 35%, rgba(255,150,200,0.8) 0%, transparent 100%),
    radial-gradient(1px 1px at 8% 85%, white 0%, transparent 100%),
    radial-gradient(1px 1px at 48% 5%, rgba(200,200,255,0.8) 0%, transparent 100%);
  animation: twinkle 4s ease-in-out infinite alternate;
  pointer-events: none;
  z-index: 0;
}

@keyframes twinkle {
  0%   { opacity: 0.6; }
  50%  { opacity: 1; }
  100% { opacity: 0.4; }
}

/* Responsive adjustments */
@media (max-width: 900px) {
  #right-panel { width: 280px; }
}
</style>
</head>
<body>

<!-- STARTER SCREEN -->
<div id="starter-screen">
  <h1>‚ö° POK√âMON IDLE ‚ö°</h1>
  <p>Choose your starter!</p>
  <div class="starter-grid" id="starter-grid">
    <!-- Filled by JS -->
  </div>
</div>

<!-- MAIN GAME -->
<div id="game">
  <!-- TOP BAR -->
  <div id="topbar">
    <h2>‚ö° PKM IDLE</h2>
    <div class="resource"><span class="icon">üí∞</span><span class="val" id="res-gold">0</span> Gold</div>
    <div class="resource"><span class="icon">üíé</span><span class="val" id="res-gems">10</span> Gems</div>
    <div class="resource"><span class="icon">üèÜ</span><span class="val" id="res-wins">0</span> Wins</div>
  </div>

  <!-- MAIN LAYOUT -->
  <div id="main-layout">
    <!-- BATTLE ARENA -->
    <div id="arena">
      <div id="encounter-flash"></div>
      
      <div id="wild-indicator">
        <span id="region-label" class="region-badge">Pallet Town</span>
        <span id="wave-label">Wave 1</span>
      </div>

      <!-- Player fighter -->
      <div id="player-area" class="fighter-area">
        <div class="info-box" id="player-info">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <span class="pname" id="player-name">‚Äî</span>
            <span class="plevel" id="player-level">Lv.1</span>
          </div>
          <div class="bar-wrap">
            <div class="bar-label">HP <span id="player-hp-txt">0/0</span></div>
            <div class="bar"><div class="bar-fill hp-fill" id="player-hp-bar" style="width:100%"></div></div>
          </div>
          <div class="bar-wrap">
            <div class="bar-label">EXP</div>
            <div class="bar"><div class="bar-fill exp-fill" id="player-exp-bar" style="width:0%"></div></div>
          </div>
        </div>
        <img id="player-sprite" class="fighter-sprite" src="" alt="">
      </div>

      <!-- Enemy fighter -->
      <div id="enemy-area" class="fighter-area">
        <div class="info-box" id="enemy-info">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <span class="pname" id="enemy-name">‚Äî</span>
            <span class="plevel" id="enemy-level">Lv.1</span>
          </div>
          <div class="bar-wrap">
            <div class="bar-label">HP <span id="enemy-hp-txt">0/0</span></div>
            <div class="bar"><div class="bar-fill hp-fill" id="enemy-hp-bar" style="width:100%"></div></div>
          </div>
        </div>
        <img id="enemy-sprite" class="fighter-sprite" src="" alt="">
      </div>

      <!-- Battle log -->
      <div id="battle-log"></div>
    </div>

    <!-- RIGHT PANEL -->
    <div id="right-panel">
      <div class="panel-tabs">
        <button class="tab-btn active" onclick="switchTab('team')">Team</button>
        <button class="tab-btn" onclick="switchTab('box')">Box</button>
        <button class="tab-btn" onclick="switchTab('gacha')">Gacha</button>
        <button class="tab-btn" onclick="switchTab('items')">Items</button>
        <button class="tab-btn" onclick="switchTab('road')" style="color:#b388ff">üíé</button>
      </div>

      <!-- TEAM TAB -->
      <div class="tab-content active" id="tab-team">
        <div style="font-family:'Press Start 2P';font-size:8px;color:var(--text2);margin-bottom:8px;">ACTIVE TEAM (6)</div>
        <div class="team-slots" id="team-slots-grid"></div>
        <div style="font-size:14px;color:var(--text2);">Click a Pok√©mon in Box to add to team.</div>
        <div style="margin-top:12px;font-family:'Press Start 2P';font-size:7px;color:var(--text2)">AUTO BATTLE</div>
        <div style="margin-top:6px;display:flex;gap:8px">
          <button class="btn gold" id="auto-btn" onclick="toggleAuto()">‚è∏ PAUSE</button>
          <button class="btn" onclick="switchNextPokemon()">‚û° NEXT PKM</button>
        </div>
        <div style="margin-top:8px">
          <button class="btn" onclick="confirmWipeData()" style="border-color:#ef5350;color:#ef5350;width:100%">üóë Reset Save</button>
        </div>
        <div style="margin-top:6px;font-size:12px;color:var(--text2);text-align:center">üíæ Auto-saves every 30s</div>
      </div>

      <!-- BOX TAB -->
      <div class="tab-content" id="tab-box">
        <div style="font-family:'Press Start 2P';font-size:8px;color:var(--text2);margin-bottom:8px;">POK√âMON BOX</div>
        <div class="poke-box" id="poke-box-grid"></div>
      </div>

      <!-- GACHA TAB -->
      <div class="tab-content" id="tab-gacha">
        <div class="gacha-section">
          <h3>üé≤ POK√âMON GACHA</h3>
          <div style="font-size:13px;color:var(--text2);margin-bottom:8px;text-align:center">
            ‚ú® Shiny: 1/512 ¬∑ Rates vary by rarity
          </div>
          <div class="gacha-btns">
            <button class="btn" onclick="doPokemonGacha(1)">√ó 1<br><span style="font-size:13px;color:var(--gold)">üíé 5</span></button>
            <button class="btn gold" onclick="doPokemonGacha(10)">√ó 10<br><span style="font-size:13px;color:var(--gold)">üíé 40</span></button>
          </div>
        </div>
        <div class="gacha-section" style="border-color:#9c27b0;background:linear-gradient(135deg,rgba(80,0,120,0.3),rgba(30,0,60,0.2))">
          <h3 style="color:#ce93d8">‚ö° EPIC GACHA</h3>
          <div style="font-size:13px;color:var(--text2);margin-bottom:8px;text-align:center">
            ‚ú® Shiny: 1/64 ¬∑ Boosted Legendary rate<br>
            <span style="color:#ce93d8">Higher chance for rare Pok√©mon</span>
          </div>
          <div class="gacha-btns">
            <button class="btn" style="border-color:#9c27b0;color:#ce93d8" onclick="doEpicGacha(1)">√ó 1<br><span style="font-size:13px;color:var(--gold)">üíé 50</span></button>
            <button class="btn" style="border-color:#9c27b0;color:#ce93d8;background:rgba(80,0,120,0.2)" onclick="doEpicGacha(10)">√ó 10<br><span style="font-size:13px;color:var(--gold)">üíé 450</span></button>
          </div>
        </div>
        <div class="gacha-section">
          <h3>üéÅ ITEM GACHA</h3>
          <div style="font-size:13px;color:var(--text2);margin-bottom:8px;text-align:center">
            Get held items &amp; equipment
          </div>
          <div class="gacha-btns">
            <button class="btn" onclick="doItemGacha(1)">√ó 1<br><span style="font-size:13px;color:var(--gold)">üí∞ 200</span></button>
            <button class="btn gold" onclick="doItemGacha(10)">√ó 10<br><span style="font-size:13px;color:var(--gold)">üí∞ 1800</span></button>
          </div>
        </div>
        <div class="gacha-section" style="border-color:#00c853;background:linear-gradient(135deg,rgba(0,50,20,0.4),rgba(0,20,10,0.2))">
          <h3 style="color:#69f0ae">üåü FREE DAILY</h3>
          <button class="btn" style="border-color:#00c853;color:#69f0ae;width:100%;margin-top:4px" id="daily-btn" onclick="doDaily()">CLAIM FREE PULL</button>
        </div>
        <div class="gacha-section" style="border-color:#ff6d00;background:linear-gradient(135deg,rgba(80,20,0,0.5),rgba(30,5,0,0.3))">
          <h3 style="color:#ff9e40">üêâ EVENT BOSS</h3>
          <div style="text-align:center;margin-bottom:8px">
            <div style="font-size:13px;color:#ff9e40;font-family:'Press Start 2P';font-size:8px">RAYQUAZA Lv.270</div>
            <div style="font-size:12px;color:var(--text2);margin-top:4px">A legendary sky dragon.<br>Defeat it to capture it!<br>Shiny chance: <span style="color:#ffd700">1/25</span></div>
          </div>
          <button class="btn" style="border-color:#ff6d00;color:#ff9e40;width:100%" onclick="startEventBoss()">‚öîÔ∏è CHALLENGE<br><span style="font-size:12px;color:var(--text2)">üíé 150 Gems</span></button>
        </div>
      </div>

      <!-- ITEMS TAB -->
      <div class="tab-content" id="tab-items">
        <div style="font-family:'Press Start 2P';font-size:8px;color:var(--text2);margin-bottom:8px;">INVENTORY</div>
        <div class="item-grid" id="item-grid"></div>
        <div style="font-size:14px;color:var(--text2);margin-top:8px">Click to equip ¬∑ Right-click to trash.</div>
      </div>

      <!-- DIAMOND ROAD TAB -->
      <div class="tab-content" id="tab-road">
        <div id="road-ui"></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM BAR -->
  <div id="bottom-bar">
    <div style="font-family:'Press Start 2P';font-size:7px;color:var(--text2);writing-mode:vertical-rl;text-orientation:mixed;margin-right:4px">TEAM</div>
    <div id="bottom-slots" style="display:flex;gap:8px;flex:1;overflow-x:auto;padding-bottom:2px"></div>
  </div>
</div>

<!-- MODAL -->
<div id="modal-overlay" onclick="closeModal(event)">
  <div id="modal-box">
    <button id="modal-close" onclick="closeModal()">‚úï</button>
    <div id="modal-title">Info</div>
    <div id="modal-content"></div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// ============================================================
// DATA
// ============================================================

const TYPE_COLORS = {
  normal:'#A8A878', fire:'#F08030', water:'#6890F0', electric:'#F8D030',
  grass:'#78C850', ice:'#98D8D8', fighting:'#C03028', poison:'#A040A0',
  ground:'#E0C068', flying:'#A890F0', psychic:'#F85888', bug:'#A8B820',
  rock:'#B8A038', ghost:'#705898', dragon:'#7038F8', dark:'#705848',
  steel:'#B8B8D0', fairy:'#EE99AC'
};

// Starter pokemon
const STARTERS = [
  {id:1, name:'Bulbasaur', types:['grass','poison']},
  {id:4, name:'Charmander', types:['fire']},
  {id:7, name:'Squirtle', types:['water']},
  {id:152, name:'Chikorita', types:['grass']},
  {id:155, name:'Cyndaquil', types:['fire']},
  {id:158, name:'Totodile', types:['water']},
  {id:252, name:'Treecko', types:['grass']},
  {id:255, name:'Torchic', types:['fire']},
  {id:258, name:'Mudkip', types:['water']},
];

// Wild pokemon pool by region (id, name, types, base rarity weight)
const REGIONS = [
  {
    name: 'Pallet Town', minWave: 1,
    pool: [
      {id:16,name:'Pidgey',types:['normal','flying'],w:10},
      {id:19,name:'Rattata',types:['normal'],w:10},
      {id:21,name:'Spearow',types:['normal','flying'],w:8},
      {id:23,name:'Ekans',types:['poison'],w:7},
      {id:25,name:'Pikachu',types:['electric'],w:4},
      {id:39,name:'Jigglypuff',types:['normal','fairy'],w:6},
      {id:52,name:'Meowth',types:['normal'],w:5},
    ]
  },
  {
    name: 'Viridian Forest', minWave: 20,
    pool: [
      {id:10,name:'Caterpie',types:['bug'],w:10},
      {id:13,name:'Weedle',types:['bug','poison'],w:10},
      {id:11,name:'Metapod',types:['bug'],w:7},
      {id:14,name:'Kakuna',types:['bug','poison'],w:7},
      {id:12,name:'Butterfree',types:['bug','flying'],w:3},
      {id:15,name:'Beedrill',types:['bug','poison'],w:3},
      {id:35,name:'Clefairy',types:['normal','fairy'],w:2},
    ]
  },
  {
    name: 'Mt. Moon', minWave: 50,
    pool: [
      {id:41,name:'Zubat',types:['poison','flying'],w:10},
      {id:74,name:'Geodude',types:['rock','ground'],w:8},
      {id:50,name:'Diglett',types:['ground'],w:6},
      {id:27,name:'Sandshrew',types:['ground'],w:6},
      {id:46,name:'Paras',types:['bug','grass'],w:5},
      {id:79,name:'Slowpoke',types:['water','psychic'],w:3},
    ]
  },
  {
    name: 'Cerulean City', minWave: 100,
    pool: [
      {id:54,name:'Psyduck',types:['water'],w:8},
      {id:60,name:'Poliwag',types:['water'],w:8},
      {id:72,name:'Tentacool',types:['water','poison'],w:7},
      {id:98,name:'Krabby',types:['water'],w:6},
      {id:116,name:'Horsea',types:['water'],w:5},
      {id:118,name:'Goldeen',types:['water'],w:5},
      {id:120,name:'Staryu',types:['water'],w:3},
    ]
  },
  {
    name: 'Pokemon Tower', minWave: 200,
    pool: [
      {id:92,name:'Gastly',types:['ghost','poison'],w:10},
      {id:93,name:'Haunter',types:['ghost','poison'],w:6},
      {id:94,name:'Gengar',types:['ghost','poison'],w:2},
      {id:56,name:'Mankey',types:['fighting'],w:7},
      {id:66,name:'Machop',types:['fighting'],w:6},
    ]
  },
  {
    name: 'Safari Zone', minWave: 400,
    pool: [
      {id:113,name:'Chansey',types:['normal'],w:3},
      {id:115,name:'Kangaskhan',types:['normal'],w:3},
      {id:123,name:'Scyther',types:['bug','flying'],w:3},
      {id:127,name:'Pinsir',types:['bug'],w:3},
      {id:128,name:'Tauros',types:['normal'],w:4},
      {id:147,name:'Dratini',types:['dragon'],w:2},
      {id:148,name:'Dragonair',types:['dragon'],w:1},
    ]
  },
  {
    name: 'Victory Road', minWave: 800,
    pool: [
      {id:66,name:'Machop',types:['fighting'],w:6},
      {id:95,name:'Onix',types:['rock','ground'],w:5},
      {id:111,name:'Rhyhorn',types:['ground','rock'],w:5},
      {id:112,name:'Rhydon',types:['ground','rock'],w:3},
      {id:149,name:'Dragonite',types:['dragon','flying'],w:1},
    ]
  },
];

// Evolution chains (simplified)
const EVOLUTIONS = {
  1:{id:2,name:'Ivysaur',level:16}, 2:{id:3,name:'Venusaur',level:32},
  4:{id:5,name:'Charmeleon',level:16}, 5:{id:6,name:'Charizard',level:36},
  7:{id:8,name:'Wartortle',level:16}, 8:{id:9,name:'Blastoise',level:36},
  10:{id:11,name:'Metapod',level:7}, 11:{id:12,name:'Butterfree',level:10},
  13:{id:14,name:'Kakuna',level:7}, 14:{id:15,name:'Beedrill',level:10},
  16:{id:17,name:'Pidgeotto',level:18}, 17:{id:18,name:'Pidgeot',level:36},
  19:{id:20,name:'Raticate',level:20},
  21:{id:22,name:'Fearow',level:20},
  23:{id:24,name:'Arbok',level:22},
  25:{id:26,name:'Raichu',level:30},
  27:{id:28,name:'Sandslash',level:22},
  29:{id:30,name:'Nidorina',level:16}, 30:{id:31,name:'Nidoqueen',level:36},
  32:{id:33,name:'Nidorino',level:16}, 33:{id:34,name:'Nidoking',level:36},
  35:{id:36,name:'Clefable',level:36},
  37:{id:38,name:'Ninetales',level:30},
  39:{id:40,name:'Wigglytuff',level:30},
  41:{id:42,name:'Golbat',level:22}, 42:{id:169,name:'Crobat',level:50},
  43:{id:44,name:'Gloom',level:21}, 44:{id:45,name:'Vileplume',level:36},
  46:{id:47,name:'Parasect',level:24},
  48:{id:49,name:'Venomoth',level:31},
  50:{id:51,name:'Dugtrio',level:26},
  52:{id:53,name:'Persian',level:28},
  54:{id:55,name:'Golduck',level:33},
  56:{id:57,name:'Primeape',level:28},
  58:{id:59,name:'Arcanine',level:36},
  60:{id:61,name:'Poliwhirl',level:25}, 61:{id:62,name:'Poliwrath',level:40},
  63:{id:64,name:'Kadabra',level:16}, 64:{id:65,name:'Alakazam',level:36},
  66:{id:67,name:'Machoke',level:28}, 67:{id:68,name:'Machamp',level:40},
  72:{id:73,name:'Tentacruel',level:30},
  74:{id:75,name:'Graveler',level:25}, 75:{id:76,name:'Golem',level:36},
  79:{id:80,name:'Slowbro',level:37},
  81:{id:82,name:'Magneton',level:30},
  84:{id:85,name:'Dodrio',level:31},
  86:{id:87,name:'Dewgong',level:34},
  88:{id:89,name:'Muk',level:38},
  90:{id:91,name:'Cloyster',level:36},
  92:{id:93,name:'Haunter',level:25}, 93:{id:94,name:'Gengar',level:36},
  95:{id:208,name:'Steelix',level:50},
  98:{id:99,name:'Kingler',level:28},
  100:{id:101,name:'Electrode',level:30},
  102:{id:103,name:'Exeggutor',level:36},
  104:{id:105,name:'Marowak',level:28},
  108:{id:463,name:'Lickilicky',level:50},
  111:{id:112,name:'Rhydon',level:42}, 112:{id:464,name:'Rhyperior',level:65},
  113:{id:242,name:'Blissey',level:55},
  116:{id:117,name:'Seadra',level:32},
  118:{id:119,name:'Seaking',level:33},
  120:{id:121,name:'Starmie',level:36},
  123:{id:212,name:'Scizor',level:50},
  127:{id:214,name:'Heracross',level:45}, // rewired
  129:{id:130,name:'Gyarados',level:20},
  133:{id:134,name:'Vaporeon',level:30},
  147:{id:148,name:'Dragonair',level:30}, 148:{id:149,name:'Dragonite',level:55},
  152:{id:153,name:'Bayleef',level:16}, 153:{id:154,name:'Meganium',level:32},
  155:{id:156,name:'Quilava',level:14}, 156:{id:157,name:'Typhlosion',level:36},
  158:{id:159,name:'Croconaw',level:18}, 159:{id:160,name:'Feraligatr',level:30},
  252:{id:253,name:'Grovyle',level:16}, 253:{id:254,name:'Sceptile',level:36},
  255:{id:256,name:'Combusken',level:16}, 256:{id:257,name:'Blaziken',level:36},
  258:{id:259,name:'Marshtomp',level:16}, 259:{id:260,name:'Swampert',level:36},
};

// Hold items
const ITEMS = [
  {id:'leftovers', name:'Leftovers', emoji:'üçé', desc:'Restores 1/16 max HP every battle tick', effect:'regen'},
  {id:'choice_band', name:'Choice Band', emoji:'üéÄ', desc:'+50% Attack damage', effect:'atk_boost', value:1.5},
  {id:'choice_specs', name:'Choice Specs', emoji:'üîµ', desc:'+50% Sp.Atk damage', effect:'spatk_boost', value:1.5},
  {id:'life_orb', name:'Life Orb', emoji:'üîÆ', desc:'+30% damage dealt, lose 10% max HP per attack', effect:'life_orb'},
  {id:'focus_sash', name:'Focus Sash', emoji:'ü©π', desc:'Survive one lethal hit with 1 HP (from full HP)', effect:'focus_sash'},
  {id:'lucky_egg', name:'Lucky Egg', emoji:'ü•ö', desc:'+50% EXP gained from battle', effect:'lucky_egg', value:1.5},
  {id:'shell_bell', name:'Shell Bell', emoji:'üîî', desc:'Heal 1/8 of damage you deal', effect:'shell_bell'},
  {id:'rocky_helmet', name:'Rocky Helmet', emoji:'‚õëÔ∏è', desc:'Enemy loses 1/6 max HP when they hit you', effect:'rocky_helmet'},
  {id:'assault_vest', name:'Assault Vest', emoji:'ü¶∫', desc:'+50% Sp.Def (reduces incoming damage by 25%)', effect:'spdef_boost', value:1.5},
  {id:'wide_lens', name:'Wide Lens', emoji:'üî≠', desc:'+10% Speed (attack cooldown reduced)', effect:'spd_boost', value:1.1},
  {id:'dragon_scale', name:'Dragon Scale', emoji:'üê≤', desc:'+25% all stats for Dragon-type Pok√©mon', effect:'type_boost', type:'dragon'},
  {id:'magnet', name:'Magnet', emoji:'üß≤', desc:'+25% all stats for Electric-type Pok√©mon', effect:'type_boost', type:'electric'},
  {id:'exp_share', name:'Exp. Share', emoji:'üì°', desc:'Holder gains 30% of EXP earned by the active fighter even while benched', effect:'exp_share'},
];

// Base stats cache from PokeAPI
const statsCache = {};

// ============================================================
// GAME STATE
// ============================================================

let gameState = {
  gold: 500,
  gems: 15,
  wins: 0,
  wave: 1,
  autoBattle: true,
  team: [],
  box: [],
  inventory: {},
  equippedItems: {},
  currentFighterIdx: 0,
  dailyClaimed: false,
  lastDaily: 0,
  road: {
    active: false,
    floor: 0,
    winsOnFloor: 0,
    winsNeeded: 30,
  }
};

let currentEnemy = null;
let battleTimer = null;
let playerAttackTimer = null;
let enemyAttackTimer = null;
let battlePaused = false;
let pUid = 0;

function newPokemonEntry(id, name, types, level, isShiny=false) {
  return {
    uid: ++pUid,
    id, name, types, level, isShiny,
    currentHp: null, // will be set after stat load
    statsLoaded: false,
    stats: null,
    exp: 0,
    expToNext: calcExpToNext(level),
  };
}

function calcExpToNext(level) {
  // Slower progression: cubic scaling
  return Math.floor(Math.pow(level, 3) * 0.8 + level * 50 + 100);
}

function getEffectiveStat(stat, pokemon, statName) {
  // Scale with level beyond 100
  let val = stat;
  if(pokemon.level > 100) {
    val = Math.floor(val * (1 + (pokemon.level - 100) * 0.008));
  }
  // Apply item effects
  const item = ITEMS.find(i => i.id === gameState.equippedItems[pokemon.uid]);
  if(item) {
    if(item.effect === 'atk_boost' && statName === 'attack') val = Math.floor(val * item.value);
    if(item.effect === 'spatk_boost' && statName === 'special-attack') val = Math.floor(val * item.value);
    if(item.effect === 'spdef_boost' && statName === 'special-defense') val = Math.floor(val * item.value);
    if(item.effect === 'spd_boost' && statName === 'speed') val = Math.floor(val * item.value);
    if(item.effect === 'type_boost' && pokemon.types.includes(item.type)) val = Math.floor(val * 1.25);
  }
  return val;
}

function getMaxHp(pokemon) {
  if(!pokemon.stats) return 100;
  const base = pokemon.stats.find(s=>s.stat.name==='hp').base_stat;
  let hp = Math.floor((base * 2 * pokemon.level / 100) + pokemon.level + 10);
  if(pokemon.level > 100) hp = Math.floor(hp * (1 + (pokemon.level-100)*0.01));
  return hp;
}

function getAttack(pokemon) {
  if(!pokemon.stats) return 50;
  const base = pokemon.stats.find(s=>s.stat.name==='attack').base_stat;
  const spa = pokemon.stats.find(s=>s.stat.name==='special-attack').base_stat;
  const atk = Math.max(base, spa);
  let val = Math.floor((atk * 2 * pokemon.level / 100) + 5);
  return getEffectiveStat(val, pokemon, atk >= spa ? 'attack' : 'special-attack');
}

function getSpeed(pokemon) {
  if(!pokemon.stats) return 50;
  const base = pokemon.stats.find(s=>s.stat.name==='speed').base_stat;
  let val = Math.floor((base * 2 * pokemon.level / 100) + 5);
  return getEffectiveStat(val, pokemon, 'speed');
}

// ============================================================
// API
// ============================================================

async function fetchPokemonStats(id) {
  if(statsCache[id]) return statsCache[id];
  try {
    const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
    const data = await res.json();
    statsCache[id] = data.stats;
    return data.stats;
  } catch(e) {
    // Fallback generic stats
    return [
      {stat:{name:'hp'},base_stat:65},
      {stat:{name:'attack'},base_stat:65},
      {stat:{name:'defense'},base_stat:65},
      {stat:{name:'special-attack'},base_stat:65},
      {stat:{name:'special-defense'},base_stat:65},
      {stat:{name:'speed'},base_stat:65},
    ];
  }
}

function getSpriteUrl(id, isShiny=false, front=true) {
  const dir = isShiny ? 'shiny' : 'other/official-artwork';
  if(front && !isShiny) return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;
  if(isShiny) return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${id}.png`;
  return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
}

function getBattleSprite(id, isShiny=false) {
  if(isShiny) return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${id}.png`;
  return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
}

// ============================================================
// STARTER SCREEN
// ============================================================

function initStarterScreen() {
  // Try to load save first
  if(loadGame() && gameState.box.length > 0) {
    // Restore game
    document.getElementById('starter-screen').style.display = 'none';
    const game = document.getElementById('game');
    game.style.display = 'flex';
    game.style.flexDirection = 'column';
    if(gameState.road.active) document.getElementById('arena').classList.add('road-mode');
    renderAll();
    if(gameState.road.active) spawnRoadEnemy();
    else spawnEnemy();
    startBattle();
    toast('‚úÖ Save loaded!');
    return;
  }

  const grid = document.getElementById('starter-grid');
  grid.innerHTML = '';
  STARTERS.forEach(s => {
    const card = document.createElement('div');
    card.className = 'starter-card';
    card.innerHTML = `
      <img src="${getSpriteUrl(s.id)}" alt="${s.name}" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${s.id}.png'">
      <div class="name">${s.name}</div>
      <div class="types">${s.types.map(t=>`<span class="type-badge" style="background:${TYPE_COLORS[t]}">${t}</span>`).join('')}</div>
    `;
    card.onclick = () => chooseStarter(s);
    grid.appendChild(card);
  });
}

async function chooseStarter(s) {
  const isShiny = Math.random() < 1/512;
  const pk = newPokemonEntry(s.id, s.name, s.types, 5, isShiny);
  pk.stats = await fetchPokemonStats(s.id);
  pk.statsLoaded = true;
  pk.currentHp = getMaxHp(pk);
  gameState.box.push(pk);
  gameState.team.push(pk);

  document.getElementById('starter-screen').style.display = 'none';
  const game = document.getElementById('game');
  game.style.display = 'flex';
  game.style.flexDirection = 'column';

  if(isShiny) toast(`üåü SHINY ${s.name.toUpperCase()}! You lucky soul!`, 4000);
  else toast(`You chose ${s.name}!`);

  renderAll();
  spawnEnemy();
  startBattle();
}

// ============================================================
// BATTLE SYSTEM
// ============================================================

function getCurrentFighter() {
  for(let i=0; i<gameState.team.length; i++) {
    const idx = (gameState.currentFighterIdx + i) % gameState.team.length;
    if(gameState.team[idx] && gameState.team[idx].currentHp > 0) return gameState.team[idx];
  }
  return null;
}

function getActiveRegion() {
  let region = REGIONS[0];
  for(const r of REGIONS) {
    if(gameState.wave >= r.minWave) region = r;
  }
  return region;
}

async function spawnEnemy() {
  const region = getActiveRegion();
  document.getElementById('region-label').textContent = region.name;
  document.getElementById('wave-label').textContent = `Wave ${gameState.wave}`;

  // Pick random pokemon from pool
  const pool = region.pool;
  const totalW = pool.reduce((s,p)=>s+p.w, 0);
  let r = Math.random() * totalW;
  let chosen = pool[0];
  for(const p of pool) {
    r -= p.w;
    if(r <= 0) { chosen = p; break; }
  }

  // Enemy level scales with wave
  const baseLevel = Math.min(250, Math.max(1, Math.floor(gameState.wave * 0.8 + 2)));
  const level = Math.max(1, baseLevel + Math.floor((Math.random()-0.5)*4));
  const isShiny = Math.random() < 1/512;

  const enemy = newPokemonEntry(chosen.id, chosen.name, chosen.types, level, isShiny);
  enemy.stats = await fetchPokemonStats(chosen.id);
  enemy.statsLoaded = true;
  enemy.currentHp = getMaxHp(enemy);

  currentEnemy = enemy;

  // Gentle encounter flash - not eye-burning
  const flash = document.getElementById('encounter-flash');
  flash.style.transition = 'opacity 0.05s';
  flash.style.opacity = '1';
  setTimeout(()=>{ flash.style.transition = 'opacity 1.2s'; flash.style.opacity = '0'; }, 120);

  updateEnemyUI();
  if(isShiny) {
    toast(`‚ú® Wild SHINY ${chosen.name} appeared!`, 3000);
    addLog(`‚ú® Wild SHINY ${chosen.name} appeared!`, 'log-shiny');
  } else {
    addLog(`A wild ${chosen.name} (Lv.${level}) appeared!`);
  }
}

function startBattle() {
  if(battleTimer) clearInterval(battleTimer);
  battleTimer = setInterval(battleTick, 100);
}

let playerAttackCooldown = 0;
let enemyAttackCooldown = 0;
const BASE_ATTACK_MS = 2500; // ms between attacks

function battleTick() {
  if(battlePaused || !currentEnemy) return;
  const player = getCurrentFighter();
  if(!player || !player.statsLoaded) return;

  const now = Date.now();

  // Leftovers: heal each second (every 1000ms)
  if(!battleTick.lastRegen) battleTick.lastRegen = now;
  if(now - battleTick.lastRegen >= 1000) {
    battleTick.lastRegen = now;
    const regenItem = ITEMS.find(i=>i.id===gameState.equippedItems[player.uid]);
    if(regenItem?.effect === 'regen') {
      const heal = Math.max(1, Math.floor(getMaxHp(player) / 16));
      const prev = player.currentHp;
      player.currentHp = Math.min(getMaxHp(player), player.currentHp + heal);
      if(player.currentHp > prev) addLog(`${player.name} restored ${player.currentHp-prev} HP (Leftovers)!`, 'log-heal');
    }
  }

  // Player attack timing
  const playerSpeed = getSpeed(player);
  const playerDelay = Math.max(800, BASE_ATTACK_MS - playerSpeed * 5);

  if(!playerAttackCooldown) playerAttackCooldown = now + playerDelay;
  if(now >= playerAttackCooldown) {
    playerAttackCooldown = now + playerDelay;
    doPlayerAttack(player);
  }

  // Enemy attack timing
  const enemySpeed = currentEnemy.statsLoaded ? getSpeed(currentEnemy) : 50;
  const enemyDelay = Math.max(900, BASE_ATTACK_MS - enemySpeed * 5);

  if(!enemyAttackCooldown) enemyAttackCooldown = now + enemyDelay + 300;
  if(now >= enemyAttackCooldown) {
    enemyAttackCooldown = now + enemyDelay;
    doEnemyAttack(player);
  }

  updatePlayerUI(player);
  updateEnemyUI();
  updateBottomBar();
}

function doPlayerAttack(player) {
  if(!currentEnemy || currentEnemy.currentHp <= 0) return;
  let dmg = Math.max(1, getAttack(player) + Math.floor((Math.random()-0.5)*10));

  // Life orb
  const item = ITEMS.find(i=>i.id===gameState.equippedItems[player.uid]);
  if(item?.effect === 'life_orb') {
    dmg = Math.floor(dmg * 1.3);
    const selfDmg = Math.floor(getMaxHp(player) * 0.1);
    player.currentHp = Math.max(1, player.currentHp - selfDmg);
  }

  // Shell bell
  if(item?.effect === 'shell_bell') {
    const heal = Math.floor(dmg / 8);
    player.currentHp = Math.min(getMaxHp(player), player.currentHp + heal);
  }

  currentEnemy.currentHp = Math.max(0, currentEnemy.currentHp - dmg);

  // Rocky helmet
  const enemyItem = ITEMS.find(i=>i.id===gameState.equippedItems[currentEnemy.uid]);
  if(enemyItem?.effect === 'rocky_helmet') {
    const recoil = Math.floor(getMaxHp(player) / 6);
    player.currentHp = Math.max(0, player.currentHp - recoil);
  }

  animateAttack('player');
  showDmgNum(dmg, 'enemy-area', player.isShiny ? '#ffd700' : '#ff6b6b');
  animateHurt('enemy-sprite');
  addLog(`${player.name} dealt ${dmg} damage!`, 'log-dmg');

  if(currentEnemy.currentHp <= 0) {
    enemyDefeated(player);
  }
}

function doEnemyAttack(player) {
  if(!currentEnemy || player.currentHp <= 0) return;
  let dmg = Math.max(1, getAttack(currentEnemy) + Math.floor((Math.random()-0.5)*10));

  const item = ITEMS.find(i=>i.id===gameState.equippedItems[player.uid]);

  // Assault Vest: reduces incoming damage by 25%
  if(item?.effect === 'spdef_boost') {
    dmg = Math.floor(dmg * 0.75);
  }

  // Focus sash: survive from full hp
  if(item?.effect === 'focus_sash' && player.currentHp >= getMaxHp(player) && dmg >= player.currentHp) {
    dmg = player.currentHp - 1;
    addLog(`üí´ Focus Sash saved ${player.name}!`, 'log-heal');
  }

  player.currentHp = Math.max(0, player.currentHp - dmg);

  animateAttack('enemy');
  showDmgNum(dmg, 'player-area', '#ef5350');
  animateHurt('player-sprite');
  addLog(`${currentEnemy.name} dealt ${dmg} damage!`, 'log-dmg');

  if(player.currentHp <= 0) {
    playerPokemonFainted(player);
  }
}

function enemyDefeated(player) {
  // Boss special handling
  if(bossBattleActive && currentEnemy?.isBoss) {
    handleBossDefeated(player);
    return;
  }

  addLog(`${currentEnemy.name} was defeated!`, 'log-heal');

  // Gold reward
  const goldGain = Math.floor(currentEnemy.level * 3 + Math.random() * currentEnemy.level * 2 + 5);
  const gemGain = Math.random() < 0.05 ? 1 : 0;
  gameState.gold += goldGain;
  if(gemGain) { gameState.gems += gemGain; toast('üíé Found a Gem!'); }
  gameState.wins++;

  // Diamond Road logic
  if(gameState.road.active) {
    const floor = ROAD_FLOORS[gameState.road.floor];
    gameState.road.winsOnFloor++;

    // Award gems at the grindy rate
    let gemGainRoad = 0;
    const w = gameState.road.winsOnFloor;
    if(floor.gemsPerThree && w % 3 === 0) gemGainRoad = 1;
    else if(floor.gemsPerFive && w % 5 === 0) gemGainRoad = 1;
    else if(w % 10 === 0) gemGainRoad = 1;

    if(gemGainRoad > 0) {
      gameState.gems += gemGainRoad;
      addLog(`üíé +${gemGainRoad} Gem from Diamond Road! (${w}/${floor.winsNeeded})`, 'log-evolve');
      updateResourceUI();
    }

    if(gameState.road.winsOnFloor >= floor.winsNeeded) {
      // Floor cleared!
      gameState.gems += floor.bonusGems;
      addLog(`üéâ ${floor.name} CLEARED! +${floor.bonusGems} bonus Gems!`, 'log-evolve');
      toast(`üéâ Floor cleared! +${floor.bonusGems} üíé Gems!`, 4000);
      updateResourceUI();
      if(gameState.road.floor + 1 < ROAD_FLOORS.length) {
        gameState.road.floor++;
        gameState.road.winsOnFloor = 0;
        gameState.road.winsNeeded = ROAD_FLOORS[gameState.road.floor].winsNeeded;
        addLog(`‚¨ÜÔ∏è Advanced to ${ROAD_FLOORS[gameState.road.floor].name}!`, 'log-evolve');
      } else {
        addLog(`üëë You completed all Diamond Road floors!`, 'log-evolve');
        toast(`üëë ALL FLOORS CLEARED! Incredible!`, 5000);
        gameState.road.active = false;
        document.getElementById('arena').classList.remove('road-mode');
      }
    }
  } else {
    gameState.wave++;
  }

  // EXP gain
  let expGain = Math.floor(currentEnemy.level * 15 + Math.random() * 20 + 10);
  const item = ITEMS.find(i=>i.id===gameState.equippedItems[player.uid]);
  if(item?.effect === 'lucky_egg') expGain = Math.floor(expGain * 1.5);

  giveExp(player, expGain);

  addLog(`+${goldGain} gold, +${expGain} EXP`, 'log-exp');

  currentEnemy = null;
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;
  battleTick.lastRegen = 0;

  updateResourceUI();
  renderAll();

  const delay = gameState.road.active ? 800 : 1200;
  setTimeout(gameState.road.active ? spawnRoadEnemy : spawnEnemy, delay);
}

function playerPokemonFainted(player) {
  addLog(`${player.name} fainted!`, 'log-dmg');
  // Auto-heal fainted pokemon to 30% so they can come back later
  const reviveHp = Math.max(1, Math.floor(getMaxHp(player) * 0.30));
  player.currentHp = reviveHp;
  addLog(`${player.name} is resting and will recover...`, 'log-heal');

  // Find next alive pokemon in team (skip fainted by checking if they were JUST set to reviveHp)
  // We need to find someone that was already alive (currentHp > reviveHp or different pokemon)
  let nextIdx = -1;
  for(let i = 1; i <= gameState.team.length; i++) {
    const idx = (gameState.currentFighterIdx + i) % gameState.team.length;
    const p = gameState.team[idx];
    // Consider alive if they have more than the just-set revive amount or if they weren't the one that just fainted
    if(p && p !== player && p.currentHp > 0) {
      nextIdx = idx;
      break;
    }
  }

  if(nextIdx >= 0) {
    gameState.currentFighterIdx = nextIdx;
    const next = gameState.team[nextIdx];
    addLog(`Go, ${next.name}! üí™`, 'log-heal');
    updatePlayerUI(next);
    playerAttackCooldown = 0;
    enemyAttackCooldown = Date.now() + 800; // give player a moment
    renderBottomBar();
  } else {
    // All fainted - full revive at 25% and restart
    addLog(`All Pok√©mon fainted! Everyone is revived at 25% HP!`, 'log-heal');
    toast('All Pok√©mon fainted! Reviving...', 3000);
    gameState.team.forEach(p => { p.currentHp = Math.max(1, Math.floor(getMaxHp(p)*0.25)); });
    gameState.currentFighterIdx = 0;
    playerAttackCooldown = 0;
    enemyAttackCooldown = 0;
    renderBottomBar();
  }
}

function getNextAlive() {
  for(const p of gameState.team) {
    if(p.currentHp > 0) return p;
  }
  return null;
}

function giveExp(pokemon, amount) {
  pokemon.exp += amount;
  while(pokemon.exp >= pokemon.expToNext && pokemon.level < 250) {
    pokemon.exp -= pokemon.expToNext;
    pokemon.level++;
    pokemon.expToNext = calcExpToNext(pokemon.level);
    pokemon.currentHp = getMaxHp(pokemon);
    addLog(`${pokemon.name} grew to Lv.${pokemon.level}!`, 'log-exp');
    toast(`‚¨ÜÔ∏è ${pokemon.name} is now Lv.${pokemon.level}!`);
    checkEvolution(pokemon);
  }

  // Exp Share: give 30% exp to all box pokemon holding exp_share (not the active fighter)
  const expShareAmt = Math.floor(amount * 0.30);
  if(expShareAmt > 0) {
    gameState.box.forEach(p => {
      if(p === pokemon) return;
      const item = ITEMS.find(i=>i.id===gameState.equippedItems[p.uid]);
      if(item?.effect === 'exp_share') {
        p.exp += expShareAmt;
        while(p.exp >= p.expToNext && p.level < 250) {
          p.exp -= p.expToNext;
          p.level++;
          p.expToNext = calcExpToNext(p.level);
          p.currentHp = getMaxHp(p);
          addLog(`${p.name} (Exp.Share) grew to Lv.${p.level}!`, 'log-exp');
          checkEvolution(p);
        }
      }
    });
  }
}

async function checkEvolution(pokemon) {
  const evo = EVOLUTIONS[pokemon.id];
  if(evo && pokemon.level >= evo.level) {
    // Evolve!
    const oldName = pokemon.name;
    pokemon.id = evo.id;
    pokemon.name = evo.name;
    // Fetch new stats
    pokemon.stats = await fetchPokemonStats(evo.id);
    const oldHp = pokemon.currentHp;
    const oldMax = getMaxHp(pokemon);
    pokemon.currentHp = Math.min(getMaxHp(pokemon), getMaxHp(pokemon) * oldHp / oldMax + 30);

    addLog(`‚ú® ${oldName} evolved into ${evo.name}!`, 'log-evolve');
    toast(`üéâ ${oldName} evolved into ${evo.name}!`, 4000);

    // Evolve animation
    const sprite = document.getElementById('player-sprite');
    if(sprite) sprite.classList.add('evolve-flash');
    setTimeout(()=>{ if(sprite) sprite.classList.remove('evolve-flash'); }, 1000);

    updatePlayerUI(pokemon);
    renderAll();

    // Check for further evolution
    setTimeout(()=>checkEvolution(pokemon), 500);
  }
}

function switchNextPokemon() {
  if(gameState.team.length === 0) return;
  gameState.currentFighterIdx = (gameState.currentFighterIdx + 1) % gameState.team.length;
  playerAttackCooldown = 0;
  toast(`Switched to ${gameState.team[gameState.currentFighterIdx].name}!`);
  renderAll();
}

// ============================================================
// UI UPDATE
// ============================================================

function updatePlayerUI(player) {
  if(!player) return;
  document.getElementById('player-name').textContent = (player.isShiny ? '‚òÖ ' : '') + player.name.toUpperCase();
  document.getElementById('player-level').textContent = `Lv.${player.level}`;
  const maxHp = getMaxHp(player);
  const hpPct = Math.max(0, Math.min(100, (player.currentHp / maxHp) * 100));
  const expPct = Math.min(100, (player.exp / player.expToNext) * 100);
  document.getElementById('player-hp-bar').style.width = hpPct + '%';
  document.getElementById('player-hp-bar').style.background = hpPct > 50 ? 'linear-gradient(90deg,#66bb6a,#43a047)' : hpPct > 25 ? 'linear-gradient(90deg,#ffa726,#fb8c00)' : 'linear-gradient(90deg,#ef5350,#e53935)';
  document.getElementById('player-hp-txt').textContent = `${Math.max(0,player.currentHp)}/${maxHp}`;
  document.getElementById('player-exp-bar').style.width = expPct + '%';

  const sprite = document.getElementById('player-sprite');
  sprite.src = getBattleSprite(player.id, player.isShiny);
  sprite.className = 'fighter-sprite' + (player.isShiny ? ' shiny-sprite' : '');
}

function updateEnemyUI() {
  if(!currentEnemy) return;
  document.getElementById('enemy-name').textContent = (currentEnemy.isShiny ? '‚òÖ ' : '') + currentEnemy.name.toUpperCase();
  document.getElementById('enemy-level').textContent = `Lv.${currentEnemy.level}`;
  const maxHp = getMaxHp(currentEnemy);
  const hpPct = Math.max(0, Math.min(100, (currentEnemy.currentHp / maxHp) * 100));
  document.getElementById('enemy-hp-bar').style.width = hpPct + '%';
  document.getElementById('enemy-hp-bar').style.background = hpPct > 50 ? 'linear-gradient(90deg,#66bb6a,#43a047)' : hpPct > 25 ? 'linear-gradient(90deg,#ffa726,#fb8c00)' : 'linear-gradient(90deg,#ef5350,#e53935)';
  document.getElementById('enemy-hp-txt').textContent = `${Math.max(0,currentEnemy.currentHp)}/${maxHp}`;

  const sprite = document.getElementById('enemy-sprite');
  sprite.src = getBattleSprite(currentEnemy.id, currentEnemy.isShiny);
  sprite.className = 'fighter-sprite' + (currentEnemy.isShiny ? ' shiny-sprite' : '');
}

function updateResourceUI() {
  document.getElementById('res-gold').textContent = formatNum(gameState.gold);
  document.getElementById('res-gems').textContent = formatNum(gameState.gems);
  document.getElementById('res-wins').textContent = formatNum(gameState.wins);
}

function formatNum(n) {
  if(n >= 1000000) return (n/1000000).toFixed(1)+'M';
  if(n >= 1000) return (n/1000).toFixed(1)+'K';
  return n;
}

function renderAll() {
  updateResourceUI();
  const player = getCurrentFighter();
  if(player) updatePlayerUI(player);
  updateEnemyUI();
  renderTeamSlots();
  renderPokemonBox();
  renderBottomBar();
  renderItems();
  updateBottomBar();
}

function renderTeamSlots() {
  const grid = document.getElementById('team-slots-grid');
  grid.innerHTML = '';
  for(let i=0; i<6; i++) {
    const p = gameState.team[i];
    const div = document.createElement('div');
    div.className = 'team-slot' + (p && i===gameState.currentFighterIdx ? ' active-fighter' : '') + (p?.isShiny ? ' shiny-slot' : '');
    if(p) {
      const maxHp = getMaxHp(p);
      const hpPct = Math.max(0, Math.min(100, (p.currentHp / maxHp)*100));
      div.innerHTML = `
        ${p.isShiny ? '<span class="shiny-badge">‚òÖ</span>' : ''}
        <img src="${getSpriteUrl(p.id, p.isShiny)}" onerror="this.src='${getBattleSprite(p.id,p.isShiny)}'">
        <span class="slot-name">${p.name}</span>
        <span class="slot-level">Lv.${p.level}</span>
        <div class="bar" style="margin-top:3px"><div class="bar-fill hp-fill" style="width:${hpPct}%"></div></div>
      `;
      div.onclick = () => {
        gameState.currentFighterIdx = i;
        playerAttackCooldown = 0;
        renderAll();
      };
      // Right click to remove from team
      div.oncontextmenu = (e) => { e.preventDefault(); removeFromTeam(i); };
    } else {
      div.classList.add('empty-slot');
      div.innerHTML = '+';
    }
    grid.appendChild(div);
  }
}

function renderPokemonBox() {
  const grid = document.getElementById('poke-box-grid');
  grid.innerHTML = '';
  if(gameState.box.length === 0) {
    grid.innerHTML = '<div style="color:var(--text2);font-size:14px">No Pok√©mon yet. Use Gacha!</div>';
    return;
  }
  gameState.box.forEach((p, idx) => {
    const div = document.createElement('div');
    div.className = 'poke-card' + (p.isShiny ? ' shiny-card' : '');
    const equippedItem = ITEMS.find(i=>i.id===gameState.equippedItems[p.uid]);
    div.innerHTML = `
      ${p.isShiny ? '<div style="position:absolute;top:3px;right:4px;font-size:14px">‚òÖ</div>' : ''}
      <img src="${getSpriteUrl(p.id, p.isShiny)}" onerror="this.src='${getBattleSprite(p.id,p.isShiny)}'">
      <span class="cname">${p.name}</span>
      <span class="clevel">Lv.${p.level}</span>
      ${equippedItem ? `<div style="font-size:16px">${equippedItem.emoji}</div>` : ''}
      <div style="display:flex;gap:3px;justify-content:center;flex-wrap:wrap;margin-top:3px">
        ${p.types.map(t=>`<span class="type-badge" style="background:${TYPE_COLORS[t]};font-size:10px">${t}</span>`).join('')}
      </div>
    `;
    div.onclick = () => showPokemonModal(p);
    grid.appendChild(div);
  });
}

function updateBottomBar() {
  renderBottomBar();
}

function renderBottomBar() {
  const bar = document.getElementById('bottom-slots');
  bar.innerHTML = '';
  for(let i=0; i<6; i++) {
    const p = gameState.team[i];
    const div = document.createElement('div');
    div.className = 'bottom-slot' + (i===gameState.currentFighterIdx ? ' active-slot' : '') + (p?.isShiny ? ' shiny-slot-b' : '');
    if(p) {
      const maxHp = getMaxHp(p);
      const hpPct = Math.max(0, Math.min(100, (p.currentHp / maxHp)*100));
      div.innerHTML = `
        ${p.isShiny ? '<span class="b-shiny">‚òÖ</span>' : ''}
        <img src="${getBattleSprite(p.id, p.isShiny)}">
        <span class="b-name">${p.name.substring(0,8)}</span>
        <div class="b-hp-bar"><div class="b-hp-fill" style="width:${hpPct}%;background:${hpPct>50?'var(--green)':hpPct>25?'orange':'red'}"></div></div>
      `;
      div.onclick = () => { gameState.currentFighterIdx = i; playerAttackCooldown=0; renderAll(); };
    } else {
      div.innerHTML = '<span style="color:var(--border);font-size:22px">+</span>';
      div.onclick = () => switchTab('box');
    }
    bar.appendChild(div);
  }
}

function renderItems() {
  const grid = document.getElementById('item-grid');
  grid.innerHTML = '';
  ITEMS.forEach(item => {
    const count = gameState.inventory[item.id] || 0;
    if(count === 0) return;
    const div = document.createElement('div');
    div.className = 'item-cell';
    div.title = `${item.name}: ${item.desc}`;
    div.innerHTML = `${item.emoji}<span class="item-count">√ó${count}</span>`;
    div.onclick = () => showItemModal(item);
    div.oncontextmenu = (e) => { e.preventDefault(); trashItem(item.id); };
    grid.appendChild(div);
  });
  if(Object.keys(gameState.inventory).length === 0 || !Object.values(gameState.inventory).some(v=>v>0)) {
    grid.innerHTML = '<div style="color:var(--text2);font-size:13px;grid-column:1/-1">No items yet! Use Item Gacha.</div>';
  }
}

// ============================================================
// ANIMATIONS
// ============================================================

function animateAttack(who) {
  const sprite = document.getElementById(who==='player'?'player-sprite':'enemy-sprite');
  sprite.classList.remove('attack-anim');
  void sprite.offsetWidth;
  sprite.classList.add('attack-anim');
  setTimeout(()=>sprite.classList.remove('attack-anim'), 500);
}

function animateHurt(id) {
  const sprite = document.getElementById(id);
  // Remove both possible hurt classes first
  sprite.classList.remove('hurt-anim', 'hurt-anim-player');
  void sprite.offsetWidth;
  // Player sprite has scaleX(-1) so needs its own keyframe
  if(id === 'player-sprite') {
    sprite.style.animation = 'none';
    void sprite.offsetWidth;
    sprite.style.animation = 'hurt-player 0.45s ease-out';
    setTimeout(()=>{ sprite.style.animation = ''; }, 500);
  } else {
    sprite.classList.add('hurt-anim');
    setTimeout(()=>sprite.classList.remove('hurt-anim'), 500);
  }
}

function showDmgNum(dmg, areaId, color) {
  const area = document.getElementById(areaId);
  if(!area) return;
  const div = document.createElement('div');
  div.className = 'dmg-num';
  div.textContent = '-' + dmg;
  div.style.color = color;
  const rect = area.getBoundingClientRect();
  const arenaRect = document.getElementById('arena').getBoundingClientRect();
  div.style.left = (rect.left - arenaRect.left + 30 + Math.random()*40) + 'px';
  div.style.top = (rect.top - arenaRect.top - 20 + Math.random()*20) + 'px';
  document.getElementById('arena').appendChild(div);
  setTimeout(()=>div.remove(), 1300);
}

// ============================================================
// BATTLE LOG
// ============================================================

function addLog(msg, cls='') {
  const log = document.getElementById('battle-log');
  const div = document.createElement('div');
  div.className = 'log-entry ' + cls;
  const time = new Date();
  div.textContent = `[${time.getHours().toString().padStart(2,'0')}:${time.getMinutes().toString().padStart(2,'0')}] ${msg}`;
  log.appendChild(div);
  // Keep only last 40 entries
  while(log.children.length > 40) log.removeChild(log.firstChild);
  log.scrollTop = log.scrollHeight;
}

// ============================================================
// GACHA
// ============================================================

const GACHA_POOL = [
  // Common
  {id:16,name:'Pidgey',types:['normal','flying'],w:20},
  {id:19,name:'Rattata',types:['normal'],w:20},
  {id:39,name:'Jigglypuff',types:['normal','fairy'],w:15},
  {id:52,name:'Meowth',types:['normal'],w:15},
  {id:54,name:'Psyduck',types:['water'],w:12},
  {id:60,name:'Poliwag',types:['water'],w:12},
  {id:56,name:'Mankey',types:['fighting'],w:12},
  {id:66,name:'Machop',types:['fighting'],w:12},
  {id:74,name:'Geodude',types:['rock','ground'],w:12},
  {id:88,name:'Grimer',types:['poison'],w:12},
  {id:92,name:'Gastly',types:['ghost','poison'],w:10},
  {id:100,name:'Voltorb',types:['electric'],w:10},
  // Uncommon
  {id:1,name:'Bulbasaur',types:['grass','poison'],w:8},
  {id:4,name:'Charmander',types:['fire'],w:8},
  {id:7,name:'Squirtle',types:['water'],w:8},
  {id:25,name:'Pikachu',types:['electric'],w:7},
  {id:35,name:'Clefairy',types:['normal','fairy'],w:7},
  {id:58,name:'Growlithe',types:['fire'],w:7},
  {id:79,name:'Slowpoke',types:['water','psychic'],w:6},
  {id:104,name:'Cubone',types:['ground'],w:6},
  {id:116,name:'Horsea',types:['water'],w:6},
  {id:147,name:'Dratini',types:['dragon'],w:5},
  // Rare
  {id:63,name:'Abra',types:['psychic'],w:4},
  {id:123,name:'Scyther',types:['bug','flying'],w:3},
  {id:127,name:'Pinsir',types:['bug'],w:3},
  {id:130,name:'Gyarados',types:['water','flying'],w:2},
  {id:133,name:'Eevee',types:['normal'],w:4},
  {id:143,name:'Snorlax',types:['normal'],w:2},
  // Epic
  {id:94,name:'Gengar',types:['ghost','poison'],w:2},
  {id:106,name:'Hitmonlee',types:['fighting'],w:2},
  {id:107,name:'Hitmonchan',types:['fighting'],w:2},
  {id:113,name:'Chansey',types:['normal'],w:2},
  {id:131,name:'Lapras',types:['water','ice'],w:2},
  {id:149,name:'Dragonite',types:['dragon','flying'],w:1},
  // Legendary (very rare)
  {id:144,name:'Articuno',types:['ice','flying'],w:0.5},
  {id:145,name:'Zapdos',types:['electric','flying'],w:0.5},
  {id:146,name:'Moltres',types:['fire','flying'],w:0.5},
  {id:150,name:'Mewtwo',types:['psychic'],w:0.2},
  {id:151,name:'Mew',types:['psychic'],w:0.1},
];

function pickFromPool(pool) {
  const totalW = pool.reduce((s,p)=>s+p.w, 0);
  let r = Math.random() * totalW;
  for(const p of pool) {
    r -= p.w;
    if(r <= 0) return p;
  }
  return pool[0];
}

// Epic Gacha pool - no commons, boosted legendaries
const EPIC_GACHA_POOL = [
  // Uncommon
  {id:1,name:'Bulbasaur',types:['grass','poison'],w:10},
  {id:4,name:'Charmander',types:['fire'],w:10},
  {id:7,name:'Squirtle',types:['water'],w:10},
  {id:25,name:'Pikachu',types:['electric'],w:9},
  {id:58,name:'Growlithe',types:['fire'],w:8},
  {id:147,name:'Dratini',types:['dragon'],w:7},
  {id:133,name:'Eevee',types:['normal'],w:8},
  // Rare
  {id:63,name:'Abra',types:['psychic'],w:7},
  {id:123,name:'Scyther',types:['bug','flying'],w:6},
  {id:130,name:'Gyarados',types:['water','flying'],w:5},
  {id:143,name:'Snorlax',types:['normal'],w:5},
  {id:149,name:'Dragonite',types:['dragon','flying'],w:4},
  // Epic
  {id:94,name:'Gengar',types:['ghost','poison'],w:5},
  {id:65,name:'Alakazam',types:['psychic'],w:4},
  {id:68,name:'Machamp',types:['fighting'],w:4},
  {id:131,name:'Lapras',types:['water','ice'],w:4},
  {id:113,name:'Chansey',types:['normal'],w:3},
  // Legendary - still rare but notably higher than regular gacha
  {id:144,name:'Articuno',types:['ice','flying'],w:3},
  {id:145,name:'Zapdos',types:['electric','flying'],w:3},
  {id:146,name:'Moltres',types:['fire','flying'],w:3},
  {id:150,name:'Mewtwo',types:['psychic'],w:1.5},
  {id:151,name:'Mew',types:['psychic'],w:1},
  {id:249,name:'Lugia',types:['psychic','flying'],w:1.5},
  {id:250,name:'Ho-Oh',types:['fire','flying'],w:1.5},
  {id:384,name:'Rayquaza',types:['dragon','flying'],w:0.5},
];

async function doEpicGacha(count) {
  const cost = count === 1 ? 50 : 450;
  if(gameState.gems < cost) { toast('Not enough Gems! üíé'); return; }
  gameState.gems -= cost;
  updateResourceUI();

  const pulls = [];
  for(let i=0; i<count; i++) {
    const chosen = pickFromPool(EPIC_GACHA_POOL);
    const isShiny = Math.random() < 1/64; // 1/64 shiny chance
    const level = Math.max(1, Math.floor(gameState.wave * 0.3 + 5));
    const pk = newPokemonEntry(chosen.id, chosen.name, chosen.types, level, isShiny);
    pk.stats = await fetchPokemonStats(chosen.id);
    pk.statsLoaded = true;
    pk.currentHp = getMaxHp(pk);
    gameState.box.push(pk);
    pulls.push(pk);
  }

  if(count === 1) {
    showGachaResult(pulls[0]);
  } else {
    showGachaResultMulti(pulls);
  }
  renderAll();
}

// ============================================================
// EVENT BOSS - RAYQUAZA Lv.270
// ============================================================
// Math: A full team of 6 at Lv.250 with choice band/life orb
// can deal ~600-900 dmg/attack. Rayquaza HP at Lv.270 ‚âà 1200.
// Rayquaza attack at Lv.270 ‚âà 650 dmg/hit.
// Player max HP at Lv.250 ‚âà 600-800 HP.
// With 6 pokemon switching in and regenning, it's a tight fight.

let bossBattleActive = false;
let bossEnemy = null;
let bossPlayerCooldown = 0;
let bossEnemyCooldown = 0;

async function startEventBoss() {
  if(gameState.gems < 150) { toast('Need 150 üíé Gems to challenge the Boss!'); return; }
  if(gameState.team.length === 0) { toast('You need a team to fight the Boss!'); return; }

  document.getElementById('modal-title').textContent = 'üêâ RAYQUAZA Lv.270';
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:8px">
      <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/384.png" 
           width="140" height="140" style="image-rendering:pixelated;filter:drop-shadow(0 0 20px rgba(100,255,100,0.6))">
      <div style="margin:10px 0;font-family:'Press Start 2P';font-size:8px;color:#ff9e40">THE SKY TITAN</div>
      <div style="font-size:14px;color:var(--text2);margin-bottom:12px">
        An ancient dragon slumbering above the clouds.<br>
        Only the strongest trainers can defeat it.<br><br>
        <span style="color:#ffd700">Drop: Rayquaza (1/25 shiny!)</span><br>
        <span style="color:var(--text2)">Cost: 150 üíé</span>
      </div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:14px">
        ‚ö†Ô∏è Tip: A full team at Lv.200+ with good items recommended.<br>
        Lv.250 with Choice Band / Life Orb = best chance.
      </div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn" style="border-color:#ff6d00;color:#ff9e40" onclick="confirmStartBoss()">‚öîÔ∏è Fight! (150üíé)</button>
        <button class="btn gold" onclick="closeModal()">Back</button>
      </div>
    </div>
  `;
  openModal();
}

async function confirmStartBoss() {
  if(gameState.gems < 150) { toast('Not enough Gems!'); closeModal(); return; }
  gameState.gems -= 150;
  updateResourceUI();
  closeModal();

  // Build Rayquaza boss
  const rayquazaStats = await fetchPokemonStats(384);
  bossEnemy = newPokemonEntry(384, 'Rayquaza', ['dragon','flying'], 270, false);
  bossEnemy.stats = rayquazaStats;
  bossEnemy.statsLoaded = true;
  bossEnemy.currentHp = getMaxHp(bossEnemy);
  bossEnemy.isBoss = true;

  // Pause normal battle and set as current enemy
  currentEnemy = bossEnemy;
  bossBattleActive = true;
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;

  // Boss arena - green glow
  document.getElementById('arena').style.background = 
    'radial-gradient(ellipse at 50% 0%, rgba(0,200,50,0.3) 0%, transparent 60%), linear-gradient(180deg, #000a00 0%, #001500 40%, #002000 100%)';

  addLog('üêâ RAYQUAZA descended from the sky!', 'log-evolve');
  addLog('‚ö†Ô∏è Defeat it to capture it!', 'log-evolve');
  toast('üêâ BOSS FIGHT: Rayquaza Lv.270!', 4000);

  updateEnemyUI();
}

function handleBossDefeated(player) {
  bossBattleActive = false;
  currentEnemy = null;
  bossEnemy = null;

  // Restore arena
  document.getElementById('arena').style.background = '';
  if(gameState.road.active) document.getElementById('arena').classList.add('road-mode');

  addLog('üéâ RAYQUAZA DEFEATED! You captured it!', 'log-evolve');
  toast('üèÜ RAYQUAZA CAPTURED!', 5000);

  // Award Rayquaza
  const isShiny = Math.random() < 1/25;
  const rq = newPokemonEntry(384, 'Rayquaza', ['dragon','flying'], 270, isShiny);
  fetchPokemonStats(384).then(stats => {
    rq.stats = stats;
    rq.statsLoaded = true;
    rq.currentHp = getMaxHp(rq);
    gameState.box.push(rq);
    renderAll();
    showGachaResult(rq);
  });

  // Resume battle
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;
  setTimeout(gameState.road.active ? spawnRoadEnemy : spawnEnemy, 2000);
}

async function doPokemonGacha(count) {
  const cost = count === 1 ? 5 : 40;
  if(gameState.gems < cost) { toast('Not enough Gems! üíé'); return; }
  gameState.gems -= cost;
  updateResourceUI();

  const pulls = [];
  for(let i=0; i<count; i++) {
    const chosen = pickFromPool(GACHA_POOL);
    const isShiny = Math.random() < 1/512;
    const level = Math.max(1, Math.floor(gameState.wave * 0.3 + 2));
    const pk = newPokemonEntry(chosen.id, chosen.name, chosen.types, level, isShiny);
    pk.stats = await fetchPokemonStats(chosen.id);
    pk.statsLoaded = true;
    pk.currentHp = getMaxHp(pk);
    gameState.box.push(pk);
    pulls.push(pk);
  }

  if(count === 1) {
    showGachaResult(pulls[0]);
  } else {
    showGachaResultMulti(pulls);
  }

  renderAll();
}

async function doItemGacha(count) {
  const cost = count === 1 ? 200 : 1800;
  if(gameState.gold < cost) { toast('Not enough Gold! üí∞'); return; }
  gameState.gold -= cost;
  updateResourceUI();

  const gotten = [];
  for(let i=0; i<count; i++) {
    const item = ITEMS[Math.floor(Math.random()*ITEMS.length)];
    gameState.inventory[item.id] = (gameState.inventory[item.id] || 0) + 1;
    gotten.push(item);
  }

  const unique = [...new Set(gotten.map(i=>i.name))];
  toast(`Got items: ${unique.join(', ')}!`);
  renderAll();

  if(count === 1) showItemGachaResult(gotten[0]);
}

function doDaily() {
  const now = Date.now();
  if(gameState.dailyClaimed && now - gameState.lastDaily < 86400000) {
    toast('Daily already claimed! Come back tomorrow.');
    return;
  }
  gameState.lastDaily = now;
  gameState.dailyClaimed = true;

  gameState.gems += 3;
  gameState.gold += 300;
  toast('üéÅ Daily claimed! +3 üíé +300 üí∞');
  document.getElementById('daily-btn').textContent = 'CLAIMED ‚úì';
  updateResourceUI();

  // Also give a free pokemon pull
  doPokemonGacha(1).then(()=>{ gameState.gems += 5; }); // refund the cost
}

// ============================================================
// MODALS
// ============================================================

function showGachaResult(pk) {
  document.getElementById('modal-title').textContent = pk.isShiny ? '‚ú® SHINY POK√âMON!' : 'New Pok√©mon!';
  document.getElementById('modal-content').innerHTML = `
    <div class="gacha-result ${pk.isShiny ? 'is-shiny' : ''}">
      <img src="${getSpriteUrl(pk.id, pk.isShiny)}" width="120" height="120" onerror="this.src='${getBattleSprite(pk.id,pk.isShiny)}'">
      ${pk.isShiny ? '<div class="shiny-text">‚≠ê SHINY ‚≠ê</div>' : ''}
      <div style="font-family:\'Press Start 2P\';font-size:10px;color:var(--gold)">${pk.name}</div>
      <div style="font-size:15px;color:var(--text2)">Lv.${pk.level}</div>
      <div style="display:flex;gap:6px">
        ${pk.types.map(t=>`<span class="type-badge" style="background:${TYPE_COLORS[t]}">${t}</span>`).join('')}
      </div>
      ${pk.stats ? renderMiniStats(pk) : ''}
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn gold" onclick="addToTeam(${pk.uid});closeModal()">Add to Team</button>
        <button class="btn" onclick="closeModal()">Keep in Box</button>
      </div>
    </div>
  `;
  openModal();
}

function showGachaResultMulti(pulls) {
  const hasShiny = pulls.some(p=>p.isShiny);
  document.getElementById('modal-title').textContent = hasShiny ? '‚ú® MULTI PULL RESULTS!' : 'Pull Results!';
  const grid = pulls.map(pk => `
    <div class="poke-card ${pk.isShiny?'shiny-card':''}" style="cursor:default">
      ${pk.isShiny ? '<div style="position:absolute;top:3px;right:4px">‚òÖ</div>' : ''}
      <img src="${getSpriteUrl(pk.id,pk.isShiny)}" width="56" height="56" onerror="this.src='${getBattleSprite(pk.id,pk.isShiny)}'">
      <span class="cname">${pk.name}</span>
      <span class="clevel">Lv.${pk.level}</span>
      ${pk.isShiny ? '<div class="shiny-text" style="font-size:9px">SHINY</div>' : ''}
    </div>
  `).join('');
  document.getElementById('modal-content').innerHTML = `
    <div class="poke-box">${grid}</div>
    <button class="btn" onclick="closeModal()" style="width:100%;margin-top:12px">Close</button>
  `;
  openModal();
}

function showPokemonModal(pk) {
  const maxHp = getMaxHp(pk);
  const equippedItem = ITEMS.find(i=>i.id===gameState.equippedItems[pk.uid]);
  const evo = EVOLUTIONS[pk.id];
  const inTeam = gameState.team.includes(pk);

  document.getElementById('modal-title').textContent = (pk.isShiny?'‚òÖ ':'')+pk.name.toUpperCase();
  document.getElementById('modal-content').innerHTML = `
    <div style="display:flex;gap:16px;align-items:center;margin-bottom:12px">
      <img src="${getSpriteUrl(pk.id,pk.isShiny)}" width="100" height="100" class="${pk.isShiny?'shiny-sprite':''}" onerror="this.src='${getBattleSprite(pk.id,pk.isShiny)}'">
      <div>
        ${pk.isShiny ? '<div class="shiny-text">‚ú® SHINY ‚ú®</div>' : ''}
        <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px">
          ${pk.types.map(t=>`<span class="type-badge" style="background:${TYPE_COLORS[t]}">${t}</span>`).join('')}
        </div>
        <div style="font-size:15px;color:var(--text2)">Level ${pk.level} / 250</div>
        <div style="font-size:15px;color:var(--text2)">HP: ${Math.max(0,pk.currentHp)} / ${maxHp}</div>
        <div style="font-size:14px;color:var(--text2)">EXP: ${pk.exp} / ${pk.expToNext}</div>
        ${evo ? `<div style="font-size:13px;color:var(--accent);margin-top:4px">‚Üí Evolves into ${evo.name} at Lv.${evo.level}</div>` : '<div style="font-size:13px;color:var(--text2)">Max evolution</div>'}
        ${equippedItem ? `<div style="margin-top:4px">Held: ${equippedItem.emoji} ${equippedItem.name}</div>` : ''}
      </div>
    </div>
    ${pk.stats ? renderMiniStats(pk) : '<div style="color:var(--text2)">Loading stats...</div>'}
    <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap">
      ${!inTeam ? `<button class="btn gold" onclick="addToTeam(${pk.uid});closeModal()">Add to Team</button>` : `<button class="btn" onclick="removeFromTeamByUid(${pk.uid});closeModal()">Remove from Team</button>`}
      <button class="btn" onclick="openEquipModal(${pk.uid})">Equip Item</button>
      ${equippedItem ? `<button class="btn" onclick="unequipItem(${pk.uid});closeModal()">Unequip</button>` : ''}
      <button class="btn" style="border-color:#ef5350;color:#ef5350" onclick="confirmRelease(${pk.uid})">Release üïäÔ∏è</button>
    </div>
  `;
  openModal();
}

function renderMiniStats(pk) {
  if(!pk.stats) return '';
  const statNames = {hp:'HP',attack:'ATK',defense:'DEF','special-attack':'SpA','special-defense':'SpD',speed:'SPD'};
  const maxBase = 255;
  return pk.stats.map(s=>{
    const name = statNames[s.stat.name] || s.stat.name;
    const effective = Math.floor((s.base_stat * 2 * pk.level / 100) + (s.stat.name==='hp' ? pk.level+10 : 5));
    const pct = Math.min(100, (s.base_stat / maxBase) * 100);
    return `
      <div class="stat-row">
        <div class="stat-name">${name}</div>
        <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%"></div></div>
        <div class="stat-val">${effective}</div>
      </div>
    `;
  }).join('');
}

function showItemModal(item) {
  document.getElementById('modal-title').textContent = `${item.emoji} ${item.name}`;
  const count = gameState.inventory[item.id] || 0;
  document.getElementById('modal-content').innerHTML = `
    <div style="font-size:15px;color:var(--text2);margin-bottom:12px">${item.desc}</div>
    <div style="font-size:14px;margin-bottom:12px">In Bag: √ó${count}</div>
    <div style="font-family:'Press Start 2P';font-size:8px;color:var(--text2);margin-bottom:8px">EQUIP TO:</div>
    <div class="poke-box">
      ${gameState.box.map(p=>{
        const eq = gameState.equippedItems[p.uid];
        return `<div class="poke-card" onclick="equipItem('${item.id}',${p.uid});closeModal()" style="cursor:pointer">
          <img src="${getSpriteUrl(p.id,p.isShiny)}" width="52" height="52">
          <span class="cname">${p.name}</span>
          <span class="clevel">Lv.${p.level}</span>
          ${eq ? `<div style="font-size:13px;color:var(--text2)">${ITEMS.find(i=>i.id===eq)?.emoji||''}</div>` : ''}
        </div>`;
      }).join('')}
    </div>
  `;
  openModal();
}

function openEquipModal(uid) {
  document.getElementById('modal-title').textContent = 'Equip Item';
  const availableItems = ITEMS.filter(i=>(gameState.inventory[i.id]||0)>0);
  if(availableItems.length===0) {
    document.getElementById('modal-content').innerHTML = '<div style="color:var(--text2)">No items in bag! Use Item Gacha.</div>';
    return;
  }
  document.getElementById('modal-content').innerHTML = `
    <div class="item-grid" style="grid-template-columns:repeat(3,1fr)">
      ${availableItems.map(item=>`
        <div class="item-cell" onclick="equipItem('${item.id}',${uid});closeModal()" title="${item.name}: ${item.desc}" style="width:80px;height:80px;font-size:32px">
          ${item.emoji}
          <span class="item-count">√ó${gameState.inventory[item.id]}</span>
          <div style="font-size:11px;margin-top:2px;color:var(--text2)">${item.name.substring(0,8)}</div>
        </div>
      `).join('')}
    </div>
  `;
}

function equipItem(itemId, uid) {
  if(!(gameState.inventory[itemId]>0)) { toast('No more of that item!'); return; }
  // Return old item if any
  const old = gameState.equippedItems[uid];
  if(old) gameState.inventory[old] = (gameState.inventory[old]||0) + 1;
  // Equip new
  gameState.equippedItems[uid] = itemId;
  gameState.inventory[itemId]--;
  const item = ITEMS.find(i=>i.id===itemId);
  const pokemon = gameState.box.find(p=>p.uid===uid);
  toast(`${item.emoji} ${item.name} equipped to ${pokemon?.name||'Pok√©mon'}!`);
  renderAll();
}

function unequipItem(uid) {
  const old = gameState.equippedItems[uid];
  if(old) {
    gameState.inventory[old] = (gameState.inventory[old]||0) + 1;
    delete gameState.equippedItems[uid];
    toast('Item unequipped!');
    renderAll();
  }
}

function showItemGachaResult(item) {
  document.getElementById('modal-title').textContent = 'üéÅ Item Get!';
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:20px">
      <div style="font-size:60px;margin-bottom:12px">${item.emoji}</div>
      <div style="font-family:'Press Start 2P';font-size:10px;color:var(--gold);margin-bottom:8px">${item.name}</div>
      <div style="color:var(--text2);font-size:15px;margin-bottom:16px">${item.desc}</div>
      <button class="btn" onclick="closeModal()" style="width:100%">Nice!</button>
    </div>
  `;
  openModal();
}

function addToTeam(uid) {
  if(gameState.team.length >= 6) { toast('Team is full! (max 6)'); return; }
  const pk = gameState.box.find(p=>p.uid===uid);
  if(!pk) return;
  if(gameState.team.includes(pk)) { toast('Already on team!'); return; }
  gameState.team.push(pk);
  toast(`${pk.name} added to team!`);
  renderAll();
}

function removeFromTeam(idx) {
  if(gameState.team.length <= 1) { toast('Need at least one Pok√©mon!'); return; }
  const pk = gameState.team.splice(idx, 1)[0];
  if(gameState.currentFighterIdx >= gameState.team.length) gameState.currentFighterIdx = 0;
  toast(`${pk.name} returned to box.`);
  renderAll();
}

function removeFromTeamByUid(uid) {
  const idx = gameState.team.findIndex(p=>p.uid===uid);
  if(idx>=0) removeFromTeam(idx);
}

function openModal() { document.getElementById('modal-overlay').classList.add('active'); }

function closeModal(event) {
  if(event && event.target !== document.getElementById('modal-overlay') && event.target !== document.getElementById('modal-close')) return;
  document.getElementById('modal-overlay').classList.remove('active');
}

// ============================================================
// TABS
// ============================================================

function switchTab(name) {
  const tabs = ['team','box','gacha','items','road'];
  document.querySelectorAll('.tab-btn').forEach((b,i)=>{
    b.classList.toggle('active', tabs[i]===name);
  });
  document.querySelectorAll('.tab-content').forEach(c=>{
    c.classList.toggle('active', c.id==='tab-'+name);
  });
  if(name==='box') renderPokemonBox();
  if(name==='items') renderItems();
  if(name==='road') renderRoadUI();
}

// ============================================================
// AUTO BATTLE TOGGLE
// ============================================================

function toggleAuto() {
  battlePaused = !battlePaused;
  document.getElementById('auto-btn').textContent = battlePaused ? '‚ñ∂ RESUME' : '‚è∏ PAUSE';
}

// ============================================================
// TOAST
// ============================================================

function toast(msg, duration=2500) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(el._timer);
  el._timer = setTimeout(()=>el.classList.remove('show'), duration);
}

// ============================================================
// INIT
// ============================================================

// ============================================================
// RELEASE POKEMON
// ============================================================

function confirmRelease(uid) {
  const pk = gameState.box.find(p=>p.uid===uid);
  if(!pk) return;
  if(gameState.box.length <= 1) { toast("Can't release your last Pok√©mon!"); return; }
  document.getElementById('modal-title').textContent = `Release ${pk.name}?`;
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:12px 0">
      <img src="${getSpriteUrl(pk.id,pk.isShiny)}" width="100" height="100" class="${pk.isShiny?'shiny-sprite':''}" onerror="this.src='${getBattleSprite(pk.id,pk.isShiny)}'">
      <div style="margin:12px 0;font-size:16px;color:var(--text2)">
        ${pk.isShiny ? '<span class="shiny-text">‚òÖ SHINY </span>' : ''}${pk.name} (Lv.${pk.level}) will be released into the wild forever.
      </div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:14px">
        <button class="btn" style="border-color:#ef5350;color:#ef5350;flex:1" onclick="releasePokemon(${uid})">Yes, release üïäÔ∏è</button>
        <button class="btn gold" style="flex:1" onclick="closeModal()">Keep ‚ù§Ô∏è</button>
      </div>
    </div>
  `;
}

function releasePokemon(uid) {
  const idx = gameState.box.findIndex(p=>p.uid===uid);
  if(idx === -1) return;
  if(gameState.box.length <= 1) { toast("Can't release your last Pok√©mon!"); return; }
  const pk = gameState.box[idx];
  // Remove from team too
  const teamIdx = gameState.team.indexOf(pk);
  if(teamIdx >= 0) {
    if(gameState.team.length <= 1 && gameState.box.length <= 1) { toast("Can't release your last Pok√©mon!"); return; }
    gameState.team.splice(teamIdx, 1);
    if(gameState.currentFighterIdx >= gameState.team.length) gameState.currentFighterIdx = Math.max(0, gameState.team.length-1);
  }
  // Return equipped item
  const equippedId = gameState.equippedItems[uid];
  if(equippedId) {
    gameState.inventory[equippedId] = (gameState.inventory[equippedId]||0)+1;
    delete gameState.equippedItems[uid];
  }
  gameState.box.splice(idx, 1);
  toast(`üïäÔ∏è ${pk.name} was released... Goodbye!`, 3000);
  closeModal();
  renderAll();
}

// ============================================================
// SAVE / LOAD  (localStorage)
// ============================================================

const SAVE_KEY = 'pkm_idle_save_v2';

function saveGame() {
  try {
    // Serialize box (strip non-serializable if any)
    const save = {
      gold: gameState.gold,
      gems: gameState.gems,
      wins: gameState.wins,
      wave: gameState.wave,
      inventory: gameState.inventory,
      equippedItems: gameState.equippedItems,
      dailyClaimed: gameState.dailyClaimed,
      lastDaily: gameState.lastDaily,
      road: gameState.road,
      pUid,
      box: gameState.box.map(p=>({
        uid:p.uid, id:p.id, name:p.name, types:p.types, level:p.level,
        isShiny:p.isShiny, currentHp:p.currentHp, exp:p.exp, expToNext:p.expToNext,
        stats:p.stats, statsLoaded:p.statsLoaded
      })),
      teamUids: gameState.team.map(p=>p.uid),
      currentFighterIdx: gameState.currentFighterIdx,
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(save));
  } catch(e) { console.warn('Save failed:', e); }
}

function loadGame() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return false;
    const save = JSON.parse(raw);
    gameState.gold = save.gold || 500;
    gameState.gems = save.gems || 15;
    gameState.wins = save.wins || 0;
    gameState.wave = save.wave || 1;
    gameState.inventory = save.inventory || {};
    gameState.equippedItems = save.equippedItems || {};
    gameState.dailyClaimed = save.dailyClaimed || false;
    gameState.lastDaily = save.lastDaily || 0;
    gameState.road = save.road || {active:false,floor:0,winsOnFloor:0,winsNeeded:20};
    pUid = save.pUid || 0;

    gameState.box = (save.box || []).map(p => ({
      ...p,
      statsLoaded: !!p.stats
    }));
    // Rebuild team refs from uids
    gameState.team = (save.teamUids || []).map(uid => gameState.box.find(p=>p.uid===uid)).filter(Boolean);
    gameState.currentFighterIdx = Math.min(save.currentFighterIdx||0, Math.max(0,gameState.team.length-1));
    return gameState.box.length > 0;
  } catch(e) {
    console.warn('Load failed:', e);
    return false;
  }
}

// Auto-save every 30 seconds
setInterval(saveGame, 30000);

function confirmWipeData() {
  document.getElementById('modal-title').textContent = '‚ö†Ô∏è Reset All Data?';
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:10px">
      <div style="font-size:40px;margin-bottom:10px">‚ö†Ô∏è</div>
      <div style="color:var(--text2);margin-bottom:16px">This will delete ALL your progress,<br>Pok√©mon, items, and save data.<br>This cannot be undone!</div>
      <div style="display:flex;gap:10px;justify-content:center">
        <button class="btn" style="border-color:#ef5350;color:#ef5350" onclick="wipeData()">Yes, reset everything</button>
        <button class="btn gold" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  `;
  openModal();
}

function wipeData() {
  localStorage.removeItem(SAVE_KEY);
  closeModal();
  location.reload();
}

// ============================================================
// TRASH ITEM
// ============================================================

function trashItem(itemId) {
  const item = ITEMS.find(i=>i.id===itemId);
  if(!item) return;
  const count = gameState.inventory[itemId] || 0;
  if(count <= 0) return;

  document.getElementById('modal-title').textContent = `üóëÔ∏è Trash ${item.name}?`;
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:10px">
      <div style="font-size:50px;margin-bottom:10px">${item.emoji}</div>
      <div style="color:var(--text2);margin-bottom:8px">${item.desc}</div>
      <div style="margin-bottom:14px">You have √ó${count}. How many to trash?</div>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button class="btn" style="border-color:#ef5350;color:#ef5350" onclick="doTrashItem('${itemId}',1)">Trash √ó1</button>
        ${count>1?`<button class="btn" style="border-color:#ef5350;color:#ef5350" onclick="doTrashItem('${itemId}',${count})">Trash all √ó${count}</button>`:''}
        <button class="btn gold" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  `;
  openModal();
}

function doTrashItem(itemId, amount) {
  const item = ITEMS.find(i=>i.id===itemId);
  gameState.inventory[itemId] = Math.max(0, (gameState.inventory[itemId]||0) - amount);
  toast(`üóëÔ∏è Trashed √ó${amount} ${item?.name}`);
  closeModal();
  renderItems();
}

// ============================================================
// DIAMOND ROAD
// ============================================================

const ROAD_FLOORS = [
  {name:'Stardust Path',    minFloor:0,  scaleMult:0.8,  winsNeeded:30,  gemsPerWin:0,  gemsPerTen:1,  bonusGems:3},
  {name:'Nebula Trail',     minFloor:1,  scaleMult:1.0,  winsNeeded:50,  gemsPerWin:0,  gemsPerTen:1,  bonusGems:5},
  {name:'Cosmic Corridor',  minFloor:2,  scaleMult:1.3,  winsNeeded:75,  gemsPerWin:0,  gemsPerFive:1, bonusGems:8},
  {name:'Void Passage',     minFloor:3,  scaleMult:1.6,  winsNeeded:100, gemsPerWin:0,  gemsPerFive:1, bonusGems:12},
  {name:'Astral Summit',    minFloor:4,  scaleMult:2.0,  winsNeeded:150, gemsPerWin:0,  gemsPerThree:1,bonusGems:20},
  {name:'Celestial Apex',   minFloor:5,  scaleMult:3.0,  winsNeeded:200, gemsPerWin:0,  gemsPerThree:1,bonusGems:35},
];

let roadBattleActive = false;
let roadEnemy = null;
let roadPlayerCooldown = 0;
let roadEnemyCooldown = 0;
let roadTimer = null;

function getAvgTeamLevel() {
  if(gameState.team.length === 0) return 5;
  return Math.floor(gameState.team.reduce((s,p)=>s+p.level,0)/gameState.team.length);
}

function renderRoadUI() {
  const el = document.getElementById('road-ui');
  const avgLvl = getAvgTeamLevel();
  const road = gameState.road;

  let html = `
    <div class="road-header">üíé DIAMOND ROAD üíé</div>
    <div style="font-size:13px;color:var(--text2);text-align:center;margin-bottom:10px">
      Your avg level: <span style="color:var(--gold)">Lv.${avgLvl}</span><br>
      <span style="color:var(--text2)">Enemies scale to your team. Gems earned slowly ‚Äî it's a grind.</span>
    </div>
  `;

  if(road.active) {
    const floor = ROAD_FLOORS[road.floor];
    const pct = Math.floor((road.winsOnFloor / floor.winsNeeded)*100);
    const nextGemIn = floor.gemsPerThree ? `üíé every 3 wins` : floor.gemsPerFive ? `üíé every 5 wins` : `üíé every 10 wins`;
    html += `
      <div class="road-floor-card active-floor">
        <div class="road-floor-title">‚ñ∂ ${floor.name}</div>
        <div class="road-floor-lvl">Enemy Lv.~${Math.floor(avgLvl*floor.scaleMult)}</div>
        <div class="road-floor-reward">${nextGemIn} ‚Ä¢ ${floor.bonusGems} üíé on clear</div>
        <div class="road-progress-bar"><div class="road-progress-fill" style="width:${pct}%"></div></div>
        <div style="font-size:13px;color:var(--text2);margin-top:3px">${road.winsOnFloor}/${floor.winsNeeded} wins</div>
      </div>
      <button class="btn" style="width:100%;border-color:#ef5350;color:#ef5350;margin-bottom:8px" onclick="exitRoad()">üö™ Exit Road</button>
    `;
  } else {
    html += `<div style="font-size:13px;color:var(--text2);margin-bottom:8px;text-align:center">Grind for üíé Gems.<br>Enemies scale to your team level.</div>`;
    ROAD_FLOORS.forEach((floor, idx) => {
      const enemyLvl = Math.floor(avgLvl * floor.scaleMult);
      const rate = floor.gemsPerThree ? '1üíé/3 wins' : floor.gemsPerFive ? '1üíé/5 wins' : '1üíé/10 wins';
      html += `
        <div class="road-floor-card" onclick="enterRoad(${idx})">
          <div class="road-floor-title">${floor.name}</div>
          <div class="road-floor-lvl">Enemy Lv.~${enemyLvl} ¬∑ ${floor.winsNeeded} wins to clear</div>
          <div class="road-floor-reward">${rate} ¬∑ ${floor.bonusGems}üíé bonus on clear</div>
        </div>
      `;
    });
  }

  el.innerHTML = html;
}

function enterRoad(floorIdx) {
  const avgLvl = getAvgTeamLevel();
  gameState.road.active = true;
  gameState.road.floor = floorIdx;
  gameState.road.winsOnFloor = 0;
  gameState.road.winsNeeded = ROAD_FLOORS[floorIdx].winsNeeded;

  // Switch arena to road mode
  document.getElementById('arena').classList.add('road-mode');
  addLog(`üíé Entered ${ROAD_FLOORS[floorIdx].name}!`, 'log-evolve');
  toast(`üíé Diamond Road: ${ROAD_FLOORS[floorIdx].name}!`, 3000);

  // Spawn road enemy
  spawnRoadEnemy();
  renderRoadUI();
  switchTab('team'); // switch back to team view to see battle
}

function exitRoad() {
  gameState.road.active = false;
  document.getElementById('arena').classList.remove('road-mode');
  addLog('Returned to normal battles.', 'log-heal');
  toast('Returned to normal battles.');
  // Spawn normal enemy
  currentEnemy = null;
  setTimeout(spawnEnemy, 800);
  renderRoadUI();
  switchTab('team');
}

async function spawnRoadEnemy() {
  if(!gameState.road.active) return;
  const floor = ROAD_FLOORS[gameState.road.floor];
  const avgLvl = getAvgTeamLevel();

  // Pick from all gacha pool
  const pool = GACHA_POOL;
  const chosen = pool[Math.floor(Math.random()*pool.length)];
  const isShiny = Math.random() < 1/512;

  const lvl = Math.max(1, Math.floor(avgLvl * floor.scaleMult + (Math.random()-0.5)*4));
  const enemy = newPokemonEntry(chosen.id, chosen.name, chosen.types, lvl, isShiny);
  enemy.stats = await fetchPokemonStats(chosen.id);
  enemy.statsLoaded = true;
  enemy.currentHp = getMaxHp(enemy);
  currentEnemy = enemy;

  const flash = document.getElementById('encounter-flash');
  flash.style.transition = 'opacity 0.05s';
  flash.style.opacity = '0.8';
  setTimeout(()=>{ flash.style.transition = 'opacity 1.2s'; flash.style.opacity = '0'; }, 120);

  updateEnemyUI();
  if(isShiny) {
    addLog(`‚ú® Road SHINY ${chosen.name} appeared! (Lv.${lvl})`, 'log-shiny');
  } else {
    addLog(`üíé Road enemy: ${chosen.name} (Lv.${lvl}) appeared!`);
  }
}

initStarterScreen();
</script>
</body>
</html>
