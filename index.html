<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pok√©mon Idle Fighter</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323:wght@400&display=swap');

:root {
  --bg: #0a0a1a;
  --bg2: #111128;
  --panel: #1a1a35;
  --border: #3a3a6a;
  --accent: #4fc3f7;
  --gold: #ffd700;
  --red: #ef5350;
  --green: #66bb6a;
  --purple: #ab47bc;
  --shiny: #ff69b4;
  --cosmic: #00ffff;
  --text: #e0e0ff;
  --text2: #8888bb;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'VT323', monospace;
  font-size: 18px;
  overflow: hidden;
  height: 100vh;
  width: 100vw;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: 
    radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,0.4) 0%, transparent 100%),
    radial-gradient(1px 1px at 30% 70%, rgba(255,255,255,0.3) 0%, transparent 100%),
    radial-gradient(1px 1px at 60% 10%, rgba(255,255,255,0.4) 0%, transparent 100%),
    radial-gradient(1px 1px at 80% 50%, rgba(255,255,255,0.3) 0%, transparent 100%),
    radial-gradient(1px 1px at 50% 90%, rgba(255,255,255,0.2) 0%, transparent 100%);
  pointer-events: none;
  z-index: 0;
}

/* STARTER SCREEN */
#starter-screen {
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2e 50%, #0a1a1a 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

#starter-screen h1 {
  font-family: 'Press Start 2P', monospace;
  font-size: 22px;
  color: var(--gold);
  text-shadow: 0 0 20px rgba(255,215,0,0.7), 0 0 40px rgba(255,215,0,0.3);
  margin-bottom: 10px;
  animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
  from { text-shadow: 0 0 20px rgba(255,215,0,0.7), 0 0 40px rgba(255,215,0,0.3); }
  to { text-shadow: 0 0 30px rgba(255,215,0,1), 0 0 60px rgba(255,215,0,0.5), 0 0 80px rgba(255,100,0,0.3); }
}

#starter-screen p { color: var(--text2); margin-bottom: 40px; font-size: 20px; }

.starter-grid { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; }

.starter-card {
  background: var(--panel);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
  width: 160px;
}

.starter-card:hover {
  border-color: var(--accent);
  transform: translateY(-8px) scale(1.05);
  box-shadow: 0 10px 30px rgba(79,195,247,0.3);
}

.starter-card img { width: 96px; height: 96px; image-rendering: pixelated; }
.starter-card .name { font-family: 'Press Start 2P', monospace; font-size: 9px; color: var(--gold); margin-top: 10px; }
.starter-card .types { display: flex; gap: 4px; justify-content: center; margin-top: 6px; }

/* MAIN GAME */
#game { display: none; height: 100vh; width: 100vw; flex-direction: column; position: relative; z-index: 1; }

/* TOP BAR */
#topbar {
  background: var(--panel);
  border-bottom: 2px solid var(--border);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 20px;
  height: 50px;
  flex-shrink: 0;
}

#topbar h2 { font-family: 'Press Start 2P', monospace; font-size: 10px; color: var(--gold); }

.resource {
  display: flex;
  align-items: center;
  gap: 6px;
  background: rgba(255,255,255,0.05);
  padding: 4px 12px;
  border-radius: 20px;
  border: 1px solid var(--border);
  font-size: 16px;
}

.resource .icon { font-size: 18px; }
.resource .val { color: var(--gold); font-weight: bold; }

/* MAIN LAYOUT */
#main-layout { display: flex; flex: 1; overflow: hidden; }

/* BATTLE ARENA */
#arena {
  flex: 1;
  position: relative;
  background: linear-gradient(180deg, #0d1b3e 0%, #1a2a50 40%, #2d4a30 40%, #1a3020 100%);
  overflow: hidden;
  min-width: 0;
}

#arena::before {
  content: '';
  position: absolute;
  top: 60px;
  left: -100px;
  width: 200px;
  height: 60px;
  background: rgba(255,255,255,0.06);
  border-radius: 50%;
  box-shadow: 300px 20px 0 rgba(255,255,255,0.04), 600px -10px 0 rgba(255,255,255,0.05);
  animation: clouds 30s linear infinite;
}

@keyframes clouds { to { transform: translateX(1200px); } }

#arena::after {
  content: '';
  position: absolute;
  bottom: 120px;
  left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent, rgba(100,200,100,0.3), transparent);
}

.fighter-area { position: absolute; display: flex; flex-direction: column; align-items: center; }
#player-area { left: 40px; bottom: 135px; }
#enemy-area { right: 40px; bottom: 260px; }

.fighter-sprite { width: 450px; height: 450px; image-rendering: pixelated; position: relative; }
#player-area .fighter-sprite { transform: scaleX(-1); }

.fighter-sprite.attack-anim { animation: attack 0.5s cubic-bezier(0.25,0.46,0.45,0.94); }
@keyframes attack {
  0%   { transform: scaleX(-1) translate(0px, 0px) rotate(0deg); }
  20%  { transform: scaleX(-1) translate(30px, -25px) rotate(-5deg); }
  45%  { transform: scaleX(-1) translate(190px, 0px) rotate(3deg); }
  70%  { transform: scaleX(-1) translate(80px, -10px) rotate(-2deg); }
  100% { transform: scaleX(-1) translate(0px, 0px) rotate(0deg); }
}

#enemy-area .fighter-sprite.attack-anim { animation: enemy-attack 0.5s cubic-bezier(0.25,0.46,0.45,0.94); }
@keyframes enemy-attack {
  0%   { transform: translate(0px, 0px) rotate(0deg); }
  20%  { transform: translate(-30px, -25px) rotate(5deg); }
  45%  { transform: translate(-190px, 0px) rotate(-3deg); }
  70%  { transform: translate(-80px, -10px) rotate(2deg); }
  100% { transform: translate(0px, 0px) rotate(0deg); }
}

.fighter-sprite.hurt-anim { animation: hurt 0.45s ease-out; }
@keyframes hurt {
  0%   { filter: brightness(1); transform: translateX(0); }
  15%  { filter: brightness(4) sepia(1) hue-rotate(300deg); transform: translateX(-12px); }
  30%  { filter: brightness(1); transform: translateX(10px); }
  50%  { filter: brightness(3) sepia(1) hue-rotate(300deg); transform: translateX(-8px); }
  70%  { filter: brightness(1); transform: translateX(6px); }
  100% { filter: brightness(1); transform: translateX(0); }
}

.fighter-sprite.shiny-sprite.hurt-anim { animation: hurt-shiny 0.45s ease-out; }
@keyframes hurt-shiny {
  0%   { filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)) drop-shadow(0 0 16px rgba(255,100,200,0.6)); transform: translateX(0); }
  15%  { filter: brightness(4) sepia(1) hue-rotate(300deg); transform: translateX(-12px); }
  30%  { filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)) drop-shadow(0 0 16px rgba(255,100,200,0.6)); transform: translateX(10px); }
  50%  { filter: brightness(3) sepia(1) hue-rotate(300deg); transform: translateX(-8px); }
  70%  { filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)) drop-shadow(0 0 16px rgba(255,100,200,0.6)); transform: translateX(6px); }
  100% { filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)) drop-shadow(0 0 16px rgba(255,100,200,0.6)); transform: translateX(0); }
}

/* COSMIC shiny hurt */
.fighter-sprite.cosmic-sprite.hurt-anim { animation: hurt-cosmic 0.45s ease-out; }
@keyframes hurt-cosmic {
  0%   { filter: drop-shadow(0 0 12px #00ffff) drop-shadow(0 0 24px #bf00ff) drop-shadow(0 0 40px rgba(0,255,255,0.5)); transform: translateX(0); }
  15%  { filter: brightness(5) sepia(1) hue-rotate(180deg); transform: translateX(-12px); }
  30%  { filter: drop-shadow(0 0 12px #00ffff) drop-shadow(0 0 24px #bf00ff); transform: translateX(10px); }
  50%  { filter: brightness(4) sepia(1) hue-rotate(180deg); transform: translateX(-8px); }
  70%  { filter: drop-shadow(0 0 12px #00ffff) drop-shadow(0 0 24px #bf00ff); transform: translateX(6px); }
  100% { filter: drop-shadow(0 0 12px #00ffff) drop-shadow(0 0 24px #bf00ff) drop-shadow(0 0 40px rgba(0,255,255,0.5)); transform: translateX(0); }
}

#player-area .fighter-sprite.hurt-anim { animation: hurt-player 0.45s ease-out; }
@keyframes hurt-player {
  0%   { filter: brightness(1); transform: scaleX(-1) translateX(0); }
  15%  { filter: brightness(4) sepia(1) hue-rotate(300deg); transform: scaleX(-1) translateX(-12px); }
  30%  { filter: brightness(1); transform: scaleX(-1) translateX(10px); }
  50%  { filter: brightness(3) sepia(1) hue-rotate(300deg); transform: scaleX(-1) translateX(-8px); }
  70%  { filter: brightness(1); transform: scaleX(-1) translateX(6px); }
  100% { filter: brightness(1); transform: scaleX(-1) translateX(0); }
}

#player-area .fighter-sprite.shiny-sprite.hurt-anim { animation: hurt-player-shiny 0.45s ease-out; }
@keyframes hurt-player-shiny {
  0%   { filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)) drop-shadow(0 0 16px rgba(255,100,200,0.6)); transform: scaleX(-1) translateX(0); }
  15%  { filter: brightness(4) sepia(1) hue-rotate(300deg); transform: scaleX(-1) translateX(-12px); }
  30%  { filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)) drop-shadow(0 0 16px rgba(255,100,200,0.6)); transform: scaleX(-1) translateX(10px); }
  50%  { filter: brightness(3) sepia(1) hue-rotate(300deg); transform: scaleX(-1) translateX(-8px); }
  70%  { filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)) drop-shadow(0 0 16px rgba(255,100,200,0.6)); transform: scaleX(-1) translateX(6px); }
  100% { filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)) drop-shadow(0 0 16px rgba(255,100,200,0.6)); transform: scaleX(-1) translateX(0); }
}

/* COSMIC player hurt */
#player-area .fighter-sprite.cosmic-sprite.hurt-anim { animation: hurt-player-cosmic 0.45s ease-out; }
@keyframes hurt-player-cosmic {
  0%   { filter: drop-shadow(0 0 12px #00ffff) drop-shadow(0 0 24px #bf00ff); transform: scaleX(-1) translateX(0); }
  15%  { filter: brightness(5) sepia(1) hue-rotate(180deg); transform: scaleX(-1) translateX(-12px); }
  30%  { filter: drop-shadow(0 0 12px #00ffff) drop-shadow(0 0 24px #bf00ff); transform: scaleX(-1) translateX(10px); }
  50%  { filter: brightness(4) sepia(1) hue-rotate(180deg); transform: scaleX(-1) translateX(-8px); }
  70%  { filter: drop-shadow(0 0 12px #00ffff) drop-shadow(0 0 24px #bf00ff); transform: scaleX(-1) translateX(6px); }
  100% { filter: drop-shadow(0 0 12px #00ffff) drop-shadow(0 0 24px #bf00ff); transform: scaleX(-1) translateX(0); }
}

.shiny-sprite {
  filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)) drop-shadow(0 0 16px rgba(255,100,200,0.6));
  animation: shiny-pulse 2s ease-in-out infinite alternate;
}
@keyframes shiny-pulse {
  from { filter: drop-shadow(0 0 8px rgba(255,215,0,0.8)) drop-shadow(0 0 16px rgba(255,100,200,0.6)); }
  to { filter: drop-shadow(0 0 16px rgba(255,215,0,1)) drop-shadow(0 0 30px rgba(0,200,255,0.8)) brightness(1.2); }
}

/* COSMIC SHINY styles */
.cosmic-sprite {
  filter: drop-shadow(0 0 12px #00ffff) drop-shadow(0 0 24px #bf00ff) drop-shadow(0 0 40px rgba(0,255,255,0.4));
  animation: cosmic-pulse 2s ease-in-out infinite alternate;
}
@keyframes cosmic-pulse {
  0%  { filter: drop-shadow(0 0 12px #00ffff) drop-shadow(0 0 24px #bf00ff) drop-shadow(0 0 40px rgba(0,255,255,0.4)); }
  33% { filter: drop-shadow(0 0 16px #bf00ff) drop-shadow(0 0 32px #00ffff) drop-shadow(0 0 50px rgba(191,0,255,0.5)) brightness(1.15); }
  66% { filter: drop-shadow(0 0 20px #ff00aa) drop-shadow(0 0 36px #00ffff) drop-shadow(0 0 55px rgba(255,0,170,0.4)) brightness(1.25); }
  100%{ filter: drop-shadow(0 0 24px #00ffff) drop-shadow(0 0 40px #bf00ff) drop-shadow(0 0 60px rgba(0,255,255,0.6)) brightness(1.3); }
}

.cosmic-badge {
  position: absolute;
  top: -2px;
  right: -2px;
  font-size: 11px;
  background: linear-gradient(135deg, #00ffff, #bf00ff, #ff00aa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: shimmer 1.5s linear infinite;
  background-size: 200%;
}

.cosmic-slot {
  background: linear-gradient(135deg, rgba(0,255,255,0.12), rgba(191,0,255,0.12)) !important;
  animation: cosmic-border 2s linear infinite !important;
}

@keyframes cosmic-border {
  0%   { border-color: #00ffff; box-shadow: 0 0 14px rgba(0,255,255,0.6); }
  25%  { border-color: #bf00ff; box-shadow: 0 0 14px rgba(191,0,255,0.6); }
  50%  { border-color: #ff00aa; box-shadow: 0 0 14px rgba(255,0,170,0.6); }
  75%  { border-color: #00ffff; box-shadow: 0 0 14px rgba(0,255,255,0.6); }
  100% { border-color: #bf00ff; box-shadow: 0 0 14px rgba(191,0,255,0.6); }
}

.cosmic-text {
  font-family: 'Press Start 2P', monospace;
  background: linear-gradient(90deg, #00ffff, #bf00ff, #ff00aa, #00ffff);
  background-size: 300%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: shimmer 1.5s linear infinite;
  display: inline-block;
}

.info-box {
  background: rgba(0,0,0,0.75);
  border: 2px solid var(--border);
  border-radius: 8px;
  padding: 8px 12px;
  min-width: 180px;
  backdrop-filter: blur(4px);
}

.info-box .pname { font-family: 'Press Start 2P', monospace; font-size: 8px; color: var(--gold); }
.info-box .plevel { font-size: 14px; color: var(--text2); }
.bar-wrap { margin-top: 4px; }
.bar-label { font-size: 13px; color: var(--text2); }
.bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin-top: 2px; }
.bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
.hp-fill { background: linear-gradient(90deg, #ef5350, #ff7043); }
.exp-fill { background: linear-gradient(90deg, #7e57c2, #ab47bc); }

#battle-log {
  position: absolute;
  bottom: 10px;
  left: 10px;
  right: 10px;
  background: rgba(0,0,0,0.8);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px;
  height: 100px;
  overflow-y: auto;
  font-size: 14px;
}

#battle-log::-webkit-scrollbar { width: 4px; }
#battle-log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.log-entry { padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; } }

.log-dmg { color: var(--red); }
.log-heal { color: var(--green); }
.log-exp { color: var(--purple); }
.log-evolve { color: var(--gold); font-weight: bold; }
.log-shiny { color: var(--shiny); }
.log-cosmic { color: var(--cosmic); font-weight: bold; }

.dmg-num {
  position: absolute;
  font-family: 'Press Start 2P', monospace;
  font-size: 14px;
  font-weight: bold;
  pointer-events: none;
  animation: floatUp 1.2s ease-out forwards;
  z-index: 10;
}
@keyframes floatUp {
  0% { opacity: 1; transform: translateY(0) scale(1); }
  50% { transform: translateY(-40px) scale(1.2); }
  100% { opacity: 0; transform: translateY(-70px) scale(0.8); }
}

/* RIGHT PANEL */
#right-panel {
  width: 340px;
  background: var(--panel);
  border-left: 2px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
}

.panel-tabs { display: flex; border-bottom: 2px solid var(--border); }

.tab-btn {
  flex: 1;
  background: none;
  border: none;
  color: var(--text2);
  cursor: pointer;
  padding: 10px 4px;
  font-family: 'VT323', monospace;
  font-size: 15px;
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
}

.tab-btn.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
  background: rgba(79,195,247,0.08);
}

.tab-content { flex: 1; overflow-y: auto; padding: 12px; display: none; }
.tab-content.active { display: block; }
.tab-content::-webkit-scrollbar { width: 4px; }
.tab-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* TEAM SLOTS */
.team-slots { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }

.team-slot {
  background: rgba(255,255,255,0.04);
  border: 2px solid var(--border);
  border-radius: 8px;
  padding: 8px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  min-height: 90px;
  text-align: center;
}

.team-slot.active-fighter { border-color: var(--accent); box-shadow: 0 0 12px rgba(79,195,247,0.3); }
.team-slot:hover { border-color: var(--text2); }

.team-slot.shiny-slot {
  background: linear-gradient(135deg, rgba(255,105,180,0.1), rgba(0,200,255,0.1));
  border-color: var(--shiny);
  animation: rainbow-border 3s linear infinite;
}

@keyframes rainbow-border {
  0% { border-color: #ff69b4; box-shadow: 0 0 10px rgba(255,105,180,0.5); }
  25% { border-color: #4fc3f7; box-shadow: 0 0 10px rgba(79,195,247,0.5); }
  50% { border-color: #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.5); }
  75% { border-color: #ab47bc; box-shadow: 0 0 10px rgba(171,71,188,0.5); }
  100% { border-color: #ff69b4; box-shadow: 0 0 10px rgba(255,105,180,0.5); }
}

.team-slot img { width: 52px; height: 52px; image-rendering: pixelated; }
.team-slot .slot-name { font-family: 'Press Start 2P', monospace; font-size: 6px; color: var(--gold); display: block; margin-top: 2px; }
.team-slot .slot-level { font-size: 13px; color: var(--text2); }
.team-slot .shiny-badge { position: absolute; top: 4px; right: 4px; font-size: 14px; }
.empty-slot { display: flex; align-items: center; justify-content: center; color: var(--border); font-size: 26px; }

/* Gacha */
.gacha-section { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin-bottom: 12px; }
.gacha-section h3 { font-family: 'Press Start 2P', monospace; font-size: 8px; color: var(--gold); margin-bottom: 10px; text-align: center; }

.gacha-btns { display: flex; gap: 8px; flex-wrap: wrap; }

.btn {
  background: linear-gradient(135deg, var(--panel), rgba(255,255,255,0.05));
  border: 2px solid var(--border);
  color: var(--text);
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'VT323', monospace;
  font-size: 16px;
  transition: all 0.2s;
  flex: 1;
}

.btn:hover {
  border-color: var(--accent);
  color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(79,195,247,0.2);
}

.btn.gold { background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,165,0,0.1)); border-color: var(--gold); color: var(--gold); }
.btn.gold:hover { box-shadow: 0 4px 12px rgba(255,215,0,0.3); transform: translateY(-2px); }
.btn.disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

/* BOX / POKEMON LIST */
.poke-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

.poke-card {
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  position: relative;
}

.poke-card:hover { border-color: var(--accent); transform: translateY(-2px); }

.poke-card.shiny-card {
  background: linear-gradient(135deg, rgba(255,105,180,0.08), rgba(0,200,255,0.08));
  animation: rainbow-border 3s linear infinite;
}

.poke-card.cosmic-card {
  background: linear-gradient(135deg, rgba(0,255,255,0.1), rgba(191,0,255,0.1), rgba(255,0,170,0.08));
  animation: cosmic-border 2s linear infinite;
}

.poke-card img { width: 56px; height: 56px; image-rendering: pixelated; }
.poke-card .cname { font-family: 'Press Start 2P', monospace; font-size: 6px; color: var(--gold); display: block; margin-top: 2px; }
.poke-card .clevel { font-size: 13px; color: var(--text2); }

/* ITEMS */
.item-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }

.item-cell {
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: 6px;
  width: 60px;
  height: 60px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 26px;
  position: relative;
}

.item-cell:hover { border-color: var(--accent); transform: scale(1.08); }
.item-cell .item-count { position: absolute; bottom: 2px; right: 4px; font-size: 12px; color: var(--gold); }

/* MODAL */
#modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  z-index: 500;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}

#modal-overlay.active { display: flex; }

#modal-box {
  background: var(--panel);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  max-width: 480px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
}

#modal-box::-webkit-scrollbar { width: 4px; }
#modal-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

#modal-close { position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--text2); font-size: 22px; cursor: pointer; }
#modal-title { font-family: 'Press Start 2P', monospace; font-size: 11px; color: var(--gold); margin-bottom: 16px; }

.type-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; text-transform: uppercase; }

.gacha-result { display: flex; flex-direction: column; align-items: center; gap: 12px; }
.gacha-result img { image-rendering: pixelated; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popIn {
  0% { transform: scale(0) rotate(-10deg); opacity: 0; }
  100% { transform: scale(1) rotate(0); opacity: 1; }
}

.gacha-result.is-shiny img { filter: drop-shadow(0 0 16px rgba(255,215,0,1)) drop-shadow(0 0 32px rgba(255,100,200,0.8)); animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), shiny-pulse 2s 0.5s ease-in-out infinite alternate; }
.gacha-result.is-cosmic img { filter: drop-shadow(0 0 16px #00ffff) drop-shadow(0 0 32px #bf00ff) drop-shadow(0 0 48px rgba(0,255,255,0.5)); animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), cosmic-pulse 2s 0.5s ease-in-out infinite alternate; }

.shiny-text {
  font-family: 'Press Start 2P', monospace;
  font-size: 12px;
  background: linear-gradient(90deg, #ff69b4, #ffd700, #4fc3f7, #ab47bc, #ff69b4);
  background-size: 200%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: shimmer 2s linear infinite;
}

@keyframes shimmer { to { background-position: 200% center; } }

.ss-rainbow {
  font-family: 'Press Start 2P', monospace;
  background: linear-gradient(90deg, #ff69b4, #ffd700, #4fc3f7, #ab47bc, #ff69b4);
  background-size: 200%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: shimmer 2s linear infinite;
  text-shadow: none;
  display: inline-block;
  line-height: 1.4;
  padding-top: 2px;
}

.stat-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.stat-name { width: 60px; font-size: 14px; color: var(--text2); flex-shrink: 0; }
.stat-bar-bg { flex: 1; height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden; }
.stat-bar-fill { height: 100%; border-radius: 5px; background: linear-gradient(90deg, var(--accent), var(--purple)); transition: width 0.5s ease; }
.stat-val { width: 40px; text-align: right; font-size: 15px; color: var(--gold); }

.evolve-flash { animation: evolveFlash 1s ease-out; }
@keyframes evolveFlash {
  0% { filter: brightness(1); }
  25% { filter: brightness(5) blur(4px); }
  50% { filter: brightness(1); }
  75% { filter: brightness(5) blur(4px); }
  100% { filter: brightness(1); }
}

/* Bottom team bar */
#bottom-bar {
  background: var(--panel);
  border-top: 2px solid var(--border);
  padding: 8px 16px;
  display: flex;
  gap: 10px;
  height: 90px;
  flex-shrink: 0;
  align-items: center;
}

.bottom-slot {
  width: 70px;
  height: 70px;
  background: rgba(255,255,255,0.04);
  border: 2px solid var(--border);
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  flex-shrink: 0;
}

.bottom-slot:hover { border-color: var(--accent); }
.bottom-slot.active-slot { border-color: var(--accent); box-shadow: 0 0 12px rgba(79,195,247,0.4); }
.bottom-slot.shiny-slot-b { animation: rainbow-border 3s linear infinite; }
.bottom-slot.cosmic-slot-b { animation: cosmic-border 2s linear infinite; }

.bottom-slot img { width: 44px; height: 44px; image-rendering: pixelated; }
.bottom-slot .b-name { font-family: 'Press Start 2P', monospace; font-size: 5px; color: var(--gold); }
.bottom-slot .b-hp-bar { position: absolute; bottom: 3px; left: 4px; right: 4px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
.b-hp-fill { height: 100%; background: var(--green); transition: width 0.4s; }
.bottom-slot .b-shiny { position: absolute; top: 2px; right: 3px; font-size: 11px; }

#wild-indicator {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 4px 16px;
  font-size: 14px;
  color: var(--text2);
  display: flex;
  gap: 12px;
  align-items: center;
}

.region-badge { background: rgba(255,215,0,0.15); border: 1px solid var(--gold); border-radius: 12px; padding: 2px 10px; color: var(--gold); font-size: 13px; }

#encounter-flash { position: absolute; inset: 0; background: radial-gradient(ellipse at center, rgba(150,200,255,0.5) 0%, rgba(80,120,200,0.2) 100%); opacity: 0; pointer-events: none; z-index: 50; }

#toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--panel);
  border: 2px solid var(--accent);
  border-radius: 8px;
  padding: 10px 20px;
  font-size: 16px;
  opacity: 0;
  transition: all 0.4s;
  z-index: 999;
  pointer-events: none;
  max-width: 400px;
  text-align: center;
}

#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

.victory-road-card {
  background: linear-gradient(135deg, rgba(80,40,0,0.7), rgba(40,20,0,0.5));
  border: 1px solid #8b6914;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}
.victory-road-card::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at 50% 0%, rgba(255,200,50,0.1), transparent 70%); pointer-events: none; }
.victory-road-card:hover { border-color: #ffd700; transform: translateY(-2px); box-shadow: 0 4px 20px rgba(255,180,0,0.3); }
.vr-title { font-family: 'Press Start 2P', monospace; font-size: 7px; color: #ffd700; margin-bottom: 4px; }
.vr-subtitle { font-size: 12px; color: #ffb74d; margin-bottom: 3px; }
.vr-reward { font-size: 12px; color: #a5d6a7; }

#capture-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 600; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
#capture-overlay.active { display: flex; }
.capture-box { background: var(--panel); border: 2px solid var(--gold); border-radius: 12px; padding: 24px; max-width: 360px; width: 90%; text-align: center; }

@keyframes pokeball-throw {
  0% { transform: translateY(0) rotate(0); }
  40% { transform: translateY(-40px) rotate(360deg); }
  70% { transform: translateY(10px) rotate(700deg) scale(0.8); }
  100% { transform: translateY(0) rotate(720deg) scale(1); }
}

.pokeball-anim { display: inline-block; font-size: 50px; animation: pokeball-throw 1s ease-out forwards; }

.road-header { font-family: 'Press Start 2P', monospace; font-size: 9px; color: #b388ff; text-align: center; margin-bottom: 6px; text-shadow: 0 0 12px rgba(179,136,255,0.6); display: block; width: 100%; }

.road-floor-card {
  background: linear-gradient(135deg, rgba(30,0,60,0.9), rgba(10,0,40,0.9));
  border: 1px solid #5c35a0;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.road-floor-card::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at 50% 0%, rgba(179,136,255,0.1), transparent 70%); pointer-events: none; }
.road-floor-card:hover { border-color: #9c64f5; transform: translateY(-2px); box-shadow: 0 4px 20px rgba(140,80,255,0.3); }
.road-floor-card.active-floor { border-color: #b388ff; box-shadow: 0 0 20px rgba(179,136,255,0.5); }
.road-floor-title { font-family: 'Press Start 2P', monospace; font-size: 7px; color: #b388ff; margin-bottom: 4px; }
.road-floor-lvl { font-size: 13px; color: var(--text2); margin-bottom: 4px; }
.road-floor-reward { font-size: 13px; color: #ffd700; }

.road-progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 5px; }
.road-progress-fill { height: 100%; background: linear-gradient(90deg, #7b1fa2, #e040fb); transition: width 0.5s; }

#arena.road-mode {
  background: 
    radial-gradient(ellipse at 20% 50%, rgba(80,0,180,0.4) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 50%, rgba(0,80,180,0.4) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 100%, rgba(140,0,255,0.3) 0%, transparent 40%),
    linear-gradient(180deg, #000005 0%, #020010 40%, #050020 100%);
}

#arena.road-mode::after {
  content: '';
  position: absolute;
  inset: 0;
  background-image: 
    radial-gradient(1px 1px at 5% 10%, white 0%, transparent 100%),
    radial-gradient(1px 1px at 15% 30%, rgba(200,150,255,0.8) 0%, transparent 100%),
    radial-gradient(2px 2px at 25% 60%, white 0%, transparent 100%),
    radial-gradient(1px 1px at 35% 20%, rgba(150,200,255,0.8) 0%, transparent 100%),
    radial-gradient(1px 1px at 45% 80%, white 0%, transparent 100%),
    radial-gradient(2px 2px at 55% 40%, rgba(255,200,150,0.8) 0%, transparent 100%),
    radial-gradient(1px 1px at 65% 70%, white 0%, transparent 100%),
    radial-gradient(1px 1px at 75% 15%, rgba(200,255,150,0.8) 0%, transparent 100%),
    radial-gradient(2px 2px at 85% 55%, white 0%, transparent 100%),
    radial-gradient(1px 1px at 92% 35%, rgba(255,150,200,0.8) 0%, transparent 100%);
  animation: twinkle 4s ease-in-out infinite alternate;
  pointer-events: none;
  z-index: 0;
}

@keyframes twinkle { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

/* REDEEM MODAL */
#redeem-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 800;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(6px);
}
#redeem-overlay.active { display: flex; }

.redeem-box {
  background: linear-gradient(135deg, #0d0d25, #1a0a2e);
  border: 2px solid var(--gold);
  border-radius: 16px;
  padding: 28px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 40px rgba(255,215,0,0.2), 0 0 80px rgba(255,215,0,0.08);
  animation: redeemPop 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
}

@keyframes redeemPop {
  0% { transform: scale(0.7) translateY(40px); opacity: 0; }
  100% { transform: scale(1) translateY(0); opacity: 1; }
}

.redeem-title {
  font-family: 'Press Start 2P', monospace;
  font-size: 12px;
  color: var(--gold);
  text-shadow: 0 0 20px rgba(255,215,0,0.8);
  margin-bottom: 6px;
  animation: glow 2s ease-in-out infinite alternate;
}

.redeem-subtitle { font-size: 14px; color: var(--text2); margin-bottom: 20px; }

#redeem-input {
  width: 100%;
  background: rgba(0,0,0,0.5);
  border: 2px solid var(--border);
  border-radius: 10px;
  color: var(--gold);
  font-family: 'Press Start 2P', monospace;
  font-size: 12px;
  padding: 12px 16px;
  text-align: center;
  letter-spacing: 3px;
  text-transform: uppercase;
  outline: none;
  transition: border-color 0.2s;
  margin-bottom: 12px;
}

#redeem-input:focus { border-color: var(--gold); box-shadow: 0 0 16px rgba(255,215,0,0.3); }
#redeem-input::placeholder { color: rgba(255,215,0,0.3); letter-spacing: 1px; font-size: 10px; }

#redeem-result {
  min-height: 24px;
  font-size: 15px;
  margin-bottom: 12px;
  transition: all 0.3s;
}

.redeem-btn-row { display: flex; gap: 10px; justify-content: center; }

@media (max-width: 900px) { #right-panel { width: 280px; } }

/* MULTI-SAVE OVERLAY */
#saves-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  z-index: 900;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(6px);
}
#saves-overlay.active { display: flex; }
.saves-box {
  background: linear-gradient(135deg, #0d0d25, #1a0a2e);
  border: 2px solid var(--accent);
  border-radius: 16px;
  padding: 24px;
  max-width: 540px;
  width: 95%;
  max-height: 90vh;
  overflow-y: auto;
}
.save-slot-card {
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.2s;
}
.save-slot-card:hover { border-color: var(--accent); }
.save-slot-card.empty { border-style: dashed; opacity: 0.6; }
.save-mini-team { display: flex; gap: 4px; margin-top: 6px; flex-wrap: wrap; }
.save-mini-team img { width: 36px; height: 36px; image-rendering: pixelated; }

/* TRADE OVERLAY */
#trade-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  z-index: 900;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(6px);
}
#trade-overlay.active { display: flex; }
.trade-box {
  background: linear-gradient(135deg, #0d1525, #0a2010);
  border: 2px solid #00c853;
  border-radius: 16px;
  padding: 24px;
  max-width: 480px;
  width: 95%;
  max-height: 90vh;
  overflow-y: auto;
}
.trade-code-display {
  background: rgba(0,0,0,0.5);
  border: 1px solid #00c853;
  border-radius: 8px;
  padding: 12px;
  font-family: 'Press Start 2P', monospace;
  font-size: 8px;
  color: #69f0ae;
  word-break: break-all;
  text-align: center;
  margin: 10px 0;
  max-height: 120px;
  overflow-y: auto;
}
#trade-receive-input {
  width: 100%;
  background: rgba(0,0,0,0.5);
  border: 2px solid var(--border);
  border-radius: 8px;
  color: #69f0ae;
  font-family: 'VT323', monospace;
  font-size: 16px;
  padding: 10px;
  resize: vertical;
  min-height: 80px;
  outline: none;
  margin-bottom: 10px;
}
#trade-receive-input:focus { border-color: #00c853; }
</style>
</head>
<body>

<!-- STARTER SCREEN -->
<div id="starter-screen">
  <div id="save-picker" style="display:none;width:100%;max-width:520px;padding:0 16px">
    <h1 style="text-align:center;margin-bottom:6px">‚ö° POK√âMON IDLE ‚ö°</h1>
    <p style="text-align:center;margin-bottom:20px">Continue your adventure or start fresh!</p>
    <div id="save-picker-list"></div>
    <button onclick="showStarterPicker()" style="width:100%;margin-top:10px;background:linear-gradient(135deg,rgba(239,83,80,0.15),rgba(239,83,80,0.05));border:1px solid #ef5350;color:#ef5350;padding:10px;border-radius:8px;cursor:pointer;font-family:'VT323',monospace;font-size:18px;letter-spacing:1px">üå± Start Brand New Game</button>
  </div>
  <div id="starter-picker" style="display:none;text-align:center">
    <h1>‚ö° POK√âMON IDLE ‚ö°</h1>
    <p>Choose your starter!</p>
    <div class="starter-grid" id="starter-grid"></div>
    <button onclick="showSavePicker()" style="margin-top:16px;background:rgba(255,255,255,0.05);border:1px solid var(--border);color:var(--text2);padding:6px 18px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:16px">‚Üê Back</button>
  </div>
</div>

<!-- MAIN GAME -->
<div id="game">
  <!-- TOP BAR -->
  <div id="topbar">
    <h2>‚ö° PKM IDLE</h2>
    <div class="resource"><span class="icon">üí∞</span><span class="val" id="res-gold">0</span> Gold</div>
    <div class="resource"><span class="icon">üíé</span><span class="val" id="res-gems">10</span> Gems</div>
    <div class="resource"><span class="icon">üèÜ</span><span class="val" id="res-wins">0</span> Wins</div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button onclick="openRedeemOverlay()" style="background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,165,0,0.1));border:1px solid var(--gold);color:var(--gold);padding:4px 12px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:16px;letter-spacing:1px;transition:all 0.2s" onmouseover="this.style.boxShadow='0 0 12px rgba(255,215,0,0.4)'" onmouseout="this.style.boxShadow=''">üéÅ REDEEM</button>
      <button onclick="openSavesOverlay()" style="background:linear-gradient(135deg,rgba(79,195,247,0.2),rgba(79,195,247,0.05));border:1px solid var(--accent);color:var(--accent);padding:4px 12px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:16px;letter-spacing:1px">üíæ SAVES</button>
      <button onclick="openDebugPanel()" style="background:rgba(255,0,0,0.15);border:1px solid #ef5350;color:#ef5350;padding:4px 12px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:16px;letter-spacing:1px">üõ† DEBUG</button>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div id="main-layout">
    <!-- BATTLE ARENA -->
    <div id="arena">
      <div id="encounter-flash"></div>
      <div id="wild-indicator">
        <span id="region-label" class="region-badge">Pallet Town</span>
        <span id="wave-label">Wave 1</span>
      </div>

      <div id="player-area" class="fighter-area">
        <div class="info-box" id="player-info">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <span class="pname" id="player-name">‚Äî</span>
            <span class="plevel" id="player-level">Lv.1</span>
          </div>
          <div class="bar-wrap">
            <div class="bar-label">HP <span id="player-hp-txt">0/0</span></div>
            <div class="bar"><div class="bar-fill hp-fill" id="player-hp-bar" style="width:100%"></div></div>
          </div>
          <div class="bar-wrap">
            <div class="bar-label">EXP</div>
            <div class="bar"><div class="bar-fill exp-fill" id="player-exp-bar" style="width:0%"></div></div>
          </div>
        </div>
        <img id="player-sprite" class="fighter-sprite" src="" alt="">
      </div>

      <div id="enemy-area" class="fighter-area">
        <div class="info-box" id="enemy-info">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <span class="pname" id="enemy-name">‚Äî</span>
            <span class="plevel" id="enemy-level">Lv.1</span>
          </div>
          <div class="bar-wrap">
            <div class="bar-label">HP <span id="enemy-hp-txt">0/0</span></div>
            <div class="bar"><div class="bar-fill hp-fill" id="enemy-hp-bar" style="width:100%"></div></div>
          </div>
        </div>
        <img id="enemy-sprite" class="fighter-sprite" src="" alt="">
      </div>

      <div id="battle-log"></div>
    </div>

    <!-- RIGHT PANEL -->
    <div id="right-panel">
      <div class="panel-tabs">
        <button class="tab-btn active" onclick="switchTab('team')">Team</button>
        <button class="tab-btn" onclick="switchTab('box')">Box</button>
        <button class="tab-btn" onclick="switchTab('gacha')">Gacha</button>
        <button class="tab-btn" onclick="switchTab('items')">Items</button>
        <button class="tab-btn" onclick="switchTab('road')" style="color:#b388ff">üíé</button>
      </div>

      <!-- TEAM TAB -->
      <div class="tab-content active" id="tab-team">
        <div style="font-family:'Press Start 2P';font-size:8px;color:var(--text2);margin-bottom:8px;">ACTIVE TEAM (6)</div>
        <div class="team-slots" id="team-slots-grid"></div>
        <div style="font-size:14px;color:var(--text2);">Click a Pok√©mon in Box to add to team.</div>
        <div style="margin-top:12px;font-family:'Press Start 2P';font-size:7px;color:var(--text2)">AUTO BATTLE</div>
        <div style="margin-top:6px;display:flex;gap:8px">
          <button class="btn gold" id="auto-btn" onclick="toggleAuto()">‚è∏ PAUSE</button>
          <button class="btn" onclick="switchNextPokemon()">‚û° NEXT PKM</button>
        </div>
        <div style="margin-top:6px">
          <button class="btn" onclick="openTradeOverlay()" style="border-color:#00c853;color:#69f0ae;width:100%">üîÑ Trade Pok√©mon</button>
        </div>
        <div style="margin-top:6px">
          <button class="btn" onclick="confirmWipeData()" style="border-color:#ef5350;color:#ef5350;width:100%">üóë Reset Save</button>
        </div>
        <div style="margin-top:6px">
          <button class="btn" onclick="forceSave()" style="border-color:#66bb6a;color:#66bb6a;width:100%">üíæ Force Save</button>
        </div>
        <div style="margin-top:6px;font-size:12px;color:var(--text2);text-align:center">üíæ Auto-saves every 30s</div>
      </div>

      <!-- BOX TAB -->
      <div class="tab-content" id="tab-box">
        <div style="font-family:'Press Start 2P';font-size:8px;color:var(--text2);margin-bottom:6px;">POK√âMON BOX</div>
        <div style="display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap">
          <span style="font-size:12px;color:var(--text2);align-self:center">Sort:</span>
          <button class="btn" style="padding:3px 8px;font-size:13px;flex:1" onclick="sortBox('level')">Lv ‚Üï</button>
          <button class="btn" style="padding:3px 8px;font-size:13px;flex:1" onclick="sortBox('name')">A-Z</button>
          <button class="btn" style="padding:3px 8px;font-size:13px;flex:1" onclick="sortBox('shiny')">‚ú®</button>
          <button class="btn" style="padding:3px 8px;font-size:13px;flex:1" onclick="sortBox('type')">Type</button>
          <button class="btn" style="padding:3px 8px;font-size:13px;flex:1" onclick="sortBox('stats')">Stats</button>
          <button class="btn" style="padding:3px 8px;font-size:13px;flex:1" onclick="sortBox('team')">Team</button>
        </div>
        <button class="btn" style="width:100%;border-color:#ef5350;color:#ef5350;margin-bottom:8px;padding:4px 8px;font-size:14px" onclick="openQuickRelease()">üïäÔ∏è Quick Release (Multi)</button>
        <div class="poke-box" id="poke-box-grid"></div>
      </div>

      <!-- GACHA TAB -->
      <div class="tab-content" id="tab-gacha">
        <div class="gacha-section">
          <h3>üé≤ POK√âMON GACHA</h3>
          <div style="font-size:13px;color:var(--text2);margin-bottom:8px;text-align:center">Common to Legendary ¬∑ ‚ú® Shiny: 1/512</div>
          <div class="gacha-btns">
            <button class="btn" onclick="doPokemonGacha(1)">√ó 1<br><span style="font-size:13px;color:var(--gold)">üíé 5</span></button>
            <button class="btn gold" onclick="doPokemonGacha(10)">√ó 10<br><span style="font-size:13px;color:var(--gold)">üíé 40</span></button>
          </div>
        </div>
        <div class="gacha-section" style="border-color:#9c27b0;background:linear-gradient(135deg,rgba(80,0,120,0.3),rgba(30,0,60,0.2))">
          <h3 style="color:#ce93d8">‚ö° EPIC GACHA</h3>
          <div style="font-size:13px;color:var(--text2);margin-bottom:8px;text-align:center">‚ú® Shiny: 1/64 ¬∑ No commons ¬∑ Boosted Legendary<br><span style="color:#ce93d8">Higher chance for rare Pok√©mon</span></div>
          <div class="gacha-btns">
            <button class="btn" style="border-color:#9c27b0;color:#ce93d8" onclick="doEpicGacha(1)">√ó 1<br><span style="font-size:13px;color:var(--gold)">üíé 50</span></button>
            <button class="btn" style="border-color:#9c27b0;color:#ce93d8;background:rgba(80,0,120,0.2)" onclick="doEpicGacha(10)">√ó 10<br><span style="font-size:13px;color:var(--gold)">üíé 450</span></button>
          </div>
        </div>
        <div class="gacha-section" style="border-color:#ff69b4;background:linear-gradient(135deg,rgba(120,0,80,0.3),rgba(60,0,40,0.2))">
          <h3 style="color:#ff69b4">‚ú® SHINY GACHA</h3>
          <div style="font-size:13px;color:var(--text2);margin-bottom:8px;text-align:center"><span class="shiny-text">Guaranteed Shiny Pok√©mon!</span><br><span style="color:#ff69b4">From Epic pool ¬∑ 1/25 legendary chance</span></div>
          <div class="gacha-btns">
            <button class="btn" style="border-color:#ff69b4;color:#ff69b4;width:100%" onclick="doShinyGacha()">√ó 1<br><span style="font-size:13px;color:var(--gold)">üíé 450</span></button>
          </div>
        </div>
        <div class="gacha-section">
          <h3>üéÅ ITEM GACHA</h3>
          <div style="font-size:13px;color:var(--text2);margin-bottom:8px;text-align:center">Standard held items &amp; equipment<br><span style="color:#ff69b4">30% chance for Rare Candy üç¨</span></div>
          <div class="gacha-btns">
            <button class="btn" onclick="doItemGacha(1)">√ó 1<br><span style="font-size:13px;color:var(--gold)">üí∞ 200</span></button>
            <button class="btn gold" onclick="doItemGacha(10)">√ó 10<br><span style="font-size:13px;color:var(--gold)">üí∞ 1,800</span></button>
          </div>
        </div>
        <div class="gacha-section" style="border-color:#e040fb;background:linear-gradient(135deg,rgba(60,0,100,0.4),rgba(20,0,50,0.2))">
          <h3 style="color:#e040fb">üí† EPIC ITEM GACHA</h3>
          <div style="font-size:13px;color:var(--text2);margin-bottom:8px;text-align:center"><span style="color:#e040fb">20% chance for epic items üí†</span><br>Includes <span style="color:#ff69b4">Rare Candy üç¨</span> &amp; powerful gear<br><span style="color:#ff69b4;font-size:12px">1% ultra rare: Max Candy üç≠</span></div>
          <div class="gacha-btns">
            <button class="btn" style="border-color:#e040fb;color:#e040fb" onclick="doEpicItemGacha(1)">√ó 1<br><span style="font-size:13px;color:var(--gold)">üí∞ 5,000</span></button>
            <button class="btn" style="border-color:#e040fb;color:#e040fb;background:rgba(80,0,120,0.2)" onclick="doEpicItemGacha(10)">√ó 10<br><span style="font-size:13px;color:var(--gold)">üí∞ 40,000</span></button>
          </div>
        </div>
        <div class="gacha-section" style="border-color:#00c853;background:linear-gradient(135deg,rgba(0,50,20,0.4),rgba(0,20,10,0.2))">
          <h3 style="color:#69f0ae">üåü FREE DAILY</h3>
          <button class="btn" style="border-color:#00c853;color:#69f0ae;width:100%;margin-top:4px" id="daily-btn" onclick="doDaily()">CLAIM FREE PULL</button>
        </div>
        <div class="gacha-section" style="border-color:#ffd700;background:linear-gradient(135deg,rgba(80,60,0,0.4),rgba(40,30,0,0.2))">
          <h3 style="color:#ffd700">üí∞ GOLD SHINY PULL</h3>
          <div style="font-size:13px;color:var(--text2);margin-bottom:8px;text-align:center"><span style="color:#ffd700">Spend 10,000,000 Gold for a guaranteed Shiny!</span><br><span style="color:var(--text2)">From Epic pool ¬∑ Same quality as Shiny Gacha</span></div>
          <div class="gacha-btns">
            <button class="btn" style="border-color:#ffd700;color:#ffd700;width:100%" onclick="doGoldShinyPull()">√ó 1<br><span style="font-size:13px;color:var(--gold)">üí∞ 10,000,000</span></button>
          </div>
        </div>
      </div>

      <!-- ITEMS TAB -->
      <div class="tab-content" id="tab-items">
        <div style="font-family:'Press Start 2P';font-size:8px;color:var(--text2);margin-bottom:8px;">INVENTORY</div>
        <div class="item-grid" id="item-grid"></div>
        <div style="font-size:14px;color:var(--text2);margin-top:8px">Click to equip ¬∑ Right-click to trash.</div>
      </div>

      <!-- DIAMOND ROAD TAB -->
      <div class="tab-content" id="tab-road">
        <div id="road-ui" style="width:100%;text-align:center"></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM BAR -->
  <div id="bottom-bar">
    <div style="font-family:'Press Start 2P';font-size:7px;color:var(--text2);writing-mode:vertical-rl;text-orientation:mixed;margin-right:4px">TEAM</div>
    <div id="bottom-slots" style="display:flex;gap:8px;flex:1;overflow-x:auto;padding-bottom:2px"></div>
  </div>
</div>

<!-- SAVES OVERLAY -->
<div id="saves-overlay">
  <div class="saves-box">
    <div style="font-family:'Press Start 2P';font-size:11px;color:var(--accent);text-align:center;margin-bottom:16px">üíæ SAVE SLOTS</div>
    <div id="saves-list"></div>
    <div style="display:flex;gap:8px;margin-top:14px;justify-content:center">
      <button class="btn" onclick="closeSavesOverlay()" style="flex:1;font-size:18px">Close</button>
    </div>
  </div>
</div>

<!-- TRADE OVERLAY -->
<div id="trade-overlay">
  <div class="trade-box">
    <div style="font-family:'Press Start 2P';font-size:10px;color:#69f0ae;text-align:center;margin-bottom:14px">üîÑ TRADE POK√âMON</div>
    <div id="trade-content"></div>
    <button class="btn" onclick="closeTradeOverlay()" style="width:100%;margin-top:10px;font-size:18px">Close</button>
  </div>
</div>

<!-- CAPTURE OVERLAY -->
<div id="capture-overlay">
  <div class="capture-box">
    <div id="capture-title" style="font-family:'Press Start 2P';font-size:9px;color:var(--gold);margin-bottom:12px">BATTLE WON!</div>
    <div id="capture-sprite" style="margin:10px 0;min-height:80px"></div>
    <div id="capture-text" style="font-size:15px;color:var(--text2);margin-bottom:14px"></div>
    <div id="capture-btns" style="display:flex;gap:10px;justify-content:center"></div>
  </div>
</div>

<!-- REDEEM OVERLAY -->
<div id="redeem-overlay">
  <div class="redeem-box">
    <div class="redeem-title">üéÅ REDEEM CODE</div>
    <div class="redeem-subtitle">Enter a gift code to claim your rewards!</div>
    <input type="text" id="redeem-input" placeholder="ENTER CODE HERE" maxlength="20" oninput="this.value=this.value.toUpperCase()" onkeydown="if(event.key==='Enter')doRedeem()">
    <div id="redeem-result"></div>
    <div class="redeem-btn-row">
      <button class="btn gold" onclick="doRedeem()" style="flex:1;font-size:18px">‚ú® Redeem!</button>
      <button class="btn" onclick="closeRedeemOverlay()" style="flex:1;font-size:18px">Close</button>
    </div>
  </div>
</div>

<!-- DEBUG MODAL -->
<div id="debug-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;align-items:center;justify-content:center;overflow-y:auto">
  <div style="background:#1a1a35;border:2px solid #ef5350;border-radius:12px;padding:24px;min-width:360px;max-width:480px;position:relative;font-family:'VT323',monospace;margin:20px auto;max-height:90vh;overflow-y:auto">
    <button onclick="closeDebug()" style="position:absolute;top:10px;right:12px;background:none;border:none;color:#ef5350;font-size:22px;cursor:pointer">‚úï</button>
    <div style="font-family:'Press Start 2P';font-size:10px;color:#ef5350;margin-bottom:16px;text-align:center">üõ† DEBUG PANEL</div>

    <!-- Gold editor -->
    <div style="margin-bottom:14px">
      <div style="color:#ffd700;font-size:16px;margin-bottom:4px">üí∞ Gold</div>
      <div style="display:flex;gap:8px">
        <input id="dbg-gold" type="number" style="flex:1;background:#0a0a1a;border:1px solid #3a3a6a;color:#ffd700;padding:6px 10px;border-radius:6px;font-family:'VT323',monospace;font-size:18px" placeholder="Amount">
        <button onclick="debugSetGold()" style="background:#ffd70022;border:1px solid #ffd700;color:#ffd700;padding:6px 14px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:17px">SET</button>
        <button onclick="debugAddGold()" style="background:#ffd70022;border:1px solid #ffd700;color:#ffd700;padding:6px 14px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:17px">ADD</button>
      </div>
    </div>

    <!-- Gems editor -->
    <div style="margin-bottom:14px">
      <div style="color:#4fc3f7;font-size:16px;margin-bottom:4px">üíé Gems</div>
      <div style="display:flex;gap:8px">
        <input id="dbg-gems" type="number" style="flex:1;background:#0a0a1a;border:1px solid #3a3a6a;color:#4fc3f7;padding:6px 10px;border-radius:6px;font-family:'VT323',monospace;font-size:18px" placeholder="Amount">
        <button onclick="debugSetGems()" style="background:#4fc3f722;border:1px solid #4fc3f7;color:#4fc3f7;padding:6px 14px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:17px">SET</button>
        <button onclick="debugAddGems()" style="background:#4fc3f722;border:1px solid #4fc3f7;color:#4fc3f7;padding:6px 14px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:17px">ADD</button>
      </div>
    </div>

    <!-- Level up current pokemon -->
    <div style="margin-bottom:14px">
      <div style="color:#ab47bc;font-size:16px;margin-bottom:6px">‚¨ÜÔ∏è Add Levels to Current Pok√©mon</div>
      <div id="dbg-current-poke" style="color:#e0e0ff;font-size:14px;margin-bottom:8px;padding:6px;background:rgba(255,255,255,0.05);border-radius:6px;text-align:center">‚Äî</div>
      <div style="display:flex;gap:8px">
        <input id="dbg-levels" type="number" min="1" value="1" style="flex:1;background:#0a0a1a;border:1px solid #3a3a6a;color:#ab47bc;padding:6px 10px;border-radius:6px;font-family:'VT323',monospace;font-size:18px" placeholder="Levels">
        <button onclick="debugAddLevels()" style="background:#ab47bc22;border:1px solid #ab47bc;color:#ab47bc;padding:6px 14px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:17px">ADD</button>
      </div>
      <div style="font-size:13px;color:#8888bb;margin-top:4px">Adds levels to the currently active fighter</div>
    </div>

    <!-- STAT MANIPULATOR -->
    <div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:14px;margin-top:4px">
      <div style="color:#ff9e40;font-size:16px;margin-bottom:8px">üîß Stat Manipulator ‚Äî Current Pok√©mon</div>
      <div id="dbg-stat-info" style="font-size:13px;color:#8888bb;margin-bottom:8px;text-align:center">Open debug to load</div>
      <div id="dbg-stat-rows" style="display:flex;flex-direction:column;gap:6px"></div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button onclick="debugSetAllIVs(31)" style="flex:1;background:rgba(255,215,0,0.12);border:1px solid #ffd700;color:#ffd700;padding:5px 8px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:15px">MAX ALL IVs</button>
        <button onclick="debugRandomizeIVs()" style="flex:1;background:rgba(79,195,247,0.12);border:1px solid #4fc3f7;color:#4fc3f7;padding:5px 8px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:15px">RANDOM IVs</button>
        <button onclick="debugApplyStats()" style="flex:1;background:rgba(102,187,106,0.15);border:1px solid #66bb6a;color:#66bb6a;padding:5px 8px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:15px">APPLY ‚úì</button>
      </div>
      <div style="font-size:12px;color:#8888bb;margin-top:4px;text-align:center">Edit IVs (0-31) then click APPLY to confirm</div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="modal-overlay" onclick="closeModal(event)">
  <div id="modal-box">
    <button id="modal-close" onclick="closeModal()">‚úï</button>
    <div id="modal-title">Info</div>
    <div id="modal-content"></div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// ============================================================
// DATA
// ============================================================

const TYPE_COLORS = {
  normal:'#A8A878', fire:'#F08030', water:'#6890F0', electric:'#F8D030',
  grass:'#78C850', ice:'#98D8D8', fighting:'#C03028', poison:'#A040A0',
  ground:'#E0C068', flying:'#A890F0', psychic:'#F85888', bug:'#A8B820',
  rock:'#B8A038', ghost:'#705898', dragon:'#7038F8', dark:'#705848',
  steel:'#B8B8D0', fairy:'#EE99AC'
};

const STARTERS = [
  {id:1, name:'Bulbasaur', types:['grass','poison']},
  {id:4, name:'Charmander', types:['fire']},
  {id:7, name:'Squirtle', types:['water']},
  {id:152, name:'Chikorita', types:['grass']},
  {id:155, name:'Cyndaquil', types:['fire']},
  {id:158, name:'Totodile', types:['water']},
  {id:252, name:'Treecko', types:['grass']},
  {id:255, name:'Torchic', types:['fire']},
  {id:258, name:'Mudkip', types:['water']},
];

const REGIONS = [
  { name: 'Pallet Town', minWave: 1, pool: [
    {id:16,name:'Pidgey',types:['normal','flying'],w:10},{id:19,name:'Rattata',types:['normal'],w:10},
    {id:21,name:'Spearow',types:['normal','flying'],w:8},{id:23,name:'Ekans',types:['poison'],w:7},
    {id:25,name:'Pikachu',types:['electric'],w:4},{id:39,name:'Jigglypuff',types:['normal','fairy'],w:6},
    {id:52,name:'Meowth',types:['normal'],w:5},
  ]},
  { name: 'Viridian Forest', minWave: 20, pool: [
    {id:10,name:'Caterpie',types:['bug'],w:10},{id:13,name:'Weedle',types:['bug','poison'],w:10},
    {id:11,name:'Metapod',types:['bug'],w:7},{id:14,name:'Kakuna',types:['bug','poison'],w:7},
    {id:12,name:'Butterfree',types:['bug','flying'],w:3},{id:15,name:'Beedrill',types:['bug','poison'],w:3},
    {id:35,name:'Clefairy',types:['normal','fairy'],w:2},
  ]},
  { name: 'Mt. Moon', minWave: 50, pool: [
    {id:41,name:'Zubat',types:['poison','flying'],w:10},{id:74,name:'Geodude',types:['rock','ground'],w:8},
    {id:50,name:'Diglett',types:['ground'],w:6},{id:27,name:'Sandshrew',types:['ground'],w:6},
    {id:46,name:'Paras',types:['bug','grass'],w:5},{id:79,name:'Slowpoke',types:['water','psychic'],w:3},
  ]},
  { name: 'Cerulean City', minWave: 100, pool: [
    {id:54,name:'Psyduck',types:['water'],w:8},{id:60,name:'Poliwag',types:['water'],w:8},
    {id:72,name:'Tentacool',types:['water','poison'],w:7},{id:98,name:'Krabby',types:['water'],w:6},
    {id:116,name:'Horsea',types:['water'],w:5},{id:118,name:'Goldeen',types:['water'],w:5},
    {id:120,name:'Staryu',types:['water'],w:3},
  ]},
  { name: 'Pokemon Tower', minWave: 200, pool: [
    {id:92,name:'Gastly',types:['ghost','poison'],w:10},{id:93,name:'Haunter',types:['ghost','poison'],w:6},
    {id:94,name:'Gengar',types:['ghost','poison'],w:2},{id:56,name:'Mankey',types:['fighting'],w:7},
    {id:66,name:'Machop',types:['fighting'],w:6},
  ]},
  { name: 'Safari Zone', minWave: 400, pool: [
    {id:113,name:'Chansey',types:['normal'],w:3},{id:115,name:'Kangaskhan',types:['normal'],w:3},
    {id:123,name:'Scyther',types:['bug','flying'],w:3},{id:127,name:'Pinsir',types:['bug'],w:3},
    {id:128,name:'Tauros',types:['normal'],w:4},{id:147,name:'Dratini',types:['dragon'],w:2},
    {id:148,name:'Dragonair',types:['dragon'],w:1},
  ]},
  { name: 'Victory Road', minWave: 800, pool: [
    {id:66,name:'Machop',types:['fighting'],w:6},{id:95,name:'Onix',types:['rock','ground'],w:5},
    {id:111,name:'Rhyhorn',types:['ground','rock'],w:5},{id:112,name:'Rhydon',types:['ground','rock'],w:3},
    {id:149,name:'Dragonite',types:['dragon','flying'],w:1},
  ]},
];

const EVOLUTIONS = {
  1:{id:2,name:'Ivysaur',level:16}, 2:{id:3,name:'Venusaur',level:32},
  4:{id:5,name:'Charmeleon',level:16}, 5:{id:6,name:'Charizard',level:36},
  7:{id:8,name:'Wartortle',level:16}, 8:{id:9,name:'Blastoise',level:36},
  10:{id:11,name:'Metapod',level:7}, 11:{id:12,name:'Butterfree',level:10},
  13:{id:14,name:'Kakuna',level:7}, 14:{id:15,name:'Beedrill',level:10},
  16:{id:17,name:'Pidgeotto',level:18}, 17:{id:18,name:'Pidgeot',level:36},
  19:{id:20,name:'Raticate',level:20}, 21:{id:22,name:'Fearow',level:20},
  23:{id:24,name:'Arbok',level:22}, 25:{id:26,name:'Raichu',level:30},
  27:{id:28,name:'Sandslash',level:22}, 29:{id:30,name:'Nidorina',level:16},
  30:{id:31,name:'Nidoqueen',level:36}, 32:{id:33,name:'Nidorino',level:16},
  33:{id:34,name:'Nidoking',level:36}, 35:{id:36,name:'Clefable',level:36},
  37:{id:38,name:'Ninetales',level:30}, 39:{id:40,name:'Wigglytuff',level:30},
  41:{id:42,name:'Golbat',level:22}, 42:{id:169,name:'Crobat',level:50},
  43:{id:44,name:'Gloom',level:21}, 44:{id:45,name:'Vileplume',level:36},
  46:{id:47,name:'Parasect',level:24}, 48:{id:49,name:'Venomoth',level:31},
  50:{id:51,name:'Dugtrio',level:26}, 52:{id:53,name:'Persian',level:28},
  54:{id:55,name:'Golduck',level:33}, 56:{id:57,name:'Primeape',level:28},
  58:{id:59,name:'Arcanine',level:36}, 60:{id:61,name:'Poliwhirl',level:25},
  61:{id:62,name:'Poliwrath',level:40}, 63:{id:64,name:'Kadabra',level:16},
  64:{id:65,name:'Alakazam',level:36}, 66:{id:67,name:'Machoke',level:28},
  67:{id:68,name:'Machamp',level:40}, 72:{id:73,name:'Tentacruel',level:30},
  74:{id:75,name:'Graveler',level:25}, 75:{id:76,name:'Golem',level:36},
  79:{id:80,name:'Slowbro',level:37}, 81:{id:82,name:'Magneton',level:30},
  84:{id:85,name:'Dodrio',level:31}, 86:{id:87,name:'Dewgong',level:34},
  88:{id:89,name:'Muk',level:38}, 90:{id:91,name:'Cloyster',level:36},
  92:{id:93,name:'Haunter',level:25}, 93:{id:94,name:'Gengar',level:36},
  95:{id:208,name:'Steelix',level:50}, 98:{id:99,name:'Kingler',level:28},
  100:{id:101,name:'Electrode',level:30}, 102:{id:103,name:'Exeggutor',level:36},
  104:{id:105,name:'Marowak',level:28}, 111:{id:112,name:'Rhydon',level:42},
  112:{id:464,name:'Rhyperior',level:65}, 113:{id:242,name:'Blissey',level:55},
  116:{id:117,name:'Seadra',level:32}, 118:{id:119,name:'Seaking',level:33},
  120:{id:121,name:'Starmie',level:36}, 123:{id:212,name:'Scizor',level:50},
  129:{id:130,name:'Gyarados',level:20}, 133:{id:134,name:'Vaporeon',level:30},
  147:{id:148,name:'Dragonair',level:30}, 148:{id:149,name:'Dragonite',level:55},
  152:{id:153,name:'Bayleef',level:16}, 153:{id:154,name:'Meganium',level:32},
  155:{id:156,name:'Quilava',level:14}, 156:{id:157,name:'Typhlosion',level:36},
  158:{id:159,name:'Croconaw',level:18}, 159:{id:160,name:'Feraligatr',level:30},
  252:{id:253,name:'Grovyle',level:16}, 253:{id:254,name:'Sceptile',level:36},
  255:{id:256,name:'Combusken',level:16}, 256:{id:257,name:'Blaziken',level:36},
  258:{id:259,name:'Marshtomp',level:16}, 259:{id:260,name:'Swampert',level:36},
};

const ITEMS = [
  {id:'leftovers', name:'Leftovers', emoji:'üçé', desc:'Restores 1/16 max HP every battle tick', effect:'regen'},
  {id:'choice_band', name:'Choice Band', emoji:'üéÄ', desc:'+50% Attack damage', effect:'atk_boost', value:1.5},
  {id:'choice_specs', name:'Choice Specs', emoji:'üîµ', desc:'+50% Sp.Atk damage', effect:'spatk_boost', value:1.5},
  {id:'life_orb', name:'Life Orb', emoji:'üîÆ', desc:'+30% damage dealt, lose 10% max HP per attack', effect:'life_orb'},
  {id:'focus_sash', name:'Focus Sash', emoji:'ü©π', desc:'Survive one lethal hit with 1 HP (from full HP)', effect:'focus_sash'},
  {id:'lucky_egg', name:'Lucky Egg', emoji:'ü•ö', desc:'+50% EXP gained from battle', effect:'lucky_egg', value:1.5},
  {id:'shell_bell', name:'Shell Bell', emoji:'üîî', desc:'Heal 1/8 of damage you deal', effect:'shell_bell'},
  {id:'rocky_helmet', name:'Rocky Helmet', emoji:'‚õëÔ∏è', desc:'Enemy loses 1/6 max HP when they hit you', effect:'rocky_helmet'},
  {id:'assault_vest', name:'Assault Vest', emoji:'ü¶∫', desc:'+50% Sp.Def (reduces incoming damage by 25%)', effect:'spdef_boost', value:1.5},
  {id:'wide_lens', name:'Wide Lens', emoji:'üî≠', desc:'+10% Speed (attack cooldown reduced)', effect:'spd_boost', value:1.1},
  {id:'dragon_scale', name:'Dragon Scale', emoji:'üê≤', desc:'+25% all stats for Dragon-type Pok√©mon', effect:'type_boost', type:'dragon'},
  {id:'magnet', name:'Magnet', emoji:'üß≤', desc:'+25% all stats for Electric-type Pok√©mon', effect:'type_boost', type:'electric'},
  {id:'exp_share', name:'Exp. Share', emoji:'üì°', desc:'Holder gains 30% of EXP earned by the active fighter even while benched', effect:'exp_share'},
];

const EPIC_ITEMS = [
  {id:'rare_candy', name:'Rare Candy', emoji:'üç¨', desc:'Instantly levels up a Pok√©mon by 1. Only works up to Lv.175!', effect:'rare_candy'},
  {id:'max_candy', name:'Max Candy', emoji:'üç≠', desc:'Instantly levels up any Pok√©mon by 1. Works up to Lv.250!', effect:'max_candy'},
  {id:'mega_stone', name:'Mega Stone', emoji:'üíé', desc:'+40% all stats. Powerful but balanced!', effect:'mega_stone', value:1.4},
  {id:'soul_dew', name:'Soul Dew', emoji:'üí†', desc:'+35% Sp.Atk and Sp.Def', effect:'soul_dew', value:1.35},
  {id:'draco_plate', name:'Draco Plate', emoji:'üêâ', desc:'+45% all stats for Dragon-type. +20% for others.', effect:'draco_plate', value:1.45},
  {id:'rusted_sword', name:'Rusted Sword', emoji:'‚öîÔ∏è', desc:'+60% Attack damage ‚Äî legendary blade!', effect:'rusted_sword', value:1.6},
  {id:'prism_scale', name:'Prism Scale', emoji:'üåà', desc:'+25% all stats and +15% max HP', effect:'prism_scale', value:1.25},
  {id:'eviolite', name:'Eviolite', emoji:'üîÆ', desc:'+35% Defense and Sp.Def. Absorb 20% of all damage.', effect:'eviolite', value:1.35},
  {id:'power_herb', name:'Power Herb', emoji:'üåø', desc:'+20% Speed &amp; Attack', effect:'power_herb', value:1.2},
];

const statsCache = {};

// ============================================================
// GAME STATE
// ============================================================

let gameState = {
  gold: 500, gems: 15, wins: 0, wave: 1, autoBattle: true,
  team: [], box: [], inventory: {}, equippedItems: {},
  currentFighterIdx: 0, dailyClaimed: false, lastDaily: 0,
  road: { active: false, floor: 0, winsOnFloor: 0, winsNeeded: 30, mode: null, farmRegionIdx: 0 },
  trainerName: 'Trainer'
};

let currentEnemy = null;
let battleTimer = null;
let battlePaused = false;
let pUid = 0;

// ============================================================
// COSMIC SHINY DETECTION
// ============================================================

function countSS(pokemon) {
  if(!pokemon.ivs) return 0;
  return Object.values(pokemon.ivs).filter(iv => iv >= 31).length;
}

function isCosmic(pokemon) {
  return pokemon.isShiny && countSS(pokemon) >= 3;
}

// ============================================================
// REDEEM CODES
// ============================================================

const REDEEM_STORAGE_KEY = 'pkm_idle_redeemed_codes';

function getRedeemedCodes() {
  try {
    return JSON.parse(localStorage.getItem(REDEEM_STORAGE_KEY) || '[]');
  } catch(e) { return []; }
}

function markCodeRedeemed(code) {
  const codes = getRedeemedCodes();
  if(!codes.includes(code)) codes.push(code);
  localStorage.setItem(REDEEM_STORAGE_KEY, JSON.stringify(codes));
}

function isCodeRedeemed(code) {
  return getRedeemedCodes().includes(code);
}

// Parse codes from pastebin text
function parseCodeData(rawText) {
  const codeMap = {};
  let currentGems = 0;
  const lines = rawText.split('\n').map(l => l.trim()).filter(Boolean);
  for(const line of lines) {
    const gemsMatch = line.match(/üíé\s*(\d+)\s*Gems?\s*Codes?/i);
    if(gemsMatch) { currentGems = parseInt(gemsMatch[1]); continue; }
    // Code format: uppercase alphanumeric, 8-10 chars
    if(/^[A-Z0-9]{8,12}$/.test(line)) {
      codeMap[line] = currentGems;
    }
  }
  return codeMap;
}

function openRedeemOverlay() {
  document.getElementById('redeem-overlay').classList.add('active');
  document.getElementById('redeem-input').value = '';
  document.getElementById('redeem-result').textContent = '';
  document.getElementById('redeem-result').style.color = '';
  setTimeout(() => document.getElementById('redeem-input').focus(), 100);
}

function closeRedeemOverlay() {
  document.getElementById('redeem-overlay').classList.remove('active');
}

async function doRedeem() {
  const input = document.getElementById('redeem-input');
  const resultEl = document.getElementById('redeem-result');
  const code = input.value.trim().toUpperCase();

  if(!code) {
    resultEl.textContent = '‚ö†Ô∏è Please enter a code!';
    resultEl.style.color = '#ffa726';
    return;
  }

  if(isCodeRedeemed(code)) {
    resultEl.textContent = '‚ùå Code already redeemed!';
    resultEl.style.color = '#ef5350';
    return;
  }

  resultEl.textContent = '‚è≥ Checking code...';
  resultEl.style.color = '#4fc3f7';

  try {
    // Fetch from pastebin through a CORS proxy alternative
    let rawText = null;
    try {
      const res = await fetch('https://pastebin.com/raw/MUvCVzuu');
      if(res.ok) rawText = await res.text();
    } catch(e) {
      // Network might be blocked ‚Äî use hardcoded fallback
    }

    // Fallback: hardcoded codes matching the pastebin
    const FALLBACK_CODES = {
      'X7F2K9LQ5Z': 50, 'M4R8T1VY6P': 50, 'Z9N3W6X2KD': 50,
      'Q5L8C2B7RM': 50, 'T1V9P4X8ZH': 50,
      'A8K3Z7M2QX': 100, 'R6T9L4W1PV': 100, 'Y2X8C5N7KD': 100,
      'B9Q4M1Z6RT': 100, 'L7V2P8X3CW': 100,
      'Z4X9K2M7QP': 250, 'V8L3T6R1ZY': 250, 'Q2M7P4X9KD': 250,
      'N6Z1W8C3LT': 250, 'T9K5R2V7XQ': 250,
    };

    let codeMap = FALLBACK_CODES;
    if(rawText) {
      const parsed = parseCodeData(rawText);
      if(Object.keys(parsed).length > 0) codeMap = { ...FALLBACK_CODES, ...parsed };
    }

    if(codeMap.hasOwnProperty(code)) {
      const gems = codeMap[code];
      markCodeRedeemed(code);
      gameState.gems += gems;
      updateResourceUI();
      resultEl.innerHTML = `<span style="color:#ffd700">‚ú® Code redeemed! +${gems} üíé Gems!</span>`;
      addLog(`üéÅ Code redeemed: +${gems} Gems!`, 'log-evolve');
      toast(`üéÅ Code valid! +${gems} üíé Gems!`, 4000);
      input.value = '';
      // Sparkle animation on result
      setTimeout(() => {
        resultEl.innerHTML = `<span style="font-family:'Press Start 2P';font-size:8px;background:linear-gradient(90deg,#ffd700,#ff69b4,#4fc3f7,#ffd700);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 1s linear infinite">+${gems} üíé Claimed!</span>`;
      }, 100);
    } else {
      resultEl.textContent = '‚ùå Invalid code!';
      resultEl.style.color = '#ef5350';
    }
  } catch(e) {
    resultEl.textContent = '‚ö†Ô∏è Network error. Try again!';
    resultEl.style.color = '#ffa726';
  }
}

// ============================================================
// IV / STATS HELPERS
// ============================================================

function generateIVs() {
  const stats = ['hp','attack','defense','special-attack','special-defense','speed'];
  const ivs = {};
  stats.forEach(s => { ivs[s] = Math.floor(Math.random() * 32); });
  return ivs;
}

function generateHighIVs() {
  const stats = ['hp','attack','defense','special-attack','special-defense','speed'];
  const ivs = {};
  stats.forEach(s => {
    const r1 = Math.floor(Math.random() * 32);
    const r2 = Math.floor(Math.random() * 32);
    const r3 = Math.floor(Math.random() * 32);
    ivs[s] = Math.max(r1, r2, r3);
  });
  const shuffled = [...stats].sort(() => Math.random() - 0.5);
  ivs[shuffled[0]] = 31;
  ivs[shuffled[1]] = 31;
  return ivs;
}

function getStatGrade(iv) {
  if(iv >= 31) return {label:'SS', color:'#ff69b4', isSS:true};
  if(iv >= 28) return {label:'S',  color:'#ffd700'};
  if(iv >= 24) return {label:'A',  color:'#66bb6a'};
  if(iv >= 18) return {label:'B',  color:'#4fc3f7'};
  if(iv >= 12) return {label:'C',  color:'#ab47bc'};
  if(iv >= 6)  return {label:'D',  color:'#ff9e40'};
  return {label:'F', color:'#ef5350'};
}

function newPokemonEntry(id, name, types, level, isShiny=false) {
  const pk = {
    uid: ++pUid, id, name, types, level, isShiny,
    currentHp: null, statsLoaded: false, stats: null,
    exp: 0, expToNext: calcExpToNext(level), ivs: generateIVs(),
    ot: gameState ? (gameState.trainerName || 'Trainer') : 'Trainer',
  };
  return pk;
}

function calcExpToNext(level) {
  return Math.floor(Math.pow(level, 3) * 0.8 + level * 50 + 100);
}

function getEffectiveStat(stat, pokemon, statName) {
  let val = stat;
  if(pokemon.level > 100) val = Math.floor(val * (1 + (pokemon.level - 100) * 0.008));
  const allItems = ITEMS.concat(EPIC_ITEMS);
  const item = allItems.find(i => i.id === gameState.equippedItems[pokemon.uid]);
  if(item) {
    if(item.effect === 'atk_boost' && statName === 'attack') val = Math.floor(val * item.value);
    if(item.effect === 'spatk_boost' && statName === 'special-attack') val = Math.floor(val * item.value);
    if(item.effect === 'spdef_boost' && statName === 'special-defense') val = Math.floor(val * item.value);
    if(item.effect === 'spd_boost' && statName === 'speed') val = Math.floor(val * item.value);
    if(item.effect === 'type_boost' && pokemon.types.includes(item.type)) val = Math.floor(val * 1.25);
    if(item.effect === 'mega_stone') val = Math.floor(val * item.value);
    if(item.effect === 'soul_dew' && (statName === 'special-attack' || statName === 'special-defense')) val = Math.floor(val * item.value);
    if(item.effect === 'draco_plate') { const mult = pokemon.types.includes('dragon') ? item.value : 1.4; val = Math.floor(val * mult); }
    if(item.effect === 'rusted_sword' && statName === 'attack') val = Math.floor(val * item.value);
    if(item.effect === 'prism_scale') val = Math.floor(val * item.value);
    if(item.effect === 'eviolite' && (statName === 'defense' || statName === 'special-defense')) val = Math.floor(val * item.value);
    if(item.effect === 'power_herb' && (statName === 'speed' || statName === 'attack')) val = Math.floor(val * item.value);
  }
  return val;
}

function getMaxHp(pokemon) {
  if(!pokemon.stats) return 100;
  const base = pokemon.stats.find(s=>s.stat.name==='hp').base_stat;
  const iv = pokemon.ivs ? pokemon.ivs['hp'] : 15;
  let hp = Math.floor(((base * 2 + iv) * pokemon.level / 100) + pokemon.level + 10);
  if(pokemon.level > 100) hp = Math.floor(hp * (1 + (pokemon.level-100)*0.01));
  const allItems = ITEMS.concat(EPIC_ITEMS);
  const item = allItems.find(i=>i.id===gameState.equippedItems[pokemon.uid]);
  if(item?.effect === 'prism_scale') hp = Math.floor(hp * 1.2);
  return hp;
}

function getAttack(pokemon) {
  if(!pokemon.stats) return 50;
  const base = pokemon.stats.find(s=>s.stat.name==='attack').base_stat;
  const spa = pokemon.stats.find(s=>s.stat.name==='special-attack').base_stat;
  const atk = Math.max(base, spa);
  const statName = atk >= spa ? 'attack' : 'special-attack';
  const iv = pokemon.ivs ? pokemon.ivs[statName] : 15;
  let val = Math.floor(((atk * 2 + iv) * pokemon.level / 100) + 5);
  return getEffectiveStat(val, pokemon, statName);
}

function getSpeed(pokemon) {
  if(!pokemon.stats) return 50;
  const base = pokemon.stats.find(s=>s.stat.name==='speed').base_stat;
  const iv = pokemon.ivs ? pokemon.ivs['speed'] : 15;
  let val = Math.floor(((base * 2 + iv) * pokemon.level / 100) + 5);
  return getEffectiveStat(val, pokemon, 'speed');
}

// ============================================================
// API
// ============================================================

async function fetchPokemonStats(id) {
  if(statsCache[id]) return statsCache[id];
  try {
    const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
    const data = await res.json();
    statsCache[id] = data.stats;
    return data.stats;
  } catch(e) {
    return [
      {stat:{name:'hp'},base_stat:65},{stat:{name:'attack'},base_stat:65},
      {stat:{name:'defense'},base_stat:65},{stat:{name:'special-attack'},base_stat:65},
      {stat:{name:'special-defense'},base_stat:65},{stat:{name:'speed'},base_stat:65},
    ];
  }
}

function getSpriteUrl(id, isShiny=false) {
  if(isShiny) return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${id}.png`;
  return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;
}

function getBattleSprite(id, isShiny=false) {
  if(isShiny) return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${id}.png`;
  return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
}

// ============================================================
// STARTER SCREEN
// ============================================================

function initStarterScreen() {
  const saves = getAllSaves().filter(Boolean);
  const hasAutoSave = loadGame() && gameState.box.length > 0;

  // If there are named saves OR an auto-save, show the picker
  if(saves.length > 0 || hasAutoSave) {
    // Reset gameState that loadGame() may have just populated ‚Äî we want the user to choose
    if(hasAutoSave) {
      // keep gameState loaded as a "last auto-save" option, but show picker
    }
    showSavePicker(hasAutoSave);
    return;
  }

  // No saves at all ‚Äî go straight to starter picker
  showStarterPicker();
}

function showSavePicker(hasAutoSave) {
  const screen = document.getElementById('starter-screen');
  screen.style.display = 'flex';
  screen.style.flexDirection = 'column';
  screen.style.alignItems = 'center';
  screen.style.justifyContent = 'center';
  document.getElementById('save-picker').style.display = 'block';
  document.getElementById('starter-picker').style.display = 'none';

  const saves = getAllSaves();
  const list = document.getElementById('save-picker-list');
  let html = '';

  // Auto-save slot (localStorage main save)
  const autoRaw = localStorage.getItem(SAVE_KEY);
  if(autoRaw) {
    try {
      const auto = JSON.parse(autoRaw);
      if(auto.box && auto.box.length > 0) {
        const teamUids = auto.teamUids || [];
        const teamPokemon = teamUids.map(uid => (auto.box||[]).find(p=>p.uid===uid)).filter(Boolean);
        const teamImgs = teamPokemon.map(p =>
          `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p.isShiny?'shiny/':''}${p.id}.png" title="${p.name} Lv.${p.level}" style="width:36px;height:36px;image-rendering:pixelated">`
        ).join('');
        html += `<div class="save-slot-card" style="cursor:pointer;border-color:var(--accent)" onclick="loadAutoSaveAndPlay()">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-family:'Press Start 2P';font-size:8px;color:var(--accent)">‚ö° AUTO-SAVE</div>
              <div style="font-size:13px;color:var(--text2);margin-top:3px">OT: ${auto.trainerName||'Trainer'} ¬∑ Wave ${auto.wave||1} ¬∑ ${auto.box.length} Pok√©mon</div>
              <div style="font-size:12px;color:var(--text2)">üí∞${formatNum(auto.gold||0)} ¬∑ üíé${auto.gems||0} ¬∑ üèÜ${auto.wins||0}</div>
              <div class="save-mini-team" style="margin-top:4px">${teamImgs}</div>
            </div>
            <div style="font-family:'Press Start 2P';font-size:9px;color:var(--accent);padding:8px">‚ñ∂ PLAY</div>
          </div>
        </div>`;
      }
    } catch(e) {}
  }

  // Named save slots
  for(let i = 0; i < MAX_SAVES; i++) {
    const s = saves[i];
    if(!s) continue;
    const teamUids = s.teamUids || [];
    const teamPokemon = teamUids.map(uid => (s.box||[]).find(p=>p.uid===uid)).filter(Boolean);
    const teamImgs = teamPokemon.map(p =>
      `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p.isShiny?'shiny/':''}${p.id}.png" title="${p.name} Lv.${p.level}" style="width:36px;height:36px;image-rendering:pixelated">`
    ).join('');
    const date = new Date(s.savedAt);
    const dateStr = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
    html += `<div class="save-slot-card" style="cursor:pointer" onclick="loadSaveSlotFromPicker(${i})">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-family:'Press Start 2P';font-size:8px;color:var(--gold)">${s.name}</div>
          <div style="font-size:13px;color:var(--text2);margin-top:3px">OT: ${s.trainerName||'Trainer'} ¬∑ Wave ${s.wave||1} ¬∑ ${s.box?s.box.length:0} Pok√©mon</div>
          <div style="font-size:12px;color:var(--text2)">üí∞${formatNum(s.gold||0)} ¬∑ üíé${s.gems||0} ¬∑ üèÜ${s.wins||0}</div>
          <div style="font-size:11px;color:#555;margin-bottom:4px">${dateStr}</div>
          <div class="save-mini-team" style="margin-top:2px">${teamImgs}</div>
        </div>
        <div style="font-family:'Press Start 2P';font-size:9px;color:var(--gold);padding:8px">‚ñ∂ PLAY</div>
      </div>
    </div>`;
  }

  if(!html) {
    // No saves found at all ‚Äî skip to starter
    showStarterPicker();
    return;
  }

  list.innerHTML = html;
}

function loadAutoSaveAndPlay() {
  // gameState already loaded by loadGame() in initStarterScreen
  document.getElementById('starter-screen').style.display = 'none';
  const game = document.getElementById('game');
  game.style.display = 'flex';
  game.style.flexDirection = 'column';
  if(gameState.road.active) document.getElementById('arena').classList.add('road-mode');
  renderAll();
  if(gameState.road.active) {
    if(gameState.road.mode === 'farm') spawnFarmEnemy();
    else spawnRoadEnemy();
  } else spawnEnemy();
  startBattle();
  toast('‚úÖ Auto-save loaded!');
}

function loadSaveSlotFromPicker(slotIdx) {
  const saves = getAllSaves();
  const s = saves[slotIdx];
  if(!s) return;
  try {
    if(battleTimer) { clearInterval(battleTimer); battleTimer = null; }
    bossBattleActive = false; vrBattleActive = false; giratinaBattleActive = false;
    currentEnemy = null; bossEnemy = null; vrEnemy = null; giratinaEnemy = null;
    battlePaused = false;
    playerAttackCooldown = 0; enemyAttackCooldown = 0;

    gameState.gold = s.gold || 500;
    gameState.gems = s.gems || 15;
    gameState.wins = s.wins || 0;
    gameState.wave = s.wave || 1;
    gameState.inventory = s.inventory || {};
    gameState.equippedItems = s.equippedItems || {};
    gameState.dailyClaimed = s.dailyClaimed || false;
    gameState.lastDaily = s.lastDaily || 0;
    gameState.road = s.road || {active:false,floor:0,winsOnFloor:0,winsNeeded:20,mode:null,farmRegionIdx:0};
    if(!gameState.road.mode) gameState.road.mode = gameState.road.active ? 'floor' : null;
    gameState.trainerName = s.trainerName || 'Trainer';
    pUid = s.pUid || 0;
    gameState.box = (s.box || []).map(p => ({ ...p, statsLoaded: !!p.stats, ivs: p.ivs || generateIVs(), ot: p.ot || s.trainerName || 'Trainer' }));
    gameState.team = (s.teamUids || []).map(uid => gameState.box.find(p=>p.uid===uid)).filter(Boolean);
    gameState.currentFighterIdx = Math.min(s.currentFighterIdx||0, Math.max(0,gameState.team.length-1));

    document.getElementById('starter-screen').style.display = 'none';
    const game = document.getElementById('game');
    game.style.display = 'flex';
    game.style.flexDirection = 'column';
    if(gameState.road.active) document.getElementById('arena').classList.add('road-mode');
    renderAll();
    if(gameState.road.active) {
      if(gameState.road.mode === 'farm') spawnFarmEnemy();
      else spawnRoadEnemy();
    } else spawnEnemy();
    startBattle();
    toast(`‚úÖ Loaded: ${s.name} (Wave ${gameState.wave})`, 3000);
  } catch(e) { console.warn(e); toast('‚ùå Failed to load!', 3000); }
}

function showStarterPicker() {
  const screen = document.getElementById('starter-screen');
  screen.style.display = 'flex';
  screen.style.flexDirection = 'column';
  screen.style.alignItems = 'center';
  screen.style.justifyContent = 'center';
  document.getElementById('save-picker').style.display = 'none';
  document.getElementById('starter-picker').style.display = 'block';

  const grid = document.getElementById('starter-grid');
  grid.innerHTML = '';
  STARTERS.forEach(s => {
    const card = document.createElement('div');
    card.className = 'starter-card';
    card.innerHTML = `
      <img src="${getSpriteUrl(s.id)}" alt="${s.name}" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${s.id}.png'">
      <div class="name">${s.name}</div>
      <div class="types">${s.types.map(t=>`<span class="type-badge" style="background:${TYPE_COLORS[t]}">${t}</span>`).join('')}</div>
    `;
    card.onclick = () => chooseStarter(s);
    grid.appendChild(card);
  });
}

async function chooseStarter(s) {
  const isShiny = Math.random() < 1/512;
  const pk = newPokemonEntry(s.id, s.name, s.types, 5, isShiny);
  pk.stats = await fetchPokemonStats(s.id);
  pk.statsLoaded = true;
  pk.currentHp = getMaxHp(pk);
  gameState.box.push(pk);
  gameState.team.push(pk);

  document.getElementById('starter-screen').style.display = 'none';
  const game = document.getElementById('game');
  game.style.display = 'flex';
  game.style.flexDirection = 'column';

  if(isShiny) toast(`üåü SHINY ${s.name.toUpperCase()}! You lucky soul!`, 4000);
  else toast(`You chose ${s.name}!`);

  renderAll();
  spawnEnemy();
  startBattle();
}

// ============================================================
// BATTLE SYSTEM
// ============================================================

function getCurrentFighter() {
  for(let i=0; i<gameState.team.length; i++) {
    const idx = (gameState.currentFighterIdx + i) % gameState.team.length;
    if(gameState.team[idx] && gameState.team[idx].currentHp > 0) return gameState.team[idx];
  }
  return null;
}

function getActiveRegion() {
  let region = REGIONS[0];
  for(const r of REGIONS) { if(gameState.wave >= r.minWave) region = r; }
  return region;
}

async function spawnEnemy() {
  const region = getActiveRegion();
  document.getElementById('region-label').textContent = region.name;
  document.getElementById('wave-label').textContent = `Wave ${gameState.wave}`;

  const pool = region.pool;
  const totalW = pool.reduce((s,p)=>s+p.w, 0);
  let r = Math.random() * totalW;
  let chosen = pool[0];
  for(const p of pool) { r -= p.w; if(r <= 0) { chosen = p; break; } }

  const baseLevel = Math.min(250, Math.max(1, Math.floor(gameState.wave * 0.8 + 2)));
  const level = Math.max(1, baseLevel + Math.floor((Math.random()-0.5)*4));
  const isShiny = Math.random() < 1/512;

  const enemy = newPokemonEntry(chosen.id, chosen.name, chosen.types, level, isShiny);
  enemy.stats = await fetchPokemonStats(chosen.id);
  enemy.statsLoaded = true;
  enemy.currentHp = getMaxHp(enemy);
  currentEnemy = enemy;

  for(const p of gameState.team) { if(p && p.statsLoaded) p.currentHp = getMaxHp(p); }

  const flash = document.getElementById('encounter-flash');
  flash.style.transition = 'opacity 0.05s';
  flash.style.opacity = '1';
  setTimeout(()=>{ flash.style.transition = 'opacity 1.2s'; flash.style.opacity = '0'; }, 120);

  updateEnemyUI();
  if(isShiny) { toast(`‚ú® Wild SHINY ${chosen.name} appeared!`, 3000); addLog(`‚ú® Wild SHINY ${chosen.name} appeared!`, 'log-shiny'); }
  else addLog(`A wild ${chosen.name} (Lv.${level}) appeared!`);
}

function startBattle() {
  if(battleTimer) clearInterval(battleTimer);
  battleTimer = setInterval(battleTick, 100);
}

let playerAttackCooldown = 0;
let enemyAttackCooldown = 0;
const BASE_ATTACK_MS = 2500;

function battleTick() {
  if(battlePaused || !currentEnemy) return;
  const player = getCurrentFighter();
  if(!player || !player.statsLoaded) return;

  const now = Date.now();
  if(!battleTick.lastRegen) battleTick.lastRegen = now;
  if(now - battleTick.lastRegen >= 1000) {
    battleTick.lastRegen = now;
    const regenItem = ITEMS.concat(EPIC_ITEMS).find(i=>i.id===gameState.equippedItems[player.uid]);
    if(regenItem?.effect === 'regen') {
      const heal = Math.max(1, Math.floor(getMaxHp(player) / 16));
      const prev = player.currentHp;
      player.currentHp = Math.min(getMaxHp(player), player.currentHp + heal);
      if(player.currentHp > prev) addLog(`${player.name} restored ${player.currentHp-prev} HP (Leftovers)!`, 'log-heal');
    }
  }

  const playerSpeed = getSpeed(player);
  const playerDelay = Math.max(800, BASE_ATTACK_MS - playerSpeed * 5);
  if(!playerAttackCooldown) playerAttackCooldown = now + playerDelay;
  if(now >= playerAttackCooldown) { playerAttackCooldown = now + playerDelay; doPlayerAttack(player); }

  const enemySpeed = currentEnemy.statsLoaded ? getSpeed(currentEnemy) : 50;
  const enemyDelay = Math.max(900, BASE_ATTACK_MS - enemySpeed * 5);
  if(!enemyAttackCooldown) enemyAttackCooldown = now + enemyDelay + 300;
  if(now >= enemyAttackCooldown) { enemyAttackCooldown = now + enemyDelay; doEnemyAttack(player); }

  updatePlayerUI(player);
  updateEnemyUI();
  updateBottomBar();
}

function doPlayerAttack(player) {
  if(!currentEnemy || currentEnemy.currentHp <= 0) return;
  let dmg = Math.max(1, getAttack(player) + Math.floor((Math.random()-0.5)*10));

  const allItems = ITEMS.concat(EPIC_ITEMS);
  const item = allItems.find(i=>i.id===gameState.equippedItems[player.uid]);
  if(item?.effect === 'life_orb') {
    dmg = Math.floor(dmg * 1.3);
    const selfDmg = Math.floor(getMaxHp(player) * 0.1);
    player.currentHp = Math.max(1, player.currentHp - selfDmg);
  }
  if(item?.effect === 'shell_bell') {
    const heal = Math.floor(dmg / 8);
    player.currentHp = Math.min(getMaxHp(player), player.currentHp + heal);
  }

  currentEnemy.currentHp = Math.max(0, currentEnemy.currentHp - dmg);

  const enemyItem = allItems.find(i=>i.id===gameState.equippedItems[currentEnemy?.uid]);
  if(enemyItem?.effect === 'rocky_helmet') {
    const recoil = Math.floor(getMaxHp(player) / 6);
    player.currentHp = Math.max(0, player.currentHp - recoil);
  }

  animateAttack('player');
  const dmgColor = isCosmic(player) ? '#00ffff' : player.isShiny ? '#ffd700' : '#ff6b6b';
  showDmgNum(dmg, 'enemy-area', dmgColor);
  animateHurt('enemy-sprite');
  addLog(`${player.name} dealt ${dmg} damage!`, 'log-dmg');

  if(currentEnemy.currentHp <= 0) enemyDefeated(player);
}

function doEnemyAttack(player) {
  if(!currentEnemy || player.currentHp <= 0) return;
  let dmg = Math.max(1, getAttack(currentEnemy) + Math.floor((Math.random()-0.5)*10));
  if(currentEnemy._attackMult) dmg = Math.floor(dmg * currentEnemy._attackMult);

  const allItems = ITEMS.concat(EPIC_ITEMS);
  const item = allItems.find(i=>i.id===gameState.equippedItems[player.uid]);
  if(item?.effect === 'spdef_boost') dmg = Math.floor(dmg * 0.75);
  if(item?.effect === 'eviolite') dmg = Math.floor(dmg * 0.80);
  if(item?.effect === 'focus_sash' && player.currentHp >= getMaxHp(player) && dmg >= player.currentHp) {
    dmg = player.currentHp - 1;
    addLog(`üí´ Focus Sash saved ${player.name}!`, 'log-heal');
  }

  player.currentHp = Math.max(0, player.currentHp - dmg);
  animateAttack('enemy');
  showDmgNum(dmg, 'player-area', '#ef5350');
  animateHurt('player-sprite');
  addLog(`${currentEnemy.name} dealt ${dmg} damage!`, 'log-dmg');

  if(player.currentHp <= 0) playerPokemonFainted(player);
}

function enemyDefeated(player) {
  if(bossBattleActive && currentEnemy?.isBoss) {
    if(vrBattleActive && currentEnemy?._isVR) handleVRDefeated(player);
    else if(currentEnemy?._isGiratina) handleGiratinaDefeated(player);
    else handleBossDefeated(player);
    return;
  }

  addLog(`${currentEnemy.name} was defeated!`, 'log-heal');
  const goldGain = Math.floor(currentEnemy.level * 3 + Math.random() * currentEnemy.level * 2 + 5);
  const gemGain = Math.random() < 0.15 ? 1 : 0;
  gameState.gold += goldGain;
  if(gemGain) { gameState.gems += gemGain; toast('üíé Found a Gem!'); }
  gameState.wins++;

  if(gameState.road.active) {
    if(gameState.road.mode === 'floor') {
      const floor = ROAD_FLOORS[gameState.road.floor];
      gameState.road.winsOnFloor++;
      let gemGainRoad = 0;
      const w = gameState.road.winsOnFloor;
      if(floor.gemsPerThree && w % 3 === 0) gemGainRoad = 1;
      else if(floor.gemsPerFive && w % 5 === 0) gemGainRoad = 1;
      else if(w % 10 === 0) gemGainRoad = 1;
      if(gemGainRoad > 0) { gameState.gems += gemGainRoad; addLog(`üíé +${gemGainRoad} Gem from Diamond Road! (${w}/${floor.winsNeeded})`, 'log-evolve'); updateResourceUI(); }
      const roadGoldBonus = floor.goldBonus || 0;
      if(roadGoldBonus > 0) gameState.gold += roadGoldBonus;
      if(gameState.road.winsOnFloor >= floor.winsNeeded) {
        gameState.gems += floor.bonusGems;
        addLog(`üéâ ${floor.name} CLEARED! +${floor.bonusGems} bonus Gems!`, 'log-evolve');
        toast(`üéâ Floor cleared! +${floor.bonusGems} üíé Gems!`, 4000);
        updateResourceUI();
        if(gameState.road.floor + 1 < ROAD_FLOORS.length) {
          gameState.road.floor++;
          gameState.road.winsOnFloor = 0;
          gameState.road.winsNeeded = ROAD_FLOORS[gameState.road.floor].winsNeeded;
          addLog(`‚¨ÜÔ∏è Advanced to ${ROAD_FLOORS[gameState.road.floor].name}!`, 'log-evolve');
        } else {
          addLog(`üëë You completed all Diamond Road floors!`, 'log-evolve');
          toast(`üëë ALL FLOORS CLEARED! Incredible!`, 5000);
          gameState.road.active = false;
          document.getElementById('arena').classList.remove('road-mode');
        }
      }
    } else if(gameState.road.mode === 'farm') {
      const farmGoldBonus = Math.floor(currentEnemy ? currentEnemy.level * 2 + 50 : 50);
      gameState.gold += farmGoldBonus;
      addLog(`üåæ +${farmGoldBonus} farm gold!`, 'log-heal');
      updateResourceUI();
    }
  } else {
    gameState.wave++;
  }

  let expGain = Math.floor(currentEnemy.level * 15 + Math.random() * 20 + 10);
  const item = ITEMS.concat(EPIC_ITEMS).find(i=>i.id===gameState.equippedItems[player.uid]);
  if(item?.effect === 'lucky_egg') expGain = Math.floor(expGain * 1.5);
  giveExp(player, expGain);
  addLog(`+${goldGain} gold, +${expGain} EXP`, 'log-exp');

  currentEnemy = null;
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;
  battleTick.lastRegen = 0;
  updateResourceUI();
  renderAll();

  const delay = gameState.road.active ? 800 : 1200;
  const nextSpawn = gameState.road.active
    ? (gameState.road.mode === 'farm' ? spawnFarmEnemy : spawnRoadEnemy)
    : spawnEnemy;
  setTimeout(nextSpawn, delay);
}

function playerPokemonFainted(player) {
  addLog(`${player.name} fainted!`, 'log-dmg');

  if(bossBattleActive && currentEnemy?.isBoss) {
    player.currentHp = 0;
    addLog(`${player.name} is down for the count!`, 'log-dmg');
    let nextIdx = -1;
    for(let i = 1; i <= gameState.team.length; i++) {
      const idx = (gameState.currentFighterIdx + i) % gameState.team.length;
      const p = gameState.team[idx];
      if(p && p !== player && p.currentHp > 0) { nextIdx = idx; break; }
    }
    if(nextIdx >= 0) {
      gameState.currentFighterIdx = nextIdx;
      const next = gameState.team[nextIdx];
      addLog(`Go, ${next.name}! Fight ${currentEnemy?.name || 'the Boss'}! üí™`, 'log-heal');
      updatePlayerUI(next);
      playerAttackCooldown = 0;
      enemyAttackCooldown = Date.now() + 800;
      renderBottomBar();
    } else {
      if(vrBattleActive) handleVRFailed();
      else if(giratinaBattleActive) handleGiratinaFailed();
      else handleBossFailed();
    }
    return;
  }

  const reviveHp = Math.max(1, Math.floor(getMaxHp(player) * 0.30));
  player.currentHp = reviveHp;
  addLog(`${player.name} is resting and will recover...`, 'log-heal');

  let nextIdx = -1;
  for(let i = 1; i <= gameState.team.length; i++) {
    const idx = (gameState.currentFighterIdx + i) % gameState.team.length;
    const p = gameState.team[idx];
    if(p && p !== player && p.currentHp > 0) { nextIdx = idx; break; }
  }

  if(nextIdx >= 0) {
    gameState.currentFighterIdx = nextIdx;
    addLog(`Go, ${gameState.team[nextIdx].name}! üí™`, 'log-heal');
    updatePlayerUI(gameState.team[nextIdx]);
    playerAttackCooldown = 0;
    enemyAttackCooldown = Date.now() + 800;
    renderBottomBar();
  } else {
    addLog(`All Pok√©mon fainted! Everyone is revived at 25% HP!`, 'log-heal');
    toast('All Pok√©mon fainted! Reviving...', 3000);
    gameState.team.forEach(p => { p.currentHp = Math.max(1, Math.floor(getMaxHp(p)*0.25)); });
    gameState.currentFighterIdx = 0;
    playerAttackCooldown = 0;
    enemyAttackCooldown = 0;
    renderBottomBar();
  }
}

function giveExp(pokemon, amount) {
  pokemon.exp += amount;
  while(pokemon.exp >= pokemon.expToNext && pokemon.level < 250) {
    pokemon.exp -= pokemon.expToNext;
    pokemon.level++;
    pokemon.expToNext = calcExpToNext(pokemon.level);
    pokemon.currentHp = getMaxHp(pokemon);
    addLog(`${pokemon.name} grew to Lv.${pokemon.level}!`, 'log-exp');
    toast(`‚¨ÜÔ∏è ${pokemon.name} is now Lv.${pokemon.level}!`);
    checkEvolution(pokemon);
  }

  const expShareAmt = Math.floor(amount * 0.30);
  if(expShareAmt > 0) {
    gameState.box.forEach(p => {
      if(p === pokemon) return;
      const item = ITEMS.concat(EPIC_ITEMS).find(i=>i.id===gameState.equippedItems[p.uid]);
      if(item?.effect === 'exp_share') {
        p.exp += expShareAmt;
        while(p.exp >= p.expToNext && p.level < 250) {
          p.exp -= p.expToNext; p.level++; p.expToNext = calcExpToNext(p.level);
          p.currentHp = getMaxHp(p);
          addLog(`${p.name} (Exp.Share) grew to Lv.${p.level}!`, 'log-exp');
          checkEvolution(p);
        }
      }
    });
  }
}

async function checkEvolution(pokemon) {
  const evo = EVOLUTIONS[pokemon.id];
  if(evo && pokemon.level >= evo.level) {
    const oldName = pokemon.name;
    pokemon.id = evo.id;
    pokemon.name = evo.name;
    pokemon.stats = await fetchPokemonStats(evo.id);
    const oldHp = pokemon.currentHp;
    const oldMax = getMaxHp(pokemon);
    pokemon.currentHp = Math.min(getMaxHp(pokemon), getMaxHp(pokemon) * oldHp / oldMax + 30);

    addLog(`‚ú® ${oldName} evolved into ${evo.name}!`, 'log-evolve');
    toast(`üéâ ${oldName} evolved into ${evo.name}!`, 4000);

    // Check if newly cosmic after evolution
    if(isCosmic(pokemon)) {
      addLog(`üåå ${pokemon.name} radiates COSMIC energy!`, 'log-cosmic');
      toast(`üåå COSMIC ${pokemon.name}!`, 3000);
    }

    const sprite = document.getElementById('player-sprite');
    if(sprite) sprite.classList.add('evolve-flash');
    setTimeout(()=>{ if(sprite) sprite.classList.remove('evolve-flash'); }, 1000);

    updatePlayerUI(pokemon);
    renderAll();
    setTimeout(()=>checkEvolution(pokemon), 500);
  }
}

function switchNextPokemon() {
  if(gameState.team.length === 0) return;
  gameState.currentFighterIdx = (gameState.currentFighterIdx + 1) % gameState.team.length;
  playerAttackCooldown = 0;
  toast(`Switched to ${gameState.team[gameState.currentFighterIdx].name}!`);
  renderAll();
}

// ============================================================
// UI UPDATE
// ============================================================

function getPokemonSpriteClass(pokemon) {
  if(isCosmic(pokemon)) return 'fighter-sprite cosmic-sprite';
  if(pokemon.isShiny) return 'fighter-sprite shiny-sprite';
  return 'fighter-sprite';
}

function updatePlayerUI(player) {
  if(!player) return;
  const cosmic = isCosmic(player);
  const prefix = cosmic ? 'üåå ' : player.isShiny ? '‚òÖ ' : '';
  document.getElementById('player-name').textContent = prefix + player.name.toUpperCase();
  document.getElementById('player-level').textContent = `Lv.${player.level}`;
  const maxHp = getMaxHp(player);
  const hpPct = Math.max(0, Math.min(100, (player.currentHp / maxHp) * 100));
  const expPct = Math.min(100, (player.exp / player.expToNext) * 100);
  document.getElementById('player-hp-bar').style.width = hpPct + '%';
  document.getElementById('player-hp-bar').style.background = hpPct > 50 ? 'linear-gradient(90deg,#66bb6a,#43a047)' : hpPct > 25 ? 'linear-gradient(90deg,#ffa726,#fb8c00)' : 'linear-gradient(90deg,#ef5350,#e53935)';
  document.getElementById('player-hp-txt').textContent = `${Math.max(0,player.currentHp)}/${maxHp}`;
  document.getElementById('player-exp-bar').style.width = expPct + '%';

  const sprite = document.getElementById('player-sprite');
  sprite.src = getBattleSprite(player.id, player.isShiny);
  sprite.className = getPokemonSpriteClass(player);
}

function updateEnemyUI() {
  if(!currentEnemy) return;
  const cosmic = isCosmic(currentEnemy);
  const prefix = cosmic ? 'üåå ' : currentEnemy.isShiny ? '‚òÖ ' : '';
  document.getElementById('enemy-name').textContent = prefix + currentEnemy.name.toUpperCase() + (currentEnemy.isBoss ? ' üêâ' : '');
  document.getElementById('enemy-level').textContent = `Lv.${currentEnemy.level}`;
  const maxHp = currentEnemy._bossHpMax || getMaxHp(currentEnemy);
  const hpPct = Math.max(0, Math.min(100, (currentEnemy.currentHp / maxHp) * 100));
  document.getElementById('enemy-hp-bar').style.width = hpPct + '%';
  document.getElementById('enemy-hp-bar').style.background = hpPct > 50 ? 'linear-gradient(90deg,#66bb6a,#43a047)' : hpPct > 25 ? 'linear-gradient(90deg,#ffa726,#fb8c00)' : 'linear-gradient(90deg,#ef5350,#e53935)';
  document.getElementById('enemy-hp-txt').textContent = `${formatNum(Math.max(0,currentEnemy.currentHp))}/${formatNum(maxHp)}`;

  const sprite = document.getElementById('enemy-sprite');
  sprite.src = getBattleSprite(currentEnemy.id, currentEnemy.isShiny);
  sprite.className = getPokemonSpriteClass(currentEnemy);
}

function updateResourceUI() {
  document.getElementById('res-gold').textContent = formatNum(gameState.gold);
  document.getElementById('res-gems').textContent = formatNum(gameState.gems);
  document.getElementById('res-wins').textContent = formatNum(gameState.wins);
}

function formatNum(n) {
  if(n >= 1000000) return (n/1000000).toFixed(1)+'M';
  if(n >= 1000) return (n/1000).toFixed(1)+'K';
  return n;
}

function renderAll() {
  updateResourceUI();
  const player = getCurrentFighter();
  if(player) updatePlayerUI(player);
  updateEnemyUI();
  renderTeamSlots();
  renderPokemonBox();
  renderBottomBar();
  renderItems();
  updateBottomBar();
}

function getSlotExtraClass(p) {
  if(isCosmic(p)) return ' cosmic-slot';
  if(p.isShiny) return ' shiny-slot';
  return '';
}

function renderTeamSlots() {
  const grid = document.getElementById('team-slots-grid');
  grid.innerHTML = '';
  for(let i=0; i<6; i++) {
    const p = gameState.team[i];
    const div = document.createElement('div');
    const extraClass = p ? getSlotExtraClass(p) : '';
    div.className = 'team-slot' + (p && i===gameState.currentFighterIdx ? ' active-fighter' : '') + extraClass;
    if(p) {
      const maxHp = getMaxHp(p);
      const hpPct = Math.max(0, Math.min(100, (p.currentHp / maxHp)*100));
      const cosmic = isCosmic(p);
      div.innerHTML = `
        ${cosmic ? '<span class="shiny-badge" style="font-size:12px">üåå</span>' : p.isShiny ? '<span class="shiny-badge">‚òÖ</span>' : ''}
        <img src="${getSpriteUrl(p.id, p.isShiny)}" onerror="this.src='${getBattleSprite(p.id,p.isShiny)}'">
        <span class="slot-name">${cosmic ? '<span class="cosmic-text" style="font-size:5px">COSMIC</span> ' : ''}${p.name}</span>
        <span class="slot-level">Lv.${p.level}</span>
        <div class="bar" style="margin-top:3px"><div class="bar-fill hp-fill" style="width:${hpPct}%;background:linear-gradient(90deg,#66bb6a,#43a047)"></div></div>
      `;
      div.onclick = () => { gameState.currentFighterIdx = i; playerAttackCooldown = 0; renderAll(); };
      div.oncontextmenu = (e) => { e.preventDefault(); showPokemonInfoCard(p); };
    } else {
      div.classList.add('empty-slot');
      div.innerHTML = '+';
    }
    grid.appendChild(div);
  }
}

function renderPokemonBox() {
  const grid = document.getElementById('poke-box-grid');
  grid.innerHTML = '';
  if(gameState.box.length === 0) {
    grid.innerHTML = '<div style="color:var(--text2);font-size:14px">No Pok√©mon yet. Use Gacha!</div>';
    return;
  }
  const sorted = getBoxSorted();
  sorted.forEach((p) => {
    const div = document.createElement('div');
    const cosmic = isCosmic(p);
    div.className = 'poke-card' + (cosmic ? ' cosmic-card' : p.isShiny ? ' shiny-card' : '');
    const equippedItem = ITEMS.concat(EPIC_ITEMS).find(i=>i.id===gameState.equippedItems[p.uid]);
    const teamIdx = gameState.team.indexOf(p);
    const inParty = teamIdx >= 0;
    const targetLevel = getPullTargetLevel();
    const canPull = p.level < targetLevel;
    div.innerHTML = `
      ${cosmic ? '<div style="position:absolute;top:3px;right:4px;font-size:12px">üåå</div>' : p.isShiny ? '<div style="position:absolute;top:3px;right:4px;font-size:14px">‚òÖ</div>' : ''}
      ${inParty ? `<div style="position:absolute;top:3px;left:4px;font-size:10px;background:rgba(79,195,247,0.25);border:1px solid var(--accent);border-radius:3px;padding:1px 3px;color:var(--accent);font-family:'Press Start 2P',monospace">P${teamIdx+1}</div>` : ''}
      <img src="${getSpriteUrl(p.id, p.isShiny)}" onerror="this.src='${getBattleSprite(p.id,p.isShiny)}'">
      <span class="cname">${cosmic ? '<span style="background:linear-gradient(90deg,#00ffff,#bf00ff,#ff00aa,#00ffff);background-size:300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 1.5s linear infinite">COSMIC</span> ' : ''}${p.name}</span>
      <span class="clevel">Lv.${p.level}</span>
      ${equippedItem ? `<div style="font-size:16px">${equippedItem.emoji}</div>` : ''}
      <div style="display:flex;gap:3px;justify-content:center;flex-wrap:wrap;margin-top:3px">
        ${p.types.map(t=>`<span class="type-badge" style="background:${TYPE_COLORS[t]};font-size:10px">${t}</span>`).join('')}
      </div>
      ${canPull ? `<button onclick="event.stopPropagation();pullToLevel(${p.uid})" style="margin-top:5px;width:100%;background:linear-gradient(135deg,rgba(79,195,247,0.2),rgba(79,195,247,0.05));border:1px solid rgba(79,195,247,0.5);color:var(--accent);border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:14px;padding:4px 4px;line-height:1.3">‚¨Ü Lv.${targetLevel}<br><span style="color:var(--gold);font-size:12px">25üíé</span></button>` : ''}
    `;
    div.onclick = () => showPokemonModal(p);
    div.oncontextmenu = (e) => { e.preventDefault(); showPokemonInfoCard(p); };
    grid.appendChild(div);
  });
}

function updateBottomBar() { renderBottomBar(); }

function renderBottomBar() {
  const bar = document.getElementById('bottom-slots');
  bar.innerHTML = '';
  for(let i=0; i<6; i++) {
    const p = gameState.team[i];
    const div = document.createElement('div');
    const cosmic = p && isCosmic(p);
    div.className = 'bottom-slot' + (i===gameState.currentFighterIdx ? ' active-slot' : '') + (cosmic ? ' cosmic-slot-b' : p?.isShiny ? ' shiny-slot-b' : '');
    if(p) {
      const maxHp = getMaxHp(p);
      const hpPct = Math.max(0, Math.min(100, (p.currentHp / maxHp)*100));
      div.innerHTML = `
        ${cosmic ? '<span class="b-shiny">üåå</span>' : p.isShiny ? '<span class="b-shiny">‚òÖ</span>' : ''}
        <img src="${getBattleSprite(p.id, p.isShiny)}">
        <span class="b-name">${p.name.substring(0,8)}</span>
        <div class="b-hp-bar"><div class="b-hp-fill" style="width:${hpPct}%;background:${hpPct>50?'var(--green)':hpPct>25?'orange':'red'}"></div></div>
      `;
      div.onclick = () => { gameState.currentFighterIdx = i; playerAttackCooldown=0; renderAll(); };
    } else {
      div.innerHTML = '<span style="color:var(--border);font-size:22px">+</span>';
      div.onclick = () => switchTab('box');
    }
    bar.appendChild(div);
  }
}

function renderItems() {
  const grid = document.getElementById('item-grid');
  grid.innerHTML = '';
  const allItems = ITEMS.concat(EPIC_ITEMS);
  allItems.forEach(item => {
    const count = gameState.inventory[item.id] || 0;
    if(count === 0) return;
    const div = document.createElement('div');
    div.className = 'item-cell';
    div.title = `${item.name}: ${item.desc}`;
    const isEpic = EPIC_ITEMS.some(e=>e.id===item.id);
    if(isEpic) div.style.border = '1px solid #e040fb';
    div.innerHTML = `${item.emoji}<span class="item-count">√ó${count}</span>`;
    div.onclick = () => showItemModal(item);
    div.oncontextmenu = (e) => { e.preventDefault(); trashItem(item.id); };
    grid.appendChild(div);
  });
  if(!allItems.some(i=>(gameState.inventory[i.id]||0)>0)) {
    grid.innerHTML = '<div style="color:var(--text2);font-size:13px;grid-column:1/-1">No items yet! Use Item Gacha.</div>';
  }
}

// ============================================================
// ANIMATIONS
// ============================================================

function animateAttack(who) {
  const sprite = document.getElementById(who==='player'?'player-sprite':'enemy-sprite');
  sprite.classList.remove('attack-anim');
  void sprite.offsetWidth;
  sprite.classList.add('attack-anim');
  setTimeout(()=>sprite.classList.remove('attack-anim'), 500);
}

function animateHurt(id) {
  const sprite = document.getElementById(id);
  const pokemon = id === 'player-sprite' ? getCurrentFighter() : currentEnemy;
  const cosmic = pokemon && isCosmic(pokemon);
  const isShiny = pokemon?.isShiny;

  sprite.style.animation = 'none';
  void sprite.offsetWidth;
  if(id === 'player-sprite') {
    sprite.style.animation = cosmic ? 'hurt-player-cosmic 0.45s ease-out' : isShiny ? 'hurt-player-shiny 0.45s ease-out' : 'hurt-player 0.45s ease-out';
  } else {
    sprite.style.animation = cosmic ? 'hurt-cosmic 0.45s ease-out' : isShiny ? 'hurt-shiny 0.45s ease-out' : 'hurt 0.45s ease-out';
  }
  setTimeout(()=>{ sprite.style.animation = ''; }, 500);
}

function showDmgNum(dmg, areaId, color) {
  const area = document.getElementById(areaId);
  if(!area) return;
  const div = document.createElement('div');
  div.className = 'dmg-num';
  div.textContent = '-' + dmg;
  div.style.color = color;
  const rect = area.getBoundingClientRect();
  const arenaRect = document.getElementById('arena').getBoundingClientRect();
  div.style.left = (rect.left - arenaRect.left + 30 + Math.random()*40) + 'px';
  div.style.top = (rect.top - arenaRect.top - 20 + Math.random()*20) + 'px';
  document.getElementById('arena').appendChild(div);
  setTimeout(()=>div.remove(), 1300);
}

// ============================================================
// BATTLE LOG
// ============================================================

function addLog(msg, cls='') {
  const log = document.getElementById('battle-log');
  const div = document.createElement('div');
  div.className = 'log-entry ' + cls;
  const time = new Date();
  div.textContent = `[${time.getHours().toString().padStart(2,'0')}:${time.getMinutes().toString().padStart(2,'0')}] ${msg}`;
  log.appendChild(div);
  while(log.children.length > 40) log.removeChild(log.firstChild);
  log.scrollTop = log.scrollHeight;
}

// ============================================================
// GACHA
// ============================================================

const GACHA_POOL = [
  {id:16,name:'Pidgey',types:['normal','flying'],w:20},{id:19,name:'Rattata',types:['normal'],w:20},
  {id:39,name:'Jigglypuff',types:['normal','fairy'],w:15},{id:52,name:'Meowth',types:['normal'],w:15},
  {id:54,name:'Psyduck',types:['water'],w:12},{id:60,name:'Poliwag',types:['water'],w:12},
  {id:56,name:'Mankey',types:['fighting'],w:12},{id:66,name:'Machop',types:['fighting'],w:12},
  {id:74,name:'Geodude',types:['rock','ground'],w:12},{id:88,name:'Grimer',types:['poison'],w:12},
  {id:92,name:'Gastly',types:['ghost','poison'],w:10},{id:100,name:'Voltorb',types:['electric'],w:10},
  {id:1,name:'Bulbasaur',types:['grass','poison'],w:8},{id:4,name:'Charmander',types:['fire'],w:8},
  {id:7,name:'Squirtle',types:['water'],w:8},{id:25,name:'Pikachu',types:['electric'],w:7},
  {id:35,name:'Clefairy',types:['normal','fairy'],w:7},{id:58,name:'Growlithe',types:['fire'],w:7},
  {id:79,name:'Slowpoke',types:['water','psychic'],w:6},{id:104,name:'Cubone',types:['ground'],w:6},
  {id:116,name:'Horsea',types:['water'],w:6},{id:147,name:'Dratini',types:['dragon'],w:5},
  {id:63,name:'Abra',types:['psychic'],w:4},{id:133,name:'Eevee',types:['normal'],w:4},
  {id:123,name:'Scyther',types:['bug','flying'],w:3},{id:127,name:'Pinsir',types:['bug'],w:3},
  {id:130,name:'Gyarados',types:['water','flying'],w:2},{id:143,name:'Snorlax',types:['normal'],w:2},
  {id:94,name:'Gengar',types:['ghost','poison'],w:2},{id:106,name:'Hitmonlee',types:['fighting'],w:2},
  {id:107,name:'Hitmonchan',types:['fighting'],w:2},{id:113,name:'Chansey',types:['normal'],w:2},
  {id:131,name:'Lapras',types:['water','ice'],w:2},{id:149,name:'Dragonite',types:['dragon','flying'],w:1},
  {id:144,name:'Articuno',types:['ice','flying'],w:0.5},{id:145,name:'Zapdos',types:['electric','flying'],w:0.5},
  {id:146,name:'Moltres',types:['fire','flying'],w:0.5},{id:150,name:'Mewtwo',types:['psychic'],w:0.2},
  {id:151,name:'Mew',types:['psychic'],w:0.1},
];

function pickFromPool(pool) {
  const totalW = pool.reduce((s,p)=>s+p.w, 0);
  let r = Math.random() * totalW;
  for(const p of pool) { r -= p.w; if(r <= 0) return p; }
  return pool[0];
}

const EPIC_GACHA_POOL = [
  {id:1,name:'Bulbasaur',types:['grass','poison'],w:10},{id:4,name:'Charmander',types:['fire'],w:10},
  {id:7,name:'Squirtle',types:['water'],w:10},{id:25,name:'Pikachu',types:['electric'],w:9},
  {id:58,name:'Growlithe',types:['fire'],w:8},{id:147,name:'Dratini',types:['dragon'],w:7},
  {id:133,name:'Eevee',types:['normal'],w:8},{id:63,name:'Abra',types:['psychic'],w:7},
  {id:123,name:'Scyther',types:['bug','flying'],w:6},{id:130,name:'Gyarados',types:['water','flying'],w:5},
  {id:143,name:'Snorlax',types:['normal'],w:5},{id:149,name:'Dragonite',types:['dragon','flying'],w:4},
  {id:94,name:'Gengar',types:['ghost','poison'],w:5},{id:65,name:'Alakazam',types:['psychic'],w:4},
  {id:68,name:'Machamp',types:['fighting'],w:4},{id:131,name:'Lapras',types:['water','ice'],w:4},
  {id:113,name:'Chansey',types:['normal'],w:3},{id:144,name:'Articuno',types:['ice','flying'],w:3},
  {id:145,name:'Zapdos',types:['electric','flying'],w:3},{id:146,name:'Moltres',types:['fire','flying'],w:3},
  {id:150,name:'Mewtwo',types:['psychic'],w:1.5},{id:151,name:'Mew',types:['psychic'],w:1},
  {id:249,name:'Lugia',types:['psychic','flying'],w:1.5},{id:250,name:'Ho-Oh',types:['fire','flying'],w:1.5},
  {id:384,name:'Rayquaza',types:['dragon','flying'],w:0.5},
];

function checkAndAnnounceCosmic(pk) {
  if(isCosmic(pk)) {
    addLog(`üåå ${pk.name} is a COSMIC SHINY! (${countSS(pk)} SS IVs!)`, 'log-cosmic');
    toast(`üåå COSMIC SHINY ${pk.name.toUpperCase()}! ${countSS(pk)} perfect IVs!`, 5000);
  }
}

async function doEpicGacha(count) {
  const cost = count === 1 ? 50 : 450;
  if(gameState.gems < cost) { toast('Not enough Gems! üíé'); return; }
  gameState.gems -= cost;
  updateResourceUI();

  const pulls = [];
  for(let i=0; i<count; i++) {
    const chosen = pickFromPool(EPIC_GACHA_POOL);
    const isShiny = Math.random() < 1/64;
    const level = Math.min(175, Math.max(1, Math.floor(gameState.wave * 0.3 + 5)));
    const pk = newPokemonEntry(chosen.id, chosen.name, chosen.types, level, isShiny);
    pk.stats = await fetchPokemonStats(chosen.id);
    pk.statsLoaded = true;
    pk.currentHp = getMaxHp(pk);
    gameState.box.push(pk);
    pulls.push(pk);
    if(isCosmic(pk)) checkAndAnnounceCosmic(pk);
  }

  if(count === 1) showGachaResult(pulls[0]);
  else showGachaResultMulti(pulls);
  renderAll();
}

// ============================================================
// EVENT BOSS - RAYQUAZA Lv.270
// ============================================================

let bossBattleActive = false;
let bossEnemy = null;

async function startEventBoss() {
  if(gameState.gems < 150) { toast('Need 150 üíé Gems to challenge the Boss!'); return; }
  if(gameState.team.length === 0) { toast('You need a team to fight the Boss!'); return; }
  battlePaused = true;
  document.getElementById('auto-btn').textContent = '‚ñ∂ RESUME';
  document.getElementById('modal-title').textContent = 'üêâ RAYQUAZA Lv.270';
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:8px">
      <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/384.png" width="140" height="140" style="image-rendering:pixelated;filter:drop-shadow(0 0 20px rgba(100,255,100,0.6))">
      <div style="margin:10px 0;font-family:'Press Start 2P';font-size:8px;color:#ff9e40">THE SKY TITAN</div>
      <div style="font-size:14px;color:var(--text2);margin-bottom:12px">
        An ancient dragon slumbering above the clouds.<br>Only the strongest trainers can defeat it.<br><br>
        <span style="color:#ffd700">Drop: Rayquaza (1/25 shiny!)</span><br>
        <span style="color:var(--text2)">Cost: 150 üíé</span>
      </div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn" style="border-color:#ff6d00;color:#ff9e40" onclick="confirmStartBoss()">‚öîÔ∏è Fight! (150üíé)</button>
        <button class="btn gold" onclick="closeModal()">Back</button>
      </div>
    </div>
  `;
  openModal();
}

async function confirmStartBoss() {
  if(gameState.gems < 150) { toast('Not enough Gems!'); closeModal(); return; }
  gameState.gems -= 150;
  updateResourceUI();
  closeModal();
  battlePaused = true;
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;
  currentEnemy = null;
  const savedRoad = { ...gameState.road };
  gameState.road.active = false;
  document.getElementById('arena').classList.remove('road-mode');
  const rayquazaStats = await fetchPokemonStats(384);
  bossEnemy = newPokemonEntry(384, 'Rayquaza', ['dragon','flying'], 270, false);
  bossEnemy.stats = rayquazaStats;
  bossEnemy.statsLoaded = true;
  const baseHp = getMaxHp(bossEnemy);
  bossEnemy._bossHpMax = Math.floor(baseHp * 10);
  bossEnemy.currentHp = bossEnemy._bossHpMax;
  bossEnemy.isBoss = true;
  bossEnemy._savedRoad = savedRoad;
  bossEnemy._attackMult = 0.7;
  currentEnemy = bossEnemy;
  bossBattleActive = true;
  gameState.team.forEach(p => { if(p.statsLoaded) p.currentHp = getMaxHp(p); });
  document.getElementById('arena').style.background = 'radial-gradient(ellipse at 50% 0%, rgba(0,200,50,0.3) 0%, transparent 60%), linear-gradient(180deg, #000a00 0%, #001500 40%, #002000 100%)';
  addLog('üêâ RAYQUAZA descended from the sky!', 'log-evolve');
  toast('üêâ BOSS FIGHT: Rayquaza Lv.270! Full power!', 4000);
  battlePaused = false;
  updateEnemyUI();
}

function handleBossDefeated(player) {
  const savedRoad = bossEnemy?._savedRoad;
  bossBattleActive = false;
  currentEnemy = null;
  bossEnemy = null;
  document.getElementById('arena').style.background = '';
  if(savedRoad && savedRoad.active) { gameState.road = savedRoad; document.getElementById('arena').classList.add('road-mode'); }
  addLog('üéâ RAYQUAZA DEFEATED! You captured it!', 'log-evolve');
  toast('üèÜ RAYQUAZA CAPTURED!', 5000);
  const isShiny = Math.random() < 1/25;
  const rq = newPokemonEntry(384, 'Rayquaza', ['dragon','flying'], 270, isShiny);
  rq.ivs = generateHighIVs();
  fetchPokemonStats(384).then(stats => {
    rq.stats = stats;
    rq.statsLoaded = true;
    rq.currentHp = getMaxHp(rq);
    gameState.box.push(rq);
    checkAndAnnounceCosmic(rq);
    renderAll();
    showGachaResult(rq);
  });
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;
  const nextSpawn = (savedRoad && savedRoad.active) ? (savedRoad.mode === 'farm' ? spawnFarmEnemy : spawnRoadEnemy) : spawnEnemy;
  setTimeout(nextSpawn, 2000);
}

function handleBossFailed() {
  const savedRoad = bossEnemy?._savedRoad;
  bossBattleActive = false;
  currentEnemy = null;
  bossEnemy = null;
  document.getElementById('arena').style.background = '';
  if(savedRoad && savedRoad.active) { gameState.road = savedRoad; document.getElementById('arena').classList.add('road-mode'); }
  addLog('üíÄ RAYQUAZA DESTROYED YOUR TEAM! You fled!', 'log-dmg');
  toast('üíÄ Rayquaza wiped your team!', 5000);
  gameState.team.forEach(p => { p.currentHp = Math.max(1, Math.floor(getMaxHp(p)*0.25)); });
  gameState.currentFighterIdx = 0;
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;
  renderAll();
  const nextSpawn = (savedRoad && savedRoad.active) ? (savedRoad.mode === 'farm' ? spawnFarmEnemy : spawnRoadEnemy) : spawnEnemy;
  setTimeout(nextSpawn, 2500);
}

// ============================================================
// VICTORY ROAD
// ============================================================

const VICTORY_ROAD_POOL = [
  {id:445,name:'Garchomp',types:['dragon','ground'],w:10},
  {id:983,name:'Kingambit',types:['dark','steel'],w:10},
  {id:149,name:'Dragonite',types:['dragon','flying'],w:8},
  {id:248,name:'Tyranitar',types:['rock','dark'],w:8},
  {id:260,name:'Swampert',types:['water','ground'],w:7},
  {id:373,name:'Salamence',types:['dragon','flying'],w:6},
  {id:376,name:'Metagross',types:['steel','psychic'],w:6},
  {id:466,name:'Electivire',types:['electric'],w:5},
  {id:467,name:'Magmortar',types:['fire'],w:5},
  {id:635,name:'Hydreigon',types:['dark','dragon'],w:3},
  {id:706,name:'Goodra',types:['dragon'],w:3},
];

const VR_FIXED_LEVEL = 265;
let vrBattleActive = false;
let vrEnemy = null;

function startVictoryRoad() {
  if(gameState.gems < 80) { toast('Need 80 üíé Gems to enter Victory Road!'); return; }
  if(gameState.team.length === 0) { toast('You need a team!'); return; }
  battlePaused = true;
  document.getElementById('auto-btn').textContent = '‚ñ∂ RESUME';
  const chosen = pickFromPool(VICTORY_ROAD_POOL);
  document.getElementById('modal-title').textContent = '‚õ∞Ô∏è VICTORY ROAD Lv.265';
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:8px">
      <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${chosen.id}.png" width="120" height="120" style="image-rendering:pixelated;filter:drop-shadow(0 0 14px rgba(255,180,0,0.5))">
      <div style="margin:10px 0;font-family:'Press Start 2P';font-size:8px;color:#ffd700">VICTORY ROAD CHALLENGER</div>
      <div style="font-size:22px;color:var(--gold);margin-bottom:4px">${chosen.name} <span style="color:var(--text2);font-size:16px">Lv.${VR_FIXED_LEVEL}</span></div>
      <div style="display:flex;gap:4px;justify-content:center;margin-bottom:10px">
        ${chosen.types.map(t=>`<span class="type-badge" style="background:${TYPE_COLORS[t]}">${t}</span>`).join('')}
      </div>
      <div style="font-size:14px;color:var(--text2);margin-bottom:12px">
        <span style="color:var(--gold)">Capture chance: ~30% ¬∑ Shiny: 1/50</span><br>
        <span style="color:var(--text2)">Cost: 80 üíé ¬∑ Level stays at ${VR_FIXED_LEVEL}</span>
      </div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn" style="border-color:#ffd700;color:#ffd700" onclick="confirmVictoryRoad(${chosen.id},'${chosen.name}','${chosen.types.join(',')}')">‚öîÔ∏è Fight! (80üíé)</button>
        <button class="btn gold" onclick="closeModal()">Back</button>
      </div>
    </div>
  `;
  openModal();
}

async function confirmVictoryRoad(id, name, typesStr) {
  if(gameState.gems < 80) { toast('Not enough Gems!'); closeModal(); return; }
  gameState.gems -= 80;
  updateResourceUI();
  closeModal();
  battlePaused = true;
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;
  currentEnemy = null;
  const savedRoad = { ...gameState.road };
  gameState.road.active = false;
  document.getElementById('arena').classList.remove('road-mode');
  const types = typesStr.split(',');
  const stats = await fetchPokemonStats(id);
  vrEnemy = newPokemonEntry(id, name, types, VR_FIXED_LEVEL, false);
  vrEnemy.stats = stats;
  vrEnemy.statsLoaded = true;
  vrEnemy._vrSavedRoad = savedRoad;
  vrEnemy._isVR = true;
  vrEnemy._attackMult = 0.55;
  const baseHp = getMaxHp(vrEnemy);
  vrEnemy._bossHpMax = Math.floor(baseHp * 2.5);
  vrEnemy.currentHp = vrEnemy._bossHpMax;
  vrEnemy.isBoss = true;
  currentEnemy = vrEnemy;
  vrBattleActive = true;
  bossBattleActive = true;
  gameState.team.forEach(p => { if(p.statsLoaded) p.currentHp = getMaxHp(p); });
  document.getElementById('arena').style.background = 'radial-gradient(ellipse at 30% 60%, rgba(150,80,0,0.4) 0%, transparent 50%), linear-gradient(180deg, #0a0500 0%, #1a0f00 40%, #100800 100%)';
  addLog(`‚õ∞Ô∏è Victory Road: ${name} (Lv.${VR_FIXED_LEVEL}) appeared!`, 'log-evolve');
  toast(`‚õ∞Ô∏è VICTORY ROAD: ${name} Lv.${VR_FIXED_LEVEL}!`, 3000);
  battlePaused = false;
  updateEnemyUI();
}

function handleVRDefeated(player) {
  const savedRoad = vrEnemy?._vrSavedRoad;
  vrBattleActive = false;
  bossBattleActive = false;
  const defeatedMon = vrEnemy;
  currentEnemy = null;
  vrEnemy = null;
  document.getElementById('arena').style.background = '';
  if(savedRoad && savedRoad.active) { gameState.road = savedRoad; document.getElementById('arena').classList.add('road-mode'); }
  addLog(`üèÜ ${defeatedMon.name} was defeated on Victory Road!`, 'log-evolve');
  const captureChance = 0.30;
  const canCapture = Math.random() < captureChance;
  const isShiny = Math.random() < 1/50;
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;
  showVRCaptureCutscene(defeatedMon, canCapture, isShiny, savedRoad);
}

function showVRCaptureCutscene(mon, canCapture, isShiny, savedRoad) {
  const overlay = document.getElementById('capture-overlay');
  const title = document.getElementById('capture-title');
  const spriteEl = document.getElementById('capture-sprite');
  const textEl = document.getElementById('capture-text');
  const btnsEl = document.getElementById('capture-btns');
  title.textContent = canCapture ? '‚õ∞Ô∏è CAPTURE POSSIBLE!' : '‚õ∞Ô∏è VICTORY ROAD CLEAR!';
  title.style.color = canCapture ? '#ffd700' : '#66bb6a';
  const spriteUrl = isShiny
    ? `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${mon.id}.png`
    : `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${mon.id}.png`;
  spriteEl.innerHTML = `<img src="${spriteUrl}" width="110" height="110" style="image-rendering:pixelated;${isShiny?'filter:drop-shadow(0 0 16px rgba(255,215,0,1)) drop-shadow(0 0 24px rgba(255,100,200,0.8))':''}">`;
  if(canCapture) {
    textEl.innerHTML = `<div style="font-size:18px;color:var(--gold);margin-bottom:4px">${isShiny?'‚ú® SHINY ':''}<b>${mon.name}</b></div><div style="color:var(--text2);margin-bottom:4px">Lv.${VR_FIXED_LEVEL} wants to join!</div>`;
    btnsEl.innerHTML = `<button class="btn gold" onclick="captureVRPokemon(${mon.id},'${mon.name}','${mon.types.join(',')}',${isShiny})">üéØ Capture!</button><button class="btn" onclick="skipVRCapture()">Pass</button>`;
  } else {
    textEl.innerHTML = `<div style="font-size:18px;color:var(--gold);margin-bottom:4px"><b>${mon.name}</b> fled!</div>`;
    btnsEl.innerHTML = `<button class="btn gold" style="width:100%" onclick="skipVRCapture()">Continue</button>`;
  }
  overlay.classList.add('active');
}

async function captureVRPokemon(id, name, typesStr, isShiny) {
  document.getElementById('capture-overlay').classList.remove('active');
  const types = typesStr.split(',');
  const pk = newPokemonEntry(id, name, types, VR_FIXED_LEVEL, isShiny);
  pk.ivs = generateHighIVs();
  pk.stats = await fetchPokemonStats(id);
  pk.statsLoaded = true;
  pk.currentHp = getMaxHp(pk);
  gameState.box.push(pk);
  checkAndAnnounceCosmic(pk);
  addLog(`${isShiny?'‚ú® SHINY ':''} ${name} captured from Victory Road!`, isShiny ? 'log-shiny' : 'log-evolve');
  toast(`${isShiny?'‚ú® SHINY ':''} ${name} captured!`, 4000);
  renderAll();
  showGachaResult(pk);
  setTimeout(() => {
    const savedRoad = { ...gameState.road };
    const nextSpawn = savedRoad.active ? (savedRoad.mode === 'farm' ? spawnFarmEnemy : spawnRoadEnemy) : spawnEnemy;
    nextSpawn();
  }, 500);
}

function skipVRCapture() {
  document.getElementById('capture-overlay').classList.remove('active');
  const savedRoad = { ...gameState.road };
  const nextSpawn = savedRoad.active ? (savedRoad.mode === 'farm' ? spawnFarmEnemy : spawnRoadEnemy) : spawnEnemy;
  setTimeout(nextSpawn, 600);
  renderAll();
}

function handleVRFailed() {
  const savedRoad = vrEnemy?._vrSavedRoad;
  vrBattleActive = false;
  bossBattleActive = false;
  currentEnemy = null;
  vrEnemy = null;
  document.getElementById('arena').style.background = '';
  if(savedRoad && savedRoad.active) { gameState.road = savedRoad; document.getElementById('arena').classList.add('road-mode'); }
  addLog('üíÄ Victory Road challenger wiped your team!', 'log-dmg');
  toast('üíÄ Defeated on Victory Road!', 4000);
  gameState.team.forEach(p => { p.currentHp = Math.max(1, Math.floor(getMaxHp(p)*0.25)); });
  gameState.currentFighterIdx = 0;
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;
  renderAll();
  const nextSpawn = (savedRoad && savedRoad.active) ? (savedRoad.mode === 'farm' ? spawnFarmEnemy : spawnRoadEnemy) : spawnEnemy;
  setTimeout(nextSpawn, 2500);
}

async function doPokemonGacha(count) {
  const cost = count === 1 ? 5 : 40;
  if(gameState.gems < cost) { toast('Not enough Gems! üíé'); return; }
  gameState.gems -= cost;
  updateResourceUI();
  const pulls = [];
  for(let i=0; i<count; i++) {
    const chosen = pickFromPool(GACHA_POOL);
    const isShiny = Math.random() < 1/512;
    const level = Math.min(175, Math.max(1, Math.floor(gameState.wave * 0.3 + 2)));
    const pk = newPokemonEntry(chosen.id, chosen.name, chosen.types, level, isShiny);
    pk.stats = await fetchPokemonStats(chosen.id);
    pk.statsLoaded = true;
    pk.currentHp = getMaxHp(pk);
    gameState.box.push(pk);
    pulls.push(pk);
    if(isCosmic(pk)) checkAndAnnounceCosmic(pk);
  }
  if(count === 1) showGachaResult(pulls[0]);
  else showGachaResultMulti(pulls);
  renderAll();
}

async function doItemGacha(count) {
  const cost = count === 1 ? 200 : 1800;
  if(gameState.gold < cost) { toast('Not enough Gold! üí∞'); return; }
  gameState.gold -= cost;
  updateResourceUI();
  const gotten = [];
  for(let i=0; i<count; i++) {
    const isRareCandy = Math.random() < 0.30;
    const item = isRareCandy ? EPIC_ITEMS.find(i=>i.id==='rare_candy') : ITEMS[Math.floor(Math.random()*ITEMS.length)];
    gameState.inventory[item.id] = (gameState.inventory[item.id] || 0) + 1;
    gotten.push(item);
  }
  const unique = [...new Set(gotten.map(i=>i.name))];
  toast(`Got items: ${unique.join(', ')}!`);
  renderAll();
  if(count === 1) showItemGachaResult(gotten[0]);
}

async function doEpicItemGacha(count) {
  const cost = count === 1 ? 5000 : 40000;
  if(gameState.gold < cost) { toast(`Need ${formatNum(cost)} üí∞ Gold!`); return; }
  gameState.gold -= cost;
  updateResourceUI();
  const gotten = [];
  for(let i=0; i<count; i++) {
    const roll = Math.random();
    let item;
    let wasEpic = false;
    if(roll < 0.01) {
      // 1% Max Candy
      item = EPIC_ITEMS.find(e=>e.id==='max_candy');
      wasEpic = true;
    } else if(roll < 0.36) {
      // ~35% epic roll
      wasEpic = true;
      item = Math.random() < 0.60 ? EPIC_ITEMS.find(e=>e.id==='rare_candy') : EPIC_ITEMS[Math.floor(Math.random()*EPIC_ITEMS.length)];
      // make sure we don't accidentally give max_candy via random index here
      if(item.id === 'max_candy') item = EPIC_ITEMS.find(e=>e.id==='rare_candy');
    } else {
      item = ITEMS[Math.floor(Math.random()*ITEMS.length)];
    }
    gameState.inventory[item.id] = (gameState.inventory[item.id] || 0) + 1;
    gotten.push({...item, wasEpic});
  }
  const unique = [...new Set(gotten.map(i=>i.name))];
  toast(`üí† Items: ${unique.join(', ')}!`, 4000);
  renderAll();
  if(count === 1) showItemGachaResult(gotten[0]);
  else {
    document.getElementById('modal-title').textContent = 'üí† Items Received!';
    document.getElementById('modal-content').innerHTML = `
      <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:8px">
        ${gotten.map(item=>`<div style="text-align:center;background:${item.id==='max_candy'?'rgba(255,105,180,0.15)':item.wasEpic?'rgba(200,0,255,0.1)':'rgba(255,255,255,0.04)'};border:1px solid ${item.id==='max_candy'?'#ff69b4':item.wasEpic?'#e040fb':'var(--border)'};border-radius:8px;padding:10px;width:90px">
          <div style="font-size:36px">${item.emoji}</div>
          <div style="font-family:'Press Start 2P';font-size:6px;color:${item.id==='max_candy'?'#ff69b4':item.wasEpic?'#e040fb':'var(--gold)'};margin-top:4px">${item.name}</div>
          ${item.id==='max_candy'?'<div style="font-size:10px;color:#ff69b4">ULTRA RARE!</div>':item.wasEpic?'<div style="font-size:10px;color:#e040fb">EPIC!</div>':''}
        </div>`).join('')}
      </div>
      <button class="btn" onclick="closeModal()" style="width:100%;margin-top:12px">Nice haul!</button>
    `;
    openModal();
  }
}

async function doShinyGacha() {
  const cost = 450;
  if(gameState.gems < cost) { toast(`Need ${cost} üíé Gems!`); return; }
  gameState.gems -= cost;
  updateResourceUI();
  const chosen = pickFromPool(EPIC_GACHA_POOL);
  const level = Math.min(175, Math.max(1, Math.floor(gameState.wave * 0.3 + 5)));
  const pk = newPokemonEntry(chosen.id, chosen.name, chosen.types, level, true);
  pk.stats = await fetchPokemonStats(chosen.id);
  pk.statsLoaded = true;
  pk.currentHp = getMaxHp(pk);
  gameState.box.push(pk);
  checkAndAnnounceCosmic(pk);
  addLog(`‚ú® SHINY ${chosen.name} obtained from Shiny Gacha!`, 'log-shiny');
  showGachaResult(pk);
  renderAll();
}

// ============================================================
// BOX SORT
// ============================================================

let boxSortMode = 'default';
let boxSortAsc = true;

function sortBox(mode) {
  if(boxSortMode === mode) boxSortAsc = !boxSortAsc;
  else { boxSortMode = mode; boxSortAsc = mode !== 'level'; }
  renderPokemonBox();
  toast(`Sorted by: ${mode}`);
}

function getBoxSorted() {
  const arr = [...gameState.box];
  const dir = boxSortAsc ? 1 : -1;
  switch(boxSortMode) {
    case 'level': return arr.sort((a,b)=>dir*(b.level-a.level));
    case 'name': return arr.sort((a,b)=>dir*a.name.localeCompare(b.name));
    case 'shiny': return arr.sort((a,b)=>{
      if(isCosmic(a) && !isCosmic(b)) return -1;
      if(!isCosmic(a) && isCosmic(b)) return 1;
      if(a.isShiny && !b.isShiny) return -1;
      if(!a.isShiny && b.isShiny) return 1;
      return b.level-a.level;
    });
    case 'type': return arr.sort((a,b)=>dir*a.types[0].localeCompare(b.types[0]));
    case 'stats': return arr.sort((a,b)=>{
      const gradeOrder = {'SS':7,'S':6,'A':5,'B':4,'C':3,'D':2,'F':1};
      const overallGrade = p => {
        const ivs = p.ivs || {};
        const vals = Object.values(ivs);
        if(!vals.length) return 0;
        const avg = vals.reduce((s,v)=>s+v,0) / vals.length;
        return gradeOrder[getStatGrade(Math.round(avg)).label] || 0;
      };
      const diff = (overallGrade(b) - overallGrade(a)) * dir;
      if(diff !== 0) return diff;
      const sumIVs = p => Object.values(p.ivs||{}).reduce((s,v)=>s+v,0);
      return (sumIVs(b) - sumIVs(a)) * dir;
    });
    case 'team': return arr.sort((a,b)=>{
      const aInTeam = gameState.team.includes(a) ? 0 : 1;
      const bInTeam = gameState.team.includes(b) ? 0 : 1;
      if(aInTeam !== bInTeam) return aInTeam - bInTeam;
      return b.level - a.level;
    });
    default: return arr;
  }
}

function doDaily() {
  const now = Date.now();
  if(gameState.dailyClaimed && now - gameState.lastDaily < 86400000) { toast('Daily already claimed! Come back tomorrow.'); return; }
  gameState.lastDaily = now;
  gameState.dailyClaimed = true;
  gameState.gems += 3;
  gameState.gold += 300;
  toast('üéÅ Daily claimed! +3 üíé +300 üí∞');
  document.getElementById('daily-btn').textContent = 'CLAIMED ‚úì';
  updateResourceUI();
  doPokemonGacha(1).then(()=>{ gameState.gems += 5; });
}

// ============================================================
// MODALS
// ============================================================

function showGachaResult(pk) {
  const cosmic = isCosmic(pk);
  document.getElementById('modal-title').textContent = cosmic ? 'üåå COSMIC SHINY POK√âMON!' : pk.isShiny ? '‚ú® SHINY POK√âMON!' : 'New Pok√©mon!';
  if(cosmic) document.getElementById('modal-title').style.cssText = 'font-family:"Press Start 2P",monospace;font-size:10px;background:linear-gradient(90deg,#00ffff,#bf00ff,#ff00aa,#00ffff);background-size:300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:16px;animation:shimmer 1.5s linear infinite';
  else document.getElementById('modal-title').style.cssText = '';

  document.getElementById('modal-content').innerHTML = `
    <div class="gacha-result ${cosmic ? 'is-cosmic' : pk.isShiny ? 'is-shiny' : ''}">
      <img src="${getSpriteUrl(pk.id, pk.isShiny)}" width="120" height="120" onerror="this.src='${getBattleSprite(pk.id,pk.isShiny)}'">
      ${cosmic ? `<div class="cosmic-text" style="font-size:12px">üåå COSMIC SHINY üåå</div>` : pk.isShiny ? '<div class="shiny-text">‚≠ê SHINY ‚≠ê</div>' : ''}
      ${cosmic ? `<div style="font-size:12px;color:#4fc3f7">${countSS(pk)} PERFECT IVs!</div>` : ''}
      <div style="font-family:'Press Start 2P';font-size:10px;color:var(--gold)">${pk.name}</div>
      <div style="font-size:15px;color:var(--text2)">Lv.${pk.level}</div>
      <div style="display:flex;gap:6px">
        ${pk.types.map(t=>`<span class="type-badge" style="background:${TYPE_COLORS[t]}">${t}</span>`).join('')}
      </div>
      ${pk.stats ? renderMiniStats(pk) : ''}
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn gold" onclick="addToTeam(${pk.uid});closeModal()">Add to Team</button>
        <button class="btn" onclick="closeModal()">Keep in Box</button>
      </div>
    </div>
  `;
  openModal();
}

function showGachaResultMulti(pulls) {
  const hasShiny = pulls.some(p=>p.isShiny);
  const hasCosmic = pulls.some(p=>isCosmic(p));
  document.getElementById('modal-title').textContent = hasCosmic ? 'üåå COSMIC FOUND!' : hasShiny ? '‚ú® MULTI PULL RESULTS!' : 'Pull Results!';
  const grid = pulls.map(pk => {
    const cosmic = isCosmic(pk);
    return `<div class="poke-card ${cosmic ? 'cosmic-card' : pk.isShiny ? 'shiny-card' : ''}" style="cursor:default">
      ${cosmic ? '<div style="position:absolute;top:3px;right:4px">üåå</div>' : pk.isShiny ? '<div style="position:absolute;top:3px;right:4px">‚òÖ</div>' : ''}
      <img src="${getSpriteUrl(pk.id,pk.isShiny)}" width="56" height="56" onerror="this.src='${getBattleSprite(pk.id,pk.isShiny)}'">
      <span class="cname">${pk.name}</span>
      <span class="clevel">Lv.${pk.level}</span>
      ${cosmic ? '<div class="cosmic-text" style="font-size:8px">COSMIC</div>' : pk.isShiny ? '<div class="shiny-text" style="font-size:9px">SHINY</div>' : ''}
    </div>`;
  }).join('');
  document.getElementById('modal-content').innerHTML = `<div class="poke-box">${grid}</div><button class="btn" onclick="closeModal()" style="width:100%;margin-top:12px">Close</button>`;
  openModal();
}

function showPokemonModal(pk) {
  const maxHp = getMaxHp(pk);
  const equippedItem = ITEMS.concat(EPIC_ITEMS).find(i=>i.id===gameState.equippedItems[pk.uid]);
  const evo = EVOLUTIONS[pk.id];
  const inTeam = gameState.team.includes(pk);
  const cosmic = isCosmic(pk);

  document.getElementById('modal-title').textContent = (cosmic ? 'üåå ' : pk.isShiny ? '‚òÖ ' : '') + pk.name.toUpperCase();
  document.getElementById('modal-title').style.cssText = cosmic ? 'font-family:"Press Start 2P",monospace;font-size:10px;background:linear-gradient(90deg,#00ffff,#bf00ff,#ff00aa,#00ffff);background-size:300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:16px;animation:shimmer 1.5s linear infinite' : '';

  document.getElementById('modal-content').innerHTML = `
    <div style="display:flex;gap:16px;align-items:center;margin-bottom:12px">
      <img src="${getSpriteUrl(pk.id,pk.isShiny)}" width="100" height="100" class="${cosmic ? 'cosmic-sprite' : pk.isShiny ? 'shiny-sprite' : ''}" onerror="this.src='${getBattleSprite(pk.id,pk.isShiny)}'">
      <div>
        ${cosmic ? '<div class="cosmic-text" style="font-size:11px">üåå COSMIC SHINY üåå</div>' : pk.isShiny ? '<div class="shiny-text">‚ú® SHINY ‚ú®</div>' : ''}
        ${cosmic ? `<div style="font-size:13px;color:#4fc3f7;margin-bottom:4px">${countSS(pk)}/6 Perfect IVs</div>` : ''}
        <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px">${pk.types.map(t=>`<span class="type-badge" style="background:${TYPE_COLORS[t]}">${t}</span>`).join('')}</div>
        <div style="font-size:15px;color:var(--text2)">Level ${pk.level} / 250</div>
        <div style="font-size:15px;color:var(--text2)">HP: ${Math.max(0,pk.currentHp)} / ${maxHp}</div>
        <div style="font-size:14px;color:var(--text2)">EXP: ${pk.exp} / ${pk.expToNext}</div>
        <div style="font-size:13px;color:var(--text2)">OT: <span style="color:var(--gold)">${pk.ot || 'Unknown'}</span></div>
        ${evo ? `<div style="font-size:13px;color:var(--accent);margin-top:4px">‚Üí Evolves into ${evo.name} at Lv.${evo.level}</div>` : ''}
        ${equippedItem ? `<div style="margin-top:4px">Held: ${equippedItem.emoji} ${equippedItem.name}</div>` : ''}
      </div>
    </div>
    ${pk.stats ? renderMiniStats(pk) : ''}
    <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap">
      ${!inTeam ? `<button class="btn gold" onclick="addToTeam(${pk.uid});closeModal()">Add to Team</button>` : `<button class="btn" onclick="removeFromTeamByUid(${pk.uid});closeModal()">Remove</button>`}
      <button class="btn" onclick="openEquipModal(${pk.uid})">Equip Item</button>
      ${equippedItem ? `<button class="btn" onclick="unequipItem(${pk.uid});closeModal()">Unequip</button>` : ''}
      <button class="btn" style="border-color:#00c853;color:#69f0ae" onclick="openTradeForPokemon(${pk.uid});closeModal()">üîÑ Trade</button>
      <button class="btn" style="border-color:#ef5350;color:#ef5350" onclick="confirmRelease(${pk.uid})">Release üïäÔ∏è</button>
    </div>
  `;
  openModal();
}

function showPokemonInfoCard(pk) {
  const maxHp = getMaxHp(pk);
  const equippedItem = ITEMS.concat(EPIC_ITEMS).find(i=>i.id===gameState.equippedItems[pk.uid]);
  const evo = EVOLUTIONS[pk.id];
  const cosmic = isCosmic(pk);

  document.getElementById('modal-title').textContent = `üìä ${cosmic ? 'üåå ' : pk.isShiny ? '‚òÖ ' : ''}${pk.name.toUpperCase()} ‚Äî Stats`;
  document.getElementById('modal-content').innerHTML = `
    <div style="display:flex;gap:16px;align-items:center;margin-bottom:12px">
      <img src="${getSpriteUrl(pk.id,pk.isShiny)}" width="96" height="96" class="${cosmic ? 'cosmic-sprite' : pk.isShiny ? 'shiny-sprite' : ''}" onerror="this.src='${getBattleSprite(pk.id,pk.isShiny)}'">
      <div>
        ${cosmic ? '<div class="cosmic-text" style="font-size:10px">üåå COSMIC SHINY</div>' : pk.isShiny ? '<div class="shiny-text">‚ú® SHINY ‚ú®</div>' : ''}
        ${cosmic ? `<div style="font-size:12px;color:#4fc3f7">${countSS(pk)}/6 perfect IVs</div>` : ''}
        <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px">${pk.types.map(t=>`<span class="type-badge" style="background:${TYPE_COLORS[t]}">${t}</span>`).join('')}</div>
        <div style="font-size:16px;color:var(--gold)">Lv. ${pk.level}</div>
        <div style="font-size:14px;color:var(--text2)">HP: ${Math.max(0,pk.currentHp)} / ${maxHp}</div>
        ${evo ? `<div style="font-size:13px;color:var(--accent)">‚Üí ${evo.name} @ Lv.${evo.level}</div>` : ''}
        ${equippedItem ? `<div style="font-size:14px;margin-top:4px">${equippedItem.emoji} <span style="color:var(--gold)">${equippedItem.name}</span></div>` : ''}
      </div>
    </div>
    ${pk.stats ? renderMiniStats(pk) : '<div style="color:var(--text2);font-size:13px">Stats not yet loaded</div>'}
    <button class="btn gold" onclick="closeModal()" style="width:100%;margin-top:14px">Close</button>
  `;
  openModal();
}

function renderMiniStats(pk) {
  if(!pk.stats) return '';
  const statNames = {hp:'HP',attack:'ATK',defense:'DEF','special-attack':'SpA','special-defense':'SpD',speed:'SPD'};
  const statColors = {hp:'#ef5350',attack:'#ff9e40',defense:'#4fc3f7','special-attack':'#ab47bc','special-defense':'#66bb6a',speed:'#ffd700'};
  const maxBase = 255;
  const ivs = pk.ivs || {};
  const totalIV = Object.values(ivs).reduce((a,b)=>a+b,0);
  const maxIV = 31 * 6;
  const overallPct = Math.round((totalIV / maxIV) * 100);
  const overallGrade = getStatGrade(Math.round((totalIV/6)));
  const cosmic = isCosmic(pk);

  let html = `<div style="background:rgba(0,0,0,0.3);border:1px solid ${cosmic ? 'rgba(0,255,255,0.3)' : 'rgba(255,255,255,0.1)'};border-radius:8px;padding:10px 12px;margin-bottom:6px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-family:'Press Start 2P';font-size:7px;color:var(--text2)">STATS & IVs</div>
      <div style="display:flex;align-items:center;gap:6px">
        <span style="font-size:12px;color:var(--text2)">Overall:</span>
        ${overallGrade.isSS ? `<span class="ss-rainbow" style="font-size:9px">${overallGrade.label}</span>` : `<span style="font-family:'Press Start 2P';font-size:9px;color:${overallGrade.color}">${overallGrade.label}</span>`}
        <span style="font-size:11px;color:var(--text2)">(${overallPct}%)</span>
      </div>
    </div>`;

  pk.stats.forEach(s => {
    const name = statNames[s.stat.name] || s.stat.name;
    const iv = ivs[s.stat.name] ?? 15;
    const grade = getStatGrade(iv);
    const effective = Math.floor(((s.base_stat * 2 + iv) * pk.level / 100) + (s.stat.name==='hp' ? pk.level+10 : 5));
    const pct = Math.min(100, (s.base_stat / maxBase) * 100);
    const ivPct = Math.round((iv / 31) * 100);
    const barColor = statColors[s.stat.name] || 'var(--accent)';
    html += `<div style="display:flex;align-items:center;gap:6px;margin-bottom:5px">
      <div style="width:32px;font-size:12px;color:var(--text2);flex-shrink:0">${name}</div>
      <div style="flex:1;height:8px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;position:relative">
        <div style="height:100%;border-radius:4px;background:${barColor};width:${pct}%;opacity:0.5"></div>
        <div style="position:absolute;top:0;left:0;height:100%;border-radius:4px;background:${barColor};width:${ivPct}%;opacity:0.9"></div>
      </div>
      <div style="width:36px;text-align:right;font-size:14px;color:var(--gold);flex-shrink:0">${effective}</div>
      <div style="width:22px;text-align:center;font-family:'Press Start 2P';font-size:7px;flex-shrink:0;line-height:1.6;padding-top:2px">
        ${grade.isSS ? `<span class="${cosmic ? 'cosmic-text' : 'ss-rainbow'}" style="display:inline-block;line-height:1.4;padding-top:2px">${grade.label}</span>` : `<span style="color:${grade.color};display:inline-block;line-height:1.4">${grade.label}</span>`}
      </div>
    </div>`;
  });
  html += '</div>';
  return html;
}

function showItemModal(item) {
  if(item.effect === 'rare_candy' || item.effect === 'max_candy') {
    const isMax = item.effect === 'max_candy';
    const capLevel = isMax ? 250 : 175;
    const count = gameState.inventory[item.id] || 0;
    document.getElementById('modal-title').textContent = isMax ? `üç≠ Max Candy ‚Äî Pick Pok√©mon` : `üç¨ Rare Candy ‚Äî Pick Pok√©mon`;
    document.getElementById('modal-content').innerHTML = `
      <div style="font-size:14px;color:var(--text2);margin-bottom:4px">${item.desc}</div>
      ${!isMax ? `<div style="font-size:13px;color:#ff9e40;margin-bottom:6px">‚ö†Ô∏è Only works up to <b style="color:#ffd700">Lv.175</b>! Use Max Candy üç≠ for higher levels.</div>` : `<div style="font-size:13px;color:#69f0ae;margin-bottom:6px">‚úÖ Works on any Pok√©mon up to Lv.250!</div>`}
      <div style="font-size:14px;margin-bottom:8px">In Bag: <span style="color:var(--gold)">√ó${count}</span></div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.3);border-radius:8px;padding:8px 12px">
        <div style="font-size:13px;color:var(--text2)">Amount:</div>
        <button onclick="adjustCandyAmt(-1,'${item.id}')" style="background:rgba(255,255,255,0.08);border:1px solid var(--border);color:var(--text);width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:18px">-</button>
        <span id="candy-amount" style="font-family:'Press Start 2P';font-size:11px;color:var(--gold);min-width:30px;text-align:center">1</span>
        <button onclick="adjustCandyAmt(1,'${item.id}')" style="background:rgba(255,255,255,0.08);border:1px solid var(--border);color:var(--text);width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:18px">+</button>
        <button onclick="adjustCandyAmt(10,'${item.id}')" style="background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.4);color:var(--gold);padding:3px 8px;border-radius:6px;cursor:pointer;font-size:14px">+10</button>
        <button onclick="setCandyAmtMax('${item.id}')" style="background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.4);color:#ff9e40;padding:3px 8px;border-radius:6px;cursor:pointer;font-size:14px">MAX</button>
      </div>
      <div style="font-family:'Press Start 2P';font-size:7px;color:var(--text2);margin-bottom:8px">GIVE TO ${isMax ? '' : '(Lv.‚â§175 only)'}:</div>
      <div class="poke-box">
        ${gameState.box.map(p=>{
          const blocked = !isMax && p.level >= 175;
          return `<div class="poke-card${blocked?' ':''}${p.isShiny&&!blocked?' shiny-card':''}" onclick="${blocked?'toast(\'Rare Candy only works up to Lv.175! Use Max Candy.\')':'useRareCandyMulti('+p.uid+',\''+item.id+'\')'}" style="cursor:pointer;${blocked?'opacity:0.4;':''}">
            <img src="${getSpriteUrl(p.id,p.isShiny)}" width="52" height="52">
            <span class="cname">${p.name}</span>
            <span class="clevel">Lv.${p.level}${blocked?' üö´':''}</span>
          </div>`;
        }).join('')}
      </div>
    `;
    openModal();
    return;
  }

  document.getElementById('modal-title').textContent = `${item.emoji} ${item.name}`;
  const count = gameState.inventory[item.id] || 0;
  document.getElementById('modal-content').innerHTML = `
    <div style="font-size:15px;color:var(--text2);margin-bottom:12px">${item.desc}</div>
    <div style="font-size:14px;margin-bottom:12px">In Bag: √ó${count}</div>
    <div style="font-family:'Press Start 2P';font-size:8px;color:var(--text2);margin-bottom:8px">EQUIP TO:</div>
    <div class="poke-box">
      ${gameState.box.map(p=>{
        const eq = gameState.equippedItems[p.uid];
        const eqItem = ITEMS.concat(EPIC_ITEMS).find(i=>i.id===eq);
        return `<div class="poke-card" onclick="equipItem('${item.id}',${p.uid});closeModal()" style="cursor:pointer">
          <img src="${getSpriteUrl(p.id,p.isShiny)}" width="52" height="52">
          <span class="cname">${p.name}</span>
          <span class="clevel">Lv.${p.level}</span>
          ${eq ? `<div style="font-size:13px">${eqItem?.emoji||''}</div>` : ''}
        </div>`;
      }).join('')}
    </div>
  `;
  openModal();
}

function getPullTargetLevel() {
  const allLevels = gameState.box.map(p => p.level).filter(l => l <= 250);
  if(allLevels.length === 0) return 5;
  return Math.max(1, Math.max(...allLevels) - 5);
}

function pullToLevel(uid) {
  if(gameState.gems < 25) { toast('Need 25 üíé Gems!'); return; }
  const pk = gameState.box.find(p => p.uid === uid);
  if(!pk) return;
  const targetLevel = getPullTargetLevel();
  if(pk.level >= targetLevel) { toast(`${pk.name} is already at target level!`); return; }
  document.getElementById('modal-title').textContent = '‚¨ÜÔ∏è Pull to Level';
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:8px">
      <div style="display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:16px">
        <img src="${getSpriteUrl(pk.id, pk.isShiny)}" width="80" height="80" onerror="this.src='${getBattleSprite(pk.id,pk.isShiny)}'">
        <div style="text-align:left">
          <div style="font-family:'Press Start 2P';font-size:8px;color:var(--gold)">${pk.name}</div>
          <div style="font-size:15px;color:var(--text2);margin-top:4px">Lv.${pk.level} ‚Üí <span style="color:var(--accent)">Lv.${targetLevel}</span></div>
        </div>
      </div>
      <div style="font-size:15px;color:var(--gold);margin-bottom:14px">Cost: 25 üíé</div>
      <div style="display:flex;gap:10px">
        <button class="btn" style="flex:1;border-color:var(--accent);color:var(--accent)" onclick="confirmPullToLevel(${uid})">‚¨ÜÔ∏è Confirm!</button>
        <button class="btn" style="flex:1" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  `;
  openModal();
}

function confirmPullToLevel(uid) {
  if(gameState.gems < 25) { toast('Not enough Gems!'); closeModal(); return; }
  const pk = gameState.box.find(p => p.uid === uid);
  if(!pk) { closeModal(); return; }
  const targetLevel = getPullTargetLevel();
  if(pk.level >= targetLevel) { closeModal(); return; }
  gameState.gems -= 25;
  const oldLevel = pk.level;
  pk.level = targetLevel;
  pk.expToNext = calcExpToNext(pk.level);
  pk.exp = 0;
  if(pk.stats) pk.currentHp = getMaxHp(pk);
  addLog(`‚¨ÜÔ∏è ${pk.name} pulled Lv.${oldLevel} ‚Üí Lv.${targetLevel}!`, 'log-evolve');
  toast(`‚¨ÜÔ∏è ${pk.name} pulled to Lv.${targetLevel}!`, 3000);
  checkEvolution(pk);
  updateResourceUI();
  renderAll();
  closeModal();
}

let _candyAmount = 1;
let _candyItemId = 'rare_candy';

function adjustCandyAmt(delta, itemId) {
  if(itemId) _candyItemId = itemId;
  const count = gameState.inventory[_candyItemId] || 0;
  _candyAmount = Math.max(1, Math.min(count, _candyAmount + delta));
  const el = document.getElementById('candy-amount');
  if(el) el.textContent = _candyAmount;
}

function setCandyAmtMax(itemId) {
  if(itemId) _candyItemId = itemId;
  _candyAmount = Math.max(1, gameState.inventory[_candyItemId] || 0);
  const el = document.getElementById('candy-amount');
  if(el) el.textContent = _candyAmount;
}

function useRareCandyMulti(uid, itemId) {
  const id = itemId || _candyItemId || 'rare_candy';
  const isMax = id === 'max_candy';
  const capLevel = isMax ? 250 : 175;
  const available = gameState.inventory[id] || 0;
  if(available <= 0) { toast(`No ${isMax ? 'Max Candy' : 'Rare Candy'} left!`); return; }
  const pk = gameState.box.find(p=>p.uid===uid);
  if(!pk) return;
  if(pk.level >= 250) { toast(`${pk.name} is already at max level!`); return; }
  if(!isMax && pk.level >= 175) {
    toast(`üö´ Rare Candy only works up to Lv.175! Use Max Candy üç≠ instead.`, 3500);
    return;
  }
  const maxUsable = Math.min(capLevel, 250) - pk.level;
  const amount = Math.min(_candyAmount, available, maxUsable);
  if(amount <= 0) { toast(`${pk.name} is already at the cap for this candy!`); return; }
  gameState.inventory[id] -= amount;
  const oldLevel = pk.level;
  pk.level = Math.min(capLevel, pk.level + amount);
  pk.expToNext = calcExpToNext(pk.level);
  pk.exp = 0;
  if(pk.stats) pk.currentHp = getMaxHp(pk);
  const emoji = isMax ? 'üç≠' : 'üç¨';
  addLog(`${emoji} √ó${amount} ${isMax?'Max':'Rare'} Candy! ${pk.name} Lv.${oldLevel} ‚Üí Lv.${pk.level}!`, 'log-evolve');
  toast(`${emoji} ${pk.name} ‚Üí Lv.${pk.level}! (√ó${amount} candy)`, 3000);
  checkEvolution(pk);
  _candyAmount = 1;
  closeModal();
  renderAll();
}

function openEquipModal(uid) {
  document.getElementById('modal-title').textContent = 'Equip Item';
  const allItems = ITEMS.concat(EPIC_ITEMS.filter(i=>i.effect !== 'rare_candy'));
  const availableItems = allItems.filter(i=>(gameState.inventory[i.id]||0)>0);
  if(availableItems.length===0) { document.getElementById('modal-content').innerHTML = '<div style="color:var(--text2)">No items in bag!</div>'; return; }
  document.getElementById('modal-content').innerHTML = `
    <div class="item-grid" style="grid-template-columns:repeat(3,1fr)">
      ${availableItems.map(item=>`<div class="item-cell" onclick="equipItem('${item.id}',${uid});closeModal()" title="${item.name}: ${item.desc}" style="width:80px;height:80px;font-size:32px">
        ${item.emoji}<span class="item-count">√ó${gameState.inventory[item.id]}</span>
        <div style="font-size:11px;margin-top:2px;color:var(--text2)">${item.name.substring(0,8)}</div>
      </div>`).join('')}
    </div>
  `;
}

function equipItem(itemId, uid) {
  if(!(gameState.inventory[itemId]>0)) { toast('No more of that item!'); return; }
  const old = gameState.equippedItems[uid];
  if(old) gameState.inventory[old] = (gameState.inventory[old]||0) + 1;
  gameState.equippedItems[uid] = itemId;
  gameState.inventory[itemId]--;
  const item = ITEMS.concat(EPIC_ITEMS).find(i=>i.id===itemId);
  const pokemon = gameState.box.find(p=>p.uid===uid);
  toast(`${item.emoji} ${item.name} equipped to ${pokemon?.name||'Pok√©mon'}!`);
  renderAll();
}

function unequipItem(uid) {
  const old = gameState.equippedItems[uid];
  if(old) { gameState.inventory[old] = (gameState.inventory[old]||0) + 1; delete gameState.equippedItems[uid]; toast('Item unequipped!'); renderAll(); }
}

function showItemGachaResult(item) {
  document.getElementById('modal-title').textContent = 'üéÅ Item Get!';
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:20px">
      <div style="font-size:60px;margin-bottom:12px">${item.emoji}</div>
      <div style="font-family:'Press Start 2P';font-size:10px;color:var(--gold);margin-bottom:8px">${item.name}</div>
      <div style="color:var(--text2);font-size:15px;margin-bottom:16px">${item.desc}</div>
      <button class="btn" onclick="closeModal()" style="width:100%">Nice!</button>
    </div>
  `;
  openModal();
}

function addToTeam(uid) {
  if(gameState.team.length >= 6) { toast('Team is full! (max 6)'); return; }
  const pk = gameState.box.find(p=>p.uid===uid);
  if(!pk) return;
  if(gameState.team.includes(pk)) { toast('Already on team!'); return; }
  gameState.team.push(pk);
  toast(`${pk.name} added to team!`);
  renderAll();
}

function removeFromTeam(idx) {
  if(gameState.team.length <= 1) { toast('Need at least one Pok√©mon!'); return; }
  const pk = gameState.team.splice(idx, 1)[0];
  if(gameState.currentFighterIdx >= gameState.team.length) gameState.currentFighterIdx = 0;
  toast(`${pk.name} returned to box.`);
  renderAll();
}

function removeFromTeamByUid(uid) {
  const idx = gameState.team.findIndex(p=>p.uid===uid);
  if(idx>=0) removeFromTeam(idx);
}

function openModal() { document.getElementById('modal-overlay').classList.add('active'); }

function closeModal(event) {
  if(event && event.target !== document.getElementById('modal-overlay') && event.target !== document.getElementById('modal-close')) return;
  document.getElementById('modal-overlay').classList.remove('active');
  document.getElementById('modal-title').style.cssText = '';
}

// ============================================================
// TABS
// ============================================================

function switchTab(name) {
  const tabs = ['team','box','gacha','items','road'];
  document.querySelectorAll('.tab-btn').forEach((b,i)=>{ b.classList.toggle('active', tabs[i]===name); });
  document.querySelectorAll('.tab-content').forEach(c=>{ c.classList.toggle('active', c.id==='tab-'+name); });
  if(name==='box') renderPokemonBox();
  if(name==='items') renderItems();
  if(name==='road') renderRoadUI();
}

function toggleAuto() {
  battlePaused = !battlePaused;
  document.getElementById('auto-btn').textContent = battlePaused ? '‚ñ∂ RESUME' : '‚è∏ PAUSE';
}

function toast(msg, duration=2500) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(el._timer);
  el._timer = setTimeout(()=>el.classList.remove('show'), duration);
}

// ============================================================
// RELEASE POKEMON
// ============================================================

function confirmRelease(uid) {
  const pk = gameState.box.find(p=>p.uid===uid);
  if(!pk) return;
  if(gameState.box.length <= 1) { toast("Can't release your last Pok√©mon!"); return; }
  document.getElementById('modal-title').textContent = `Release ${pk.name}?`;
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:12px 0">
      <img src="${getSpriteUrl(pk.id,pk.isShiny)}" width="100" height="100" class="${isCosmic(pk)?'cosmic-sprite':pk.isShiny?'shiny-sprite':''}" onerror="this.src='${getBattleSprite(pk.id,pk.isShiny)}'">
      <div style="margin:12px 0;font-size:16px;color:var(--text2)">
        ${isCosmic(pk) ? '<span class="cosmic-text">üåå COSMIC </span>' : pk.isShiny ? '<span class="shiny-text">‚òÖ SHINY </span>' : ''}${pk.name} (Lv.${pk.level}) will be released forever.
      </div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:14px">
        <button class="btn" style="border-color:#ef5350;color:#ef5350;flex:1" onclick="releasePokemon(${uid})">Yes, release üïäÔ∏è</button>
        <button class="btn gold" style="flex:1" onclick="closeModal()">Keep ‚ù§Ô∏è</button>
      </div>
    </div>
  `;
}

function releasePokemon(uid) {
  const idx = gameState.box.findIndex(p=>p.uid===uid);
  if(idx === -1) return;
  if(gameState.box.length <= 1) { toast("Can't release your last Pok√©mon!"); return; }
  const pk = gameState.box[idx];
  const teamIdx = gameState.team.indexOf(pk);
  if(teamIdx >= 0) {
    if(gameState.team.length <= 1 && gameState.box.length <= 1) return;
    gameState.team.splice(teamIdx, 1);
    if(gameState.currentFighterIdx >= gameState.team.length) gameState.currentFighterIdx = Math.max(0, gameState.team.length-1);
  }
  const equippedId = gameState.equippedItems[uid];
  if(equippedId) { gameState.inventory[equippedId] = (gameState.inventory[equippedId]||0)+1; delete gameState.equippedItems[uid]; }
  gameState.box.splice(idx, 1);
  toast(`üïäÔ∏è ${pk.name} was released!`, 3000);
  closeModal();
  renderAll();
}

// ============================================================
// QUICK RELEASE
// ============================================================

let quickReleaseSelected = new Set();

function openQuickRelease() {
  quickReleaseSelected = new Set();
  renderQuickReleaseModal();
  openModal();
}

function renderQuickReleaseModal() {
  document.getElementById('modal-title').textContent = 'üïäÔ∏è Quick Release';
  const releasable = gameState.box.filter(p => !gameState.team.includes(p));
  const selCount = quickReleaseSelected.size;
  const canRelease = selCount > 0 && (gameState.box.length - selCount) >= 1;

  document.getElementById('modal-content').innerHTML = `
    <div style="font-size:13px;color:var(--text2);margin-bottom:8px">Click to select. <span style="color:#ef5350">Selected: ${selCount}</span></div>
    <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
      <button class="btn" style="font-size:12px;padding:3px 8px" onclick="quickSelectAll(false)">Select All</button>
      <button class="btn" style="font-size:12px;padding:3px 8px" onclick="quickSelectAll(true)">Deselect All</button>
      <button class="btn" style="font-size:12px;padding:3px 8px" onclick="quickSelectBelow()">Select Lv&lt;50</button>
    </div>
    <div class="poke-box" style="max-height:320px;overflow-y:auto">
      ${releasable.map(p => {
        const sel = quickReleaseSelected.has(p.uid);
        return `<div class="poke-card${p.isShiny?' shiny-card':''}" onclick="toggleQuickSelect(${p.uid})" style="cursor:pointer;${sel?'border-color:#ef5350;background:rgba(239,83,80,0.2)':''}">
          ${sel ? '<div style="position:absolute;top:3px;left:3px;font-size:16px">‚úì</div>' : ''}
          ${p.isShiny ? '<div style="position:absolute;top:3px;right:4px;font-size:14px">‚òÖ</div>' : ''}
          <img src="${getSpriteUrl(p.id,p.isShiny)}" onerror="this.src='${getBattleSprite(p.id,p.isShiny)}'">
          <span class="cname">${p.name}</span>
          <span class="clevel">Lv.${p.level}</span>
        </div>`;
      }).join('')}
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" style="flex:1;border-color:#ef5350;color:#ef5350" onclick="confirmQuickRelease()" ${canRelease?'':'disabled'}>Release ${selCount > 0 ? `√ó${selCount}` : ''} üïäÔ∏è</button>
      <button class="btn gold" style="flex:1" onclick="closeModal()">Cancel</button>
    </div>
  `;
}

function toggleQuickSelect(uid) {
  if(quickReleaseSelected.has(uid)) quickReleaseSelected.delete(uid);
  else quickReleaseSelected.add(uid);
  renderQuickReleaseModal();
}

function quickSelectAll(deselect) {
  if(deselect) { quickReleaseSelected.clear(); }
  else {
    const releasable = gameState.box.filter(p => !gameState.team.includes(p));
    releasable.slice(0, Math.max(0, releasable.length - 1)).forEach(p => quickReleaseSelected.add(p.uid));
  }
  renderQuickReleaseModal();
}

function quickSelectBelow(threshold=50) {
  quickReleaseSelected.clear();
  const releasable = gameState.box.filter(p => !gameState.team.includes(p) && p.level < threshold);
  const keepCount = gameState.box.length - releasable.length;
  if(keepCount < 1) releasable.slice(1).forEach(p => quickReleaseSelected.add(p.uid));
  else releasable.forEach(p => quickReleaseSelected.add(p.uid));
  renderQuickReleaseModal();
}

function confirmQuickRelease() {
  if(quickReleaseSelected.size === 0) return;
  if(gameState.box.length - quickReleaseSelected.size < 1) { toast("Can't release your last Pok√©mon!"); return; }
  const names = [];
  quickReleaseSelected.forEach(uid => {
    const idx = gameState.box.findIndex(p=>p.uid===uid);
    if(idx === -1) return;
    const pk = gameState.box[idx];
    names.push(pk.name);
    const eqId = gameState.equippedItems[uid];
    if(eqId) { gameState.inventory[eqId]=(gameState.inventory[eqId]||0)+1; delete gameState.equippedItems[uid]; }
    const tIdx = gameState.team.indexOf(pk);
    if(tIdx >= 0) { gameState.team.splice(tIdx,1); if(gameState.currentFighterIdx>=gameState.team.length) gameState.currentFighterIdx=Math.max(0,gameState.team.length-1); }
  });
  gameState.box = gameState.box.filter(p => !quickReleaseSelected.has(p.uid));
  quickReleaseSelected.clear();
  toast(`üïäÔ∏è Released ${names.length} Pok√©mon!`, 3000);
  closeModal();
  renderAll();
}

// ============================================================
// SAVE / LOAD
// ============================================================

const SAVE_KEY = 'pkm_idle_save_v2';

function saveGame() {
  try {
    const save = {
      gold: gameState.gold, gems: gameState.gems, wins: gameState.wins, wave: gameState.wave,
      inventory: gameState.inventory, equippedItems: gameState.equippedItems,
      dailyClaimed: gameState.dailyClaimed, lastDaily: gameState.lastDaily,
      road: gameState.road, pUid, trainerName: gameState.trainerName,
      box: gameState.box.map(p=>({
        uid:p.uid, id:p.id, name:p.name, types:p.types, level:p.level,
        isShiny:p.isShiny, currentHp:p.currentHp, exp:p.exp, expToNext:p.expToNext,
        stats:p.stats, statsLoaded:p.statsLoaded, ivs:p.ivs, ot:p.ot
      })),
      teamUids: gameState.team.map(p=>p.uid),
      currentFighterIdx: gameState.currentFighterIdx,
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(save));
  } catch(e) { console.warn('Save failed:', e); }
}

function loadGame() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return false;
    const save = JSON.parse(raw);
    gameState.gold = save.gold || 500;
    gameState.gems = save.gems || 15;
    gameState.wins = save.wins || 0;
    gameState.wave = save.wave || 1;
    gameState.inventory = save.inventory || {};
    gameState.equippedItems = save.equippedItems || {};
    gameState.dailyClaimed = save.dailyClaimed || false;
    gameState.lastDaily = save.lastDaily || 0;
    gameState.road = save.road || {active:false,floor:0,winsOnFloor:0,winsNeeded:20,mode:null,farmRegionIdx:0};
    if(!gameState.road.mode) gameState.road.mode = gameState.road.active ? 'floor' : null;
    pUid = save.pUid || 0;
    gameState.trainerName = save.trainerName || 'Trainer';
    gameState.box = (save.box || []).map(p => ({ ...p, statsLoaded: !!p.stats, ivs: p.ivs || generateIVs(), ot: p.ot || save.trainerName || 'Trainer' }));
    gameState.team = (save.teamUids || []).map(uid => gameState.box.find(p=>p.uid===uid)).filter(Boolean);
    gameState.currentFighterIdx = Math.min(save.currentFighterIdx||0, Math.max(0,gameState.team.length-1));
    return gameState.box.length > 0;
  } catch(e) { console.warn('Load failed:', e); return false; }
}

setInterval(saveGame, 30000);
function forceSave() { saveGame(); toast('üíæ Game saved!', 2000); }

function confirmWipeData() {
  document.getElementById('modal-title').textContent = '‚ö†Ô∏è Reset All Data?';
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:10px">
      <div style="font-size:40px;margin-bottom:10px">‚ö†Ô∏è</div>
      <div style="color:var(--text2);margin-bottom:16px">This will delete ALL progress. Cannot be undone!</div>
      <div style="display:flex;gap:10px;justify-content:center">
        <button class="btn" style="border-color:#ef5350;color:#ef5350" onclick="wipeData()">Yes, reset everything</button>
        <button class="btn gold" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  `;
  openModal();
}

function wipeData() { localStorage.removeItem(SAVE_KEY); closeModal(); location.reload(); }

// ============================================================
// TRASH ITEM
// ============================================================

function trashItem(itemId) {
  const item = ITEMS.concat(EPIC_ITEMS).find(i=>i.id===itemId);
  if(!item) return;
  const count = gameState.inventory[itemId] || 0;
  if(count <= 0) return;
  document.getElementById('modal-title').textContent = `üóëÔ∏è Trash ${item.name}?`;
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:10px">
      <div style="font-size:50px;margin-bottom:10px">${item.emoji}</div>
      <div style="color:var(--text2);margin-bottom:8px">${item.desc}</div>
      <div style="margin-bottom:14px">You have √ó${count}.</div>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button class="btn" style="border-color:#ef5350;color:#ef5350" onclick="doTrashItem('${itemId}',1)">Trash √ó1</button>
        ${count>1?`<button class="btn" style="border-color:#ef5350;color:#ef5350" onclick="doTrashItem('${itemId}',${count})">Trash all √ó${count}</button>`:''}
        <button class="btn gold" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  `;
  openModal();
}

function doTrashItem(itemId, amount) {
  const item = ITEMS.find(i=>i.id===itemId);
  gameState.inventory[itemId] = Math.max(0, (gameState.inventory[itemId]||0) - amount);
  toast(`üóëÔ∏è Trashed √ó${amount} ${item?.name}`);
  closeModal();
  renderItems();
}

// ============================================================
// DIAMOND ROAD
// ============================================================

const ROAD_FLOORS = [
  {name:'Stardust Path',   minFloor:0, scaleMult:1.0, winsNeeded:40,  bonusGems:5,   goldBonus:200,  minLevel:15,  fixedEnemyLevel:20},
  {name:'Nebula Trail',    minFloor:1, scaleMult:1.3, winsNeeded:60,  bonusGems:10,  goldBonus:400,  minLevel:30,  fixedEnemyLevel:40},
  {name:'Cosmic Corridor', minFloor:2, scaleMult:1.7, winsNeeded:80,  bonusGems:18,  goldBonus:800,  minLevel:60,  fixedEnemyLevel:75,  gemsPerFive:1},
  {name:'Void Passage',    minFloor:3, scaleMult:2.2, winsNeeded:100, bonusGems:28,  goldBonus:1500, minLevel:100, fixedEnemyLevel:120, gemsPerFive:1},
  {name:'Astral Summit',   minFloor:4, scaleMult:3.0, winsNeeded:150, bonusGems:50,  goldBonus:3000, minLevel:150, fixedEnemyLevel:180, gemsPerThree:1},
  {name:'Celestial Apex',  minFloor:5, scaleMult:4.5, winsNeeded:200, bonusGems:100, goldBonus:8000, minLevel:200, fixedEnemyLevel:250, gemsPerThree:1},
];

function getAvgTeamLevel() {
  if(gameState.team.length === 0) return 5;
  return Math.floor(gameState.team.reduce((s,p)=>s+p.level,0)/gameState.team.length);
}

function renderRoadUI() {
  const el = document.getElementById('road-ui');
  const avgLvl = getAvgTeamLevel();
  const road = gameState.road;

  let html = `<div class="road-header">üíé DIAMOND ROAD üíé</div>
    <div style="font-size:13px;color:var(--text2);text-align:center;margin-bottom:4px">Your avg level: <span style="color:var(--gold)">Lv.${avgLvl}</span></div>
    <div style="font-size:12px;color:var(--accent);text-align:center;margin-bottom:10px">Enemies scale to <span style="color:var(--gold)">Lv.${Math.min(270, avgLvl + 10)}</span> (avg +10)</div>`;

  if(road.active && road.mode === 'floor') {
    const floor = ROAD_FLOORS[road.floor];
    const pct = Math.floor((road.winsOnFloor / floor.winsNeeded)*100);
    const nextGemIn = floor.gemsPerThree ? `üíé every 3 wins` : floor.gemsPerFive ? `üíé every 5 wins` : `üíé every 10 wins`;
    html += `
      <div class="road-floor-card active-floor">
        <div class="road-floor-title">‚ñ∂ ${floor.name}</div>
        <div class="road-floor-lvl">Enemy Lv.~${Math.min(270, avgLvl + 10)} ¬∑ ${nextGemIn}</div>
        <div class="road-floor-reward">${floor.bonusGems} üíé on clear ¬∑ +${floor.goldBonus}üí∞/win</div>
        <div class="road-progress-bar"><div class="road-progress-fill" style="width:${pct}%"></div></div>
        <div style="font-size:13px;color:var(--text2);margin-top:3px">${road.winsOnFloor}/${floor.winsNeeded} wins</div>
      </div>
      <button class="btn" style="width:100%;border-color:#ef5350;color:#ef5350;margin-bottom:12px" onclick="exitRoad()">üö™ Exit Road</button>`;
  } else if(road.active && road.mode === 'farm') {
    const reg = REGIONS[road.farmRegionIdx || 0];
    html += `
      <div class="road-floor-card active-floor" style="border-color:#66bb6a">
        <div class="road-floor-title" style="color:#66bb6a">üåæ FARMING: ${reg.name}</div>
        <div class="road-floor-reward" style="color:#a5d6a7">EXP &amp; Gold grind</div>
      </div>
      <button class="btn" style="width:100%;border-color:#ef5350;color:#ef5350;margin-bottom:12px" onclick="exitRoad()">üö™ Stop Farming</button>`;
  } else {
    html += `<div style="font-family:'Press Start 2P';font-size:7px;color:var(--text2);margin-bottom:6px;text-align:center">DIAMOND ROAD FLOORS</div>`;
    ROAD_FLOORS.forEach((floor, idx) => {
      const rate = floor.gemsPerThree ? '1üíé/3 wins' : floor.gemsPerFive ? '1üíé/5 wins' : '1üíé/10 wins';
      const locked = avgLvl < floor.minLevel;
      html += `<div class="road-floor-card ${locked ? '' : ''}" ${locked ? '' : `onclick="enterRoad(${idx})"`} style="${locked ? 'opacity:0.5;cursor:not-allowed' : ''}">
        <div class="road-floor-title">${locked ? 'üîí ' : ''}${floor.name}</div>
        <div class="road-floor-lvl">${floor.winsNeeded} wins to clear${locked ? ` ¬∑ Need avg Lv.${floor.minLevel}` : ''}</div>
        <div class="road-floor-reward">${rate} ¬∑ ${floor.bonusGems}üíé on clear ¬∑ +${floor.goldBonus}üí∞/win</div>
      </div>`;
    });

    const unlockedRegions = REGIONS.filter(r => gameState.wave >= r.minWave);
    if(unlockedRegions.length > 0) {
      html += `<div style="font-family:'Press Start 2P';font-size:7px;color:#66bb6a;margin:12px 0 6px;text-align:center">üåæ FARM ROUTES</div>`;
      unlockedRegions.forEach((reg) => {
        const regIdx = REGIONS.indexOf(reg);
        html += `<div class="road-floor-card" onclick="enterFarmRoute(${regIdx})" style="border-color:#2e7d32">
          <div class="road-floor-title" style="color:#66bb6a">üåæ ${reg.name}</div>
          <div class="road-floor-lvl">Scales with your team ¬∑ Gold &amp; EXP</div>
        </div>`;
      });
    }

    html += `
      <div style="font-family:'Press Start 2P';font-size:6px;color:#ffd700;margin:12px 0 4px;text-align:center">üèîÔ∏è VICTORY ROAD</div>
      <div class="victory-road-card" onclick="startVictoryRoad()">
        <div class="vr-title">‚õ∞Ô∏è VICTORY ROAD ‚Äî Lv.265</div>
        <div class="vr-subtitle">Garchomp ¬∑ Kingambit ¬∑ Hydreigon ¬∑ more</div>
        <div class="vr-reward">~30% capture ¬∑ Shiny 1/50 ¬∑ Infinite fights</div>
        <button class="btn" style="border-color:#ffd700;color:#ffd700;width:100%;margin-top:8px">‚öîÔ∏è CHALLENGE (80üíé)</button>
      </div>
      <div class="road-floor-card" style="border-color:#ff6d00;background:linear-gradient(135deg,rgba(80,20,0,0.6),rgba(30,5,0,0.4))">
        <div class="road-floor-title" style="color:#ff9e40">üêâ TITAN RAYQUAZA Lv.270</div>
        <div class="road-floor-reward" style="color:#ffd700">Capture it! ¬∑ Shiny 1/25 ¬∑ Cost: üíé150</div>
        <button class="btn" style="border-color:#ff6d00;color:#ff9e40;width:100%;margin-top:8px" onclick="startEventBoss()">‚öîÔ∏è CHALLENGE THE TITAN</button>
      </div>
      <div class="road-floor-card" style="border-color:#9c27b0;background:linear-gradient(135deg,rgba(50,0,80,0.8),rgba(20,0,40,0.6))">
        <div class="road-floor-title" style="color:#ce93d8">üëª GIRATINA Lv.270</div>
        <div class="road-floor-reward" style="color:#ba68c8">The Renegade Pok√©mon ¬∑ Shiny 1/20 ¬∑ Cost: üíé250</div>
        <button class="btn" style="border-color:#9c27b0;color:#ce93d8;width:100%;margin-top:8px" onclick="startGiratinaBoss()">‚öîÔ∏è ENTER THE DISTORTION WORLD</button>
      </div>`;
  }

  el.innerHTML = html;
}

function enterRoad(floorIdx) {
  const avgLvl = getAvgTeamLevel();
  const floor = ROAD_FLOORS[floorIdx];
  if(avgLvl < floor.minLevel) { toast(`Need avg Lv.${floor.minLevel}!`, 3000); return; }
  gameState.road.active = true;
  gameState.road.mode = 'floor';
  gameState.road.floor = floorIdx;
  gameState.road.winsOnFloor = 0;
  gameState.road.winsNeeded = floor.winsNeeded;
  document.getElementById('arena').classList.add('road-mode');
  addLog(`üíé Entered ${floor.name}!`, 'log-evolve');
  toast(`üíé Diamond Road: ${floor.name}!`, 3000);
  spawnRoadEnemy();
  renderRoadUI();
  switchTab('team');
}

function enterFarmRoute(regionIdx) {
  const reg = REGIONS[regionIdx];
  if(gameState.wave < reg.minWave) { toast(`Haven't reached ${reg.name} yet!`, 3000); return; }
  gameState.road.active = true;
  gameState.road.mode = 'farm';
  gameState.road.farmRegionIdx = regionIdx;
  document.getElementById('arena').classList.add('road-mode');
  addLog(`üåæ Farming ${reg.name}!`, 'log-heal');
  toast(`üåæ Farming ${reg.name}!`, 2500);
  spawnFarmEnemy();
  renderRoadUI();
  switchTab('team');
}

async function spawnFarmEnemy() {
  if(!gameState.road.active || gameState.road.mode !== 'farm') return;
  const regIdx = gameState.road.farmRegionIdx || 0;
  const reg = REGIONS[regIdx];
  const avgLvl = getAvgTeamLevel();
  const targetLvl = Math.max(1, avgLvl - 3);
  const lvl = Math.max(1, targetLvl + Math.floor((Math.random()-0.5)*4));
  const pool = reg.pool;
  const chosen = pool[Math.floor(Math.random()*pool.length)];
  const isShiny = Math.random() < 1/512;
  const enemy = newPokemonEntry(chosen.id, chosen.name, chosen.types, lvl, isShiny);
  enemy.stats = await fetchPokemonStats(chosen.id);
  enemy.statsLoaded = true;
  enemy.currentHp = getMaxHp(enemy);
  currentEnemy = enemy;
  const flash = document.getElementById('encounter-flash');
  flash.style.transition = 'opacity 0.05s';
  flash.style.opacity = '0.5';
  setTimeout(()=>{ flash.style.transition = 'opacity 1.2s'; flash.style.opacity = '0'; }, 120);
  updateEnemyUI();
  if(isShiny) addLog(`‚ú® Farm SHINY ${chosen.name}! (Lv.${lvl})`, 'log-shiny');
  else addLog(`üåæ ${chosen.name} (Lv.${lvl}) appeared!`);
}

function exitRoad() {
  gameState.road.active = false;
  gameState.road.mode = null;
  document.getElementById('arena').classList.remove('road-mode');
  addLog('Returned to normal battles.', 'log-heal');
  toast('Returned to normal battles.');
  currentEnemy = null;
  setTimeout(spawnEnemy, 800);
  renderRoadUI();
  switchTab('team');
}

async function spawnRoadEnemy() {
  if(!gameState.road.active) return;
  const avgLvl = getAvgTeamLevel();
  const isBossSpawn = Math.random() < 0.05;

  if(isBossSpawn) {
    const DIAMOND_BOSSES = [
      {id:384,name:'Rayquaza',types:['dragon','flying']},
      {id:249,name:'Lugia',types:['psychic','flying']},
      {id:250,name:'Ho-Oh',types:['fire','flying']},
      {id:382,name:'Kyogre',types:['water']},
      {id:383,name:'Groudon',types:['ground']},
    ];
    const bossTemplate = DIAMOND_BOSSES[Math.floor(Math.random()*DIAMOND_BOSSES.length)];
    const bossStats = await fetchPokemonStats(bossTemplate.id);
    const boss = newPokemonEntry(bossTemplate.id, bossTemplate.name, bossTemplate.types, 270, false);
    boss.stats = bossStats;
    boss.statsLoaded = true;
    boss.currentHp = getMaxHp(boss);
    boss._roadBoss = true;
    currentEnemy = boss;
    const flash = document.getElementById('encounter-flash');
    flash.style.transition = 'opacity 0.05s';
    flash.style.opacity = '1';
    setTimeout(()=>{ flash.style.transition = 'opacity 1.2s'; flash.style.opacity = '0'; }, 120);
    updateEnemyUI();
    addLog(`üêâ DIAMOND BOSS: ${bossTemplate.name} Lv.270!`, 'log-evolve');
    toast(`‚ö†Ô∏è BOSS SPAWN: ${bossTemplate.name} Lv.270!`, 3000);
    return;
  }

  const targetLvl = Math.min(270, avgLvl + 10);
  const lvl = Math.max(1, targetLvl + Math.floor((Math.random()-0.5)*6));
  const pool = GACHA_POOL;
  const chosen = pool[Math.floor(Math.random()*pool.length)];
  const isShiny = Math.random() < 1/512;
  const enemy = newPokemonEntry(chosen.id, chosen.name, chosen.types, lvl, isShiny);
  enemy.stats = await fetchPokemonStats(chosen.id);
  enemy.statsLoaded = true;
  enemy.currentHp = getMaxHp(enemy);
  currentEnemy = enemy;
  const flash = document.getElementById('encounter-flash');
  flash.style.transition = 'opacity 0.05s';
  flash.style.opacity = '0.8';
  setTimeout(()=>{ flash.style.transition = 'opacity 1.2s'; flash.style.opacity = '0'; }, 120);
  updateEnemyUI();
  if(isShiny) addLog(`‚ú® Road SHINY ${chosen.name}! (Lv.${lvl})`, 'log-shiny');
  else addLog(`üíé Road: ${chosen.name} (Lv.${lvl}) appeared!`);
}

// ============================================================
// DEBUG STAT MANIPULATOR
// ============================================================

function loadDebugStatRows(pokemon) {
  const rowsContainer = document.getElementById('dbg-stat-rows');
  const infoEl = document.getElementById('dbg-stat-info');
  
  if (!pokemon || !pokemon.ivs) {
    rowsContainer.innerHTML = '<div style="color:#8888bb;text-align:center">No Pok√©mon selected or IVs not loaded</div>';
    infoEl.textContent = 'Select a Pok√©mon first';
    return;
  }

  const statNames = {
    'hp': 'HP',
    'attack': 'Attack',
    'defense': 'Defense',
    'special-attack': 'Sp.Atk',
    'special-defense': 'Sp.Def',
    'speed': 'Speed'
  };

  infoEl.innerHTML = `Editing IVs for <span style="color:${pokemon.isShiny ? '#ff69b4' : '#ffd700'}">${pokemon.name}</span> (Lv.${pokemon.level})`;

  let html = '';
  for (const [statKey, statLabel] of Object.entries(statNames)) {
    const currentIV = pokemon.ivs[statKey] || 0;
    const grade = getStatGrade(currentIV);
    const gradeColor = grade.isSS ? '#ff69b4' : grade.color;
    
    html += `
      <div style="display:flex;align-items:center;gap:8px;">
        <div style="width:70px;font-size:14px;color:var(--text2)">${statLabel}</div>
        <div style="flex:1;display:flex;align-items:center;gap:4px;">
          <input type="range" id="iv-${statKey}" min="0" max="31" value="${currentIV}" 
                 style="flex:1;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;
                        accent-color:${gradeColor}" 
                 oninput="document.getElementById('iv-val-${statKey}').textContent = this.value">
          <span id="iv-val-${statKey}" style="min-width:40px;text-align:center;color:${gradeColor};font-weight:bold">${currentIV}</span>
          <span style="font-family:'Press Start 2P';font-size:7px;min-width:22px;color:${gradeColor}">${grade.label}</span>
        </div>
      </div>
    `;
  }

  // Add total IV and average display
  const totalIV = Object.values(pokemon.ivs).reduce((a, b) => a + b, 0);
  const avgIV = Math.round(totalIV / 6);
  const avgGrade = getStatGrade(avgIV);
  
  html += `
    <div style="margin-top:12px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1)">
      <div style="display:flex;justify-content:space-between;font-size:14px">
        <span style="color:var(--text2)">Total IV:</span>
        <span style="color:${avgGrade.isSS ? '#ff69b4' : avgGrade.color}">${totalIV}/186 (${Math.round(totalIV/186*100)}%)</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:14px;margin-top:4px">
        <span style="color:var(--text2)">Average:</span>
        <span style="color:${avgGrade.isSS ? '#ff69b4' : avgGrade.color}">${avgIV} (Grade ${avgGrade.label})</span>
      </div>
    </div>
  `;

  rowsContainer.innerHTML = html;
}

function debugSetAllIVs(value) {
  const fighter = getCurrentFighter();
  if (!fighter || !fighter.ivs) return;
  
  for (const key in fighter.ivs) {
    fighter.ivs[key] = value;
  }
  
  // Update HP based on new IVs
  if (fighter.statsLoaded) {
    fighter.currentHp = getMaxHp(fighter);
  }
  
  loadDebugStatRows(fighter);
  toast(`‚ú® All IVs set to ${value}!`, 2000);
}

function debugRandomizeIVs() {
  const fighter = getCurrentFighter();
  if (!fighter || !fighter.ivs) return;
  
  fighter.ivs = generateIVs();
  
  // Update HP based on new IVs
  if (fighter.statsLoaded) {
    fighter.currentHp = getMaxHp(fighter);
  }
  
  loadDebugStatRows(fighter);
  toast('üé≤ IVs randomized!', 2000);
}

function debugApplyStats() {
  const fighter = getCurrentFighter();
  if (!fighter || !fighter.ivs) return;
  
  // Update all IVs from the range sliders
  const statKeys = ['hp', 'attack', 'defense', 'special-attack', 'special-defense', 'speed'];
  
  for (const key of statKeys) {
    const slider = document.getElementById(`iv-${key}`);
    if (slider) {
      fighter.ivs[key] = parseInt(slider.value, 10);
    }
  }
  
  // Update HP based on new IVs
  if (fighter.statsLoaded) {
    fighter.currentHp = getMaxHp(fighter);
  }
  
  // Check if this made the Pokemon Cosmic
  if (isCosmic(fighter)) {
    toast(`üåå ${fighter.name} is now COSMIC!`, 3000);
    addLog(`üåå ${fighter.name} radiates COSMIC energy!`, 'log-cosmic');
  }
  
  renderAll();
  loadDebugStatRows(fighter);
  toast('‚úÖ IV changes applied!', 2000);
}

// ============================================================
// MULTI-SAVE SYSTEM
// ============================================================

const MULTI_SAVE_KEY = 'pkm_idle_saves';
const MAX_SAVES = 5;

function getAllSaves() {
  try { return JSON.parse(localStorage.getItem(MULTI_SAVE_KEY) || '[]'); }
  catch(e) { return []; }
}

function setAllSaves(saves) {
  localStorage.setItem(MULTI_SAVE_KEY, JSON.stringify(saves));
}

function buildSaveData(slotName) {
  return {
    name: slotName,
    savedAt: Date.now(),
    gold: gameState.gold, gems: gameState.gems, wins: gameState.wins, wave: gameState.wave,
    inventory: gameState.inventory, equippedItems: gameState.equippedItems,
    dailyClaimed: gameState.dailyClaimed, lastDaily: gameState.lastDaily,
    road: gameState.road, pUid, trainerName: gameState.trainerName,
    box: gameState.box.map(p=>({
      uid:p.uid, id:p.id, name:p.name, types:p.types, level:p.level,
      isShiny:p.isShiny, currentHp:p.currentHp, exp:p.exp, expToNext:p.expToNext,
      stats:p.stats, statsLoaded:p.statsLoaded, ivs:p.ivs, ot:p.ot
    })),
    teamUids: gameState.team.map(p=>p.uid),
    currentFighterIdx: gameState.currentFighterIdx,
  };
}

function openSavesOverlay() {
  renderSaveSlots();
  document.getElementById('saves-overlay').classList.add('active');
}

function closeSavesOverlay() {
  document.getElementById('saves-overlay').classList.remove('active');
}

function renderSaveSlots() {
  const saves = getAllSaves();
  const list = document.getElementById('saves-list');
  let html = '';

  // Header with trainer name + new game button
  html += `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:6px">
    <div style="font-size:13px;color:var(--text2)">
      Trainer: <span style="color:var(--gold)">${gameState.trainerName}</span>
      <button onclick="changeTrainerName()" style="background:rgba(255,255,255,0.05);border:1px solid var(--border);color:var(--text2);padding:2px 8px;border-radius:4px;cursor:pointer;margin-left:6px;font-family:'VT323',monospace;font-size:14px">‚úèÔ∏è Rename</button>
    </div>
    <button onclick="startFreshGame()" style="background:linear-gradient(135deg,rgba(239,83,80,0.2),rgba(239,83,80,0.05));border:1px solid #ef5350;color:#ef5350;padding:5px 12px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:15px;letter-spacing:1px">üå± NEW GAME</button>
  </div>`;

  for(let i = 0; i < MAX_SAVES; i++) {
    const s = saves[i];
    if(s) {
      const date = new Date(s.savedAt);
      const dateStr = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
      const teamUids = s.teamUids || [];
      const teamPokemon = teamUids.map(uid => (s.box||[]).find(p=>p.uid===uid)).filter(Boolean);
      const teamImgs = teamPokemon.map(p => 
        `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p.isShiny?'shiny/':''}${p.id}.png" title="${p.name} Lv.${p.level}${p.isShiny?' ‚òÖ':''}">`
      ).join('');
      html += `<div class="save-slot-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div style="font-family:'Press Start 2P';font-size:8px;color:var(--gold)">${s.name}</div>
            <div style="font-size:13px;color:var(--text2);margin-top:3px">OT: ${s.trainerName||'Trainer'} ¬∑ Avg Lv.${s.box?Math.round(s.box.reduce((a,p)=>a+p.level,0)/Math.max(1,s.box.length)):1}</div>
            <div style="font-size:12px;color:var(--text2)">üí∞${formatNum(s.gold||0)} ¬∑ üíé${s.gems||0} ¬∑ üèÜ${s.wins||0} ¬∑ ${s.box?s.box.length:0} Pok√©mon</div>
            <div style="font-size:11px;color:#555">${dateStr}</div>
            <div class="save-mini-team">${teamImgs}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0">
            <button onclick="loadSaveSlot(${i})" style="background:rgba(79,195,247,0.15);border:1px solid var(--accent);color:var(--accent);padding:4px 10px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:15px">üìÇ Load</button>
            <button onclick="overwriteSaveSlot(${i})" style="background:rgba(102,187,106,0.15);border:1px solid var(--green);color:var(--green);padding:4px 10px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:15px">üíæ Save</button>
            <button onclick="deleteSaveSlot(${i})" style="background:rgba(239,83,80,0.1);border:1px solid var(--red);color:var(--red);padding:4px 10px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:15px">üóë Del</button>
          </div>
        </div>
      </div>`;
    } else {
      html += `<div class="save-slot-card empty">
        <div style="text-align:center;padding:6px 0 2px;font-size:13px;color:var(--text2);margin-bottom:8px">Empty Slot ${i+1}</div>
        <div style="display:flex;gap:6px;justify-content:center">
          <button onclick="createNewSave(${i})" style="background:rgba(102,187,106,0.12);border:1px solid var(--green);color:var(--green);padding:5px 12px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:15px;flex:1">üíæ Save Current</button>
          <button onclick="saveAndStartFresh(${i})" style="background:rgba(239,83,80,0.1);border:1px solid #ef5350;color:#ef5350;padding:5px 12px;border-radius:6px;cursor:pointer;font-family:'VT323',monospace;font-size:15px;flex:1">üå± New Game Here</button>
        </div>
      </div>`;
    }
  }
  list.innerHTML = html;
}

function createNewSave(slotIdx) {
  const name = prompt('Name this save:', `Save ${slotIdx+1}`);
  if(!name) return;
  const saves = getAllSaves();
  saves[slotIdx] = buildSaveData(name.trim() || `Save ${slotIdx+1}`);
  setAllSaves(saves);
  toast(`üíæ Saved to slot: ${saves[slotIdx].name}`, 2500);
  renderSaveSlots();
}

function overwriteSaveSlot(slotIdx) {
  const saves = getAllSaves();
  const existing = saves[slotIdx];
  saves[slotIdx] = buildSaveData(existing ? existing.name : `Save ${slotIdx+1}`);
  setAllSaves(saves);
  toast(`üíæ Slot overwritten!`, 2000);
  renderSaveSlots();
}

function loadSaveSlot(slotIdx) {
  const saves = getAllSaves();
  const s = saves[slotIdx];
  if(!s) return;
  if(!confirm(`Load "${s.name}"? Current progress may be lost if unsaved.`)) return;
  try {
    // Stop all active battles first
    if(battleTimer) { clearInterval(battleTimer); battleTimer = null; }
    bossBattleActive = false; vrBattleActive = false; giratinaBattleActive = false;
    currentEnemy = null; bossEnemy = null; vrEnemy = null; giratinaEnemy = null;
    battlePaused = false;
    playerAttackCooldown = 0; enemyAttackCooldown = 0;
    document.getElementById('arena').classList.remove('road-mode');
    document.getElementById('arena').style.background = '';

    // Load all state
    gameState.gold = s.gold || 500;
    gameState.gems = s.gems || 15;
    gameState.wins = s.wins || 0;
    gameState.wave = s.wave || 1;
    gameState.inventory = s.inventory || {};
    gameState.equippedItems = s.equippedItems || {};
    gameState.dailyClaimed = s.dailyClaimed || false;
    gameState.lastDaily = s.lastDaily || 0;
    gameState.road = s.road || {active:false,floor:0,winsOnFloor:0,winsNeeded:20,mode:null,farmRegionIdx:0};
    if(!gameState.road.mode) gameState.road.mode = gameState.road.active ? 'floor' : null;
    gameState.trainerName = s.trainerName || 'Trainer';
    pUid = s.pUid || 0;
    gameState.box = (s.box || []).map(p => ({ ...p, statsLoaded: !!p.stats, ivs: p.ivs || generateIVs(), ot: p.ot || s.trainerName || 'Trainer' }));
    gameState.team = (s.teamUids || []).map(uid => gameState.box.find(p=>p.uid===uid)).filter(Boolean);
    gameState.currentFighterIdx = Math.min(s.currentFighterIdx||0, Math.max(0,gameState.team.length-1));

    // Restore road mode visuals
    if(gameState.road.active) document.getElementById('arena').classList.add('road-mode');

    closeSavesOverlay();
    renderAll();

    // Restart battle with correct state
    if(gameState.road.active) {
      if(gameState.road.mode === 'farm') spawnFarmEnemy();
      else spawnRoadEnemy();
    } else {
      spawnEnemy();
    }
    startBattle();

    toast(`‚úÖ Loaded: ${s.name} (Wave ${gameState.wave})`, 3000);
  } catch(e) { console.warn(e); toast('‚ùå Failed to load save!', 3000); }
}

function deleteSaveSlot(slotIdx) {
  if(!confirm('Delete this save slot?')) return;
  const saves = getAllSaves();
  saves[slotIdx] = undefined;
  setAllSaves(saves.map(s=>s));
  renderSaveSlots();
  toast('üóë Save deleted.', 2000);
}

function changeTrainerName() {
  const name = prompt('Enter trainer name:', gameState.trainerName);
  if(!name || !name.trim()) return;
  gameState.trainerName = name.trim().substring(0, 12);
  toast(`‚úèÔ∏è Trainer name: ${gameState.trainerName}`, 2000);
  renderSaveSlots();
}

function startFreshGame() {
  if(!confirm('Start a brand new game? Your current unsaved progress will be lost!\n\nTip: Save first using one of the slots before starting fresh.')) return;
  closeSavesOverlay();
  _resetGameState('Trainer');
}

function saveAndStartFresh(slotIdx) {
  const name = prompt('Enter trainer name for new game:', `Trainer`);
  if(name === null) return; // cancelled
  if(!confirm('Start a new game in this slot? Your current unsaved progress will be lost!')) return;
  closeSavesOverlay();
  _resetGameState(name.trim().substring(0, 12) || 'Trainer');
}

function _resetGameState(trainerName) {
  // Stop battle
  if(battleTimer) { clearInterval(battleTimer); battleTimer = null; }
  bossBattleActive = false; vrBattleActive = false; giratinaBattleActive = false;
  currentEnemy = null; bossEnemy = null; vrEnemy = null; giratinaEnemy = null;
  battlePaused = false; pUid = 0;
  playerAttackCooldown = 0; enemyAttackCooldown = 0;

  // Reset state (don't touch localStorage ‚Äî keep existing saves intact)
  gameState.gold = 500; gameState.gems = 15; gameState.wins = 0; gameState.wave = 1;
  gameState.autoBattle = true; gameState.team = []; gameState.box = [];
  gameState.inventory = {}; gameState.equippedItems = {};
  gameState.currentFighterIdx = 0; gameState.dailyClaimed = false; gameState.lastDaily = 0;
  gameState.road = { active: false, floor: 0, winsOnFloor: 0, winsNeeded: 30, mode: null, farmRegionIdx: 0 };
  gameState.trainerName = trainerName;

  // Reset arena
  document.getElementById('arena').classList.remove('road-mode');
  document.getElementById('arena').style.background = '';

  // Hide game, show starter screen
  document.getElementById('game').style.display = 'none';
  document.getElementById('starter-screen').style.display = 'flex';
  showStarterPicker();

  toast(`üå± New game! Welcome, ${trainerName}! Choose your starter!`, 4000);
}

// ============================================================
// GOLD SHINY PULL
// ============================================================

async function doGoldShinyPull() {
  const cost = 10000000;
  if(gameState.gold < cost) {
    toast(`Need 10,000,000 üí∞ Gold! (have ${formatNum(gameState.gold)})`, 3000);
    return;
  }
  gameState.gold -= cost;
  updateResourceUI();
  const chosen = pickFromPool(EPIC_GACHA_POOL);
  const level = Math.min(175, Math.max(1, Math.floor(gameState.wave * 0.3 + 5)));
  const pk = newPokemonEntry(chosen.id, chosen.name, chosen.types, level, true);
  pk.stats = await fetchPokemonStats(chosen.id);
  pk.statsLoaded = true;
  pk.currentHp = getMaxHp(pk);
  gameState.box.push(pk);
  if(isCosmic(pk)) checkAndAnnounceCosmic(pk);
  else { addLog(`üí∞ Gold Shiny! ‚ú® ${pk.name} obtained!`, 'log-shiny'); toast(`üí∞‚ú® GOLD SHINY: ${pk.name}!`, 4000); }
  renderAll();
  showGachaResult(pk);
}

// ============================================================
// TRADING SYSTEM
// ============================================================

function encodePokemonTrade(pk) {
  const data = {
    uid: pk.uid, id: pk.id, name: pk.name, types: pk.types, level: pk.level,
    isShiny: pk.isShiny, exp: pk.exp, expToNext: pk.expToNext,
    stats: pk.stats, statsLoaded: pk.statsLoaded, ivs: pk.ivs,
    ot: pk.ot || gameState.trainerName, currentHp: pk.currentHp,
  };
  return btoa(unescape(encodeURIComponent(JSON.stringify(data))));
}

function decodePokemonTrade(code) {
  try {
    const data = JSON.parse(decodeURIComponent(escape(atob(code.trim()))));
    if(!data.id || !data.name) throw new Error('Invalid');
    return data;
  } catch(e) { return null; }
}

function openTradeOverlay() {
  document.getElementById('trade-content').innerHTML = renderTradeMenu();
  document.getElementById('trade-overlay').classList.add('active');
}

function closeTradeOverlay() {
  document.getElementById('trade-overlay').classList.remove('active');
}

function renderTradeMenu() {
  return `
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <button class="btn" style="flex:1;border-color:#00c853;color:#69f0ae;font-size:16px" onclick="showTradePickPokemon()">üì§ Send Trade</button>
      <button class="btn" style="flex:1;border-color:#4fc3f7;color:var(--accent);font-size:16px" onclick="showTradeReceive()">üì• Receive Trade</button>
    </div>
    <div style="font-size:13px;color:var(--text2);text-align:center">Share a Trade Code with another player!<br>Use base64 codes to transfer Pok√©mon.</div>
  `;
}

function openTradeForPokemon(uid) {
  const pk = gameState.box.find(p=>p.uid===uid);
  if(!pk) return;
  openTradeOverlay();
  showTradeCode(pk);
}

function showTradePickPokemon() {
  const sorted = [...gameState.box];
  let html = `<div style="font-family:'Press Start 2P';font-size:8px;color:#69f0ae;margin-bottom:10px">PICK POK√âMON TO TRADE</div>
    <div class="poke-box" style="max-height:340px;overflow-y:auto">`;
  sorted.forEach(p => {
    const cosmic = isCosmic(p);
    html += `<div class="poke-card${cosmic?' cosmic-card':p.isShiny?' shiny-card':''}" onclick="showTradeCode_uid(${p.uid})" style="cursor:pointer">
      ${p.isShiny ? '<div style="position:absolute;top:3px;right:4px;font-size:14px">‚òÖ</div>' : ''}
      <img src="${getSpriteUrl(p.id, p.isShiny)}" onerror="this.src='${getBattleSprite(p.id,p.isShiny)}'">
      <span class="cname">${p.name}</span>
      <span class="clevel">Lv.${p.level}</span>
    </div>`;
  });
  html += `</div>`;
  document.getElementById('trade-content').innerHTML = html;
}

function showTradeCode_uid(uid) {
  const pk = gameState.box.find(p=>p.uid===uid);
  if(pk) showTradeCode(pk);
}

function showTradeCode(pk) {
  const code = encodePokemonTrade(pk);
  const cosmic = isCosmic(pk);
  document.getElementById('trade-content').innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
      <img src="${getSpriteUrl(pk.id,pk.isShiny)}" width="72" height="72" class="${cosmic?'cosmic-sprite':pk.isShiny?'shiny-sprite':''}" onerror="this.src='${getBattleSprite(pk.id,pk.isShiny)}'">
      <div>
        <div style="font-family:'Press Start 2P';font-size:8px;color:var(--gold)">${cosmic?'üåå COSMIC ':''}${pk.isShiny?'‚ú® ':''}${pk.name}</div>
        <div style="font-size:14px;color:var(--text2)">Lv.${pk.level} ¬∑ OT: ${pk.ot||'Trainer'}</div>
        <div style="font-size:13px;color:var(--text2)">${pk.types.map(t=>`<span class="type-badge" style="background:${TYPE_COLORS[t]}">${t}</span>`).join(' ')}</div>
      </div>
    </div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:4px">üì§ Trade Code (share this with the recipient):</div>
    <div class="trade-code-display" id="trade-code-val">${code}</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" style="flex:1;border-color:#00c853;color:#69f0ae" onclick="copyTradeCode()">üìã Copy Code</button>
      <button class="btn" style="flex:1;border-color:#ef5350;color:#ef5350" onclick="confirmSendTrade(${pk.uid})">‚úÖ Confirm Send</button>
    </div>
    <div style="font-size:12px;color:var(--text2);margin-top:8px;text-align:center">‚ö†Ô∏è Clicking "Confirm Send" removes the Pok√©mon from your box!</div>
  `;
}

function copyTradeCode() {
  const el = document.getElementById('trade-code-val');
  if(!el) return;
  try {
    navigator.clipboard.writeText(el.textContent).then(()=>toast('üìã Code copied!', 2000)).catch(()=>{
      const ta = document.createElement('textarea');
      ta.value = el.textContent;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      toast('üìã Code copied!', 2000);
    });
  } catch(e) { toast('Copy manually from the box above.', 3000); }
}

function confirmSendTrade(uid) {
  const pk = gameState.box.find(p=>p.uid===uid);
  if(!pk) { toast('Pok√©mon not found!', 2000); return; }
  if(gameState.box.length <= 1) { toast("Can't trade your last Pok√©mon!", 2000); return; }
  if(!confirm(`Remove ${pk.name} from your box to complete the trade?`)) return;

  // Remove from box and team
  const teamIdx = gameState.team.indexOf(pk);
  if(teamIdx >= 0) {
    if(gameState.team.length <= 1) { toast("Can't trade your last team member!", 2000); return; }
    gameState.team.splice(teamIdx, 1);
    if(gameState.currentFighterIdx >= gameState.team.length) gameState.currentFighterIdx = 0;
  }
  const boxIdx = gameState.box.indexOf(pk);
  if(boxIdx >= 0) gameState.box.splice(boxIdx, 1);

  toast(`üì§ ${pk.name} sent! Give the code to your trade partner.`, 4000);
  renderAll();
  document.getElementById('trade-content').innerHTML = `
    <div style="text-align:center;padding:20px">
      <div style="font-size:40px;margin-bottom:10px">‚úÖ</div>
      <div style="font-size:16px;color:#69f0ae">${pk.name} sent successfully!</div>
      <div style="font-size:13px;color:var(--text2);margin-top:8px">Share the trade code with your partner so they can receive it.</div>
    </div>`;
}

function showTradeReceive() {
  document.getElementById('trade-content').innerHTML = `
    <div style="font-family:'Press Start 2P';font-size:8px;color:var(--accent);margin-bottom:10px">üì• RECEIVE POK√âMON</div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:8px">Paste the trade code from your partner:</div>
    <textarea id="trade-receive-input" placeholder="Paste trade code here..."></textarea>
    <button class="btn" style="width:100%;border-color:#4fc3f7;color:var(--accent);font-size:18px" onclick="processTradeReceive()">üì• Receive Pok√©mon!</button>
  `;
}

async function processTradeReceive() {
  const code = document.getElementById('trade-receive-input')?.value?.trim();
  if(!code) { toast('Paste a trade code first!', 2000); return; }
  const data = decodePokemonTrade(code);
  if(!data) { toast('‚ùå Invalid trade code!', 3000); return; }
  
  // Give new UID and mark OT
  const pk = {
    ...data,
    uid: ++pUid,
    ot: data.ot || 'Unknown',
    statsLoaded: !!data.stats,
    ivs: data.ivs || generateIVs(),
  };
  if(!pk.stats && pk.id) {
    pk.stats = await fetchPokemonStats(pk.id);
    pk.statsLoaded = true;
  }
  if(!pk.currentHp && pk.stats) pk.currentHp = getMaxHp(pk);

  gameState.box.push(pk);
  checkAndAnnounceCosmic(pk);
  renderAll();
  const cosmic = isCosmic(pk);
  document.getElementById('trade-content').innerHTML = `
    <div style="text-align:center;padding:16px">
      <img src="${getSpriteUrl(pk.id, pk.isShiny)}" width="90" height="90" class="${cosmic?'cosmic-sprite':pk.isShiny?'shiny-sprite':''}">
      <div style="font-family:'Press Start 2P';font-size:9px;color:var(--gold);margin-top:10px">${cosmic?'üåå COSMIC ':pk.isShiny?'‚ú® ':''}${pk.name} received!</div>
      <div style="font-size:14px;color:var(--text2);margin-top:6px">Lv.${pk.level} ¬∑ OT: ${pk.ot}</div>
      <div style="font-size:13px;color:var(--text2)">${pk.types.map(t=>`<span class="type-badge" style="background:${TYPE_COLORS[t]}">${t}</span>`).join(' ')}</div>
    </div>`;
  toast(`üì• ${pk.name} received from ${pk.ot}!`, 4000);
}

// ============================================================
// GIRATINA BOSS
// ============================================================

let giratinaBattleActive = false;
let giratinaEnemy = null;

async function startGiratinaBoss() {
  if(gameState.gems < 250) { toast('Need 250 üíé Gems to challenge Giratina!'); return; }
  if(gameState.team.length === 0) { toast('You need a team!'); return; }
  battlePaused = true;
  document.getElementById('auto-btn').textContent = '‚ñ∂ RESUME';
  document.getElementById('modal-title').textContent = 'üëª GIRATINA Lv.270';
  document.getElementById('modal-content').innerHTML = `
    <div style="text-align:center;padding:8px">
      <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/487.png" width="140" height="140" style="image-rendering:pixelated;filter:drop-shadow(0 0 24px rgba(150,0,255,0.8))">
      <div style="margin:10px 0;font-family:'Press Start 2P';font-size:8px;color:#ce93d8">THE RENEGADE POK√âMON</div>
      <div style="font-size:14px;color:var(--text2);margin-bottom:12px">
        A fearsome dragon from the Distortion World.<br>Stronger than Rayquaza in every way.<br><br>
        <span style="color:#ffd700">Drop: Giratina (1/20 shiny!)</span><br>
        <span style="color:#ce93d8">Stats: 1.4√ó Rayquaza's power</span><br>
        <span style="color:var(--text2)">Cost: 250 üíé</span>
      </div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn" style="border-color:#9c27b0;color:#ce93d8" onclick="confirmGiratinaBoss()">‚öîÔ∏è Fight! (250üíé)</button>
        <button class="btn gold" onclick="closeModal()">Back</button>
      </div>
    </div>
  `;
  openModal();
}

async function confirmGiratinaBoss() {
  if(gameState.gems < 250) { toast('Not enough Gems!'); closeModal(); return; }
  gameState.gems -= 250;
  updateResourceUI();
  closeModal();
  battlePaused = true;
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;
  currentEnemy = null;
  const savedRoad = { ...gameState.road };
  gameState.road.active = false;
  document.getElementById('arena').classList.remove('road-mode');

  // Giratina is Pokemon #487 (Origin Forme)
  const giratinaStats = await fetchPokemonStats(487);
  // Scale stats 1.4x vs Rayquaza: we'll use level 378 = 270 * 1.4
  giratinaEnemy = newPokemonEntry(487, 'Giratina', ['ghost','dragon'], 270, false);
  giratinaEnemy.stats = giratinaStats;
  giratinaEnemy.statsLoaded = true;
  giratinaEnemy._bossHpMax = 32000;
  giratinaEnemy.currentHp = giratinaEnemy._bossHpMax;
  giratinaEnemy.isBoss = true;
  giratinaEnemy._isGiratina = true;
  giratinaEnemy._savedRoad = savedRoad;
  giratinaEnemy._attackMult = 0.8;
  currentEnemy = giratinaEnemy;
  giratinaBattleActive = true;
  bossBattleActive = true;
  gameState.team.forEach(p => { if(p.statsLoaded) p.currentHp = getMaxHp(p); });
  document.getElementById('arena').style.background = 'radial-gradient(ellipse at 50% 0%, rgba(130,0,200,0.4) 0%, transparent 60%), radial-gradient(ellipse at 20% 80%, rgba(50,0,100,0.5) 0%, transparent 50%), linear-gradient(180deg, #05000a 0%, #100020 40%, #080015 100%)';
  addLog('üëª GIRATINA emerged from the Distortion World!', 'log-cosmic');
  toast('üëª BOSS FIGHT: Giratina Lv.378! The Renegade awakens!', 4000);
  battlePaused = false;
  updateEnemyUI();
}

function handleGiratinaDefeated(player) {
  const savedRoad = giratinaEnemy?._savedRoad;
  giratinaBattleActive = false;
  bossBattleActive = false;
  currentEnemy = null;
  giratinaEnemy = null;
  document.getElementById('arena').style.background = '';
  if(savedRoad && savedRoad.active) { gameState.road = savedRoad; document.getElementById('arena').classList.add('road-mode'); }
  addLog('üéâ GIRATINA DEFEATED! You captured it!', 'log-cosmic');
  toast('üèÜ GIRATINA CAPTURED!', 5000);
  const isShiny = Math.random() < 1/20;
  const gt = newPokemonEntry(487, 'Giratina', ['ghost','dragon'], 270, isShiny);
  gt.ivs = generateHighIVs();
  fetchPokemonStats(487).then(stats => {
    gt.stats = stats;
    gt.statsLoaded = true;
    gt.currentHp = getMaxHp(gt);
    gameState.box.push(gt);
    checkAndAnnounceCosmic(gt);
    renderAll();
    showGachaResult(gt);
  });
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;
  const nextSpawn = (savedRoad && savedRoad.active) ? (savedRoad.mode === 'farm' ? spawnFarmEnemy : spawnRoadEnemy) : spawnEnemy;
  setTimeout(nextSpawn, 2000);
}

function handleGiratinaFailed() {
  const savedRoad = giratinaEnemy?._savedRoad;
  giratinaBattleActive = false;
  bossBattleActive = false;
  currentEnemy = null;
  giratinaEnemy = null;
  document.getElementById('arena').style.background = '';
  if(savedRoad && savedRoad.active) { gameState.road = savedRoad; document.getElementById('arena').classList.add('road-mode'); }
  addLog('üíÄ GIRATINA DEVOURED YOUR TEAM and returned to the Distortion World!', 'log-dmg');
  toast('üíÄ Giratina destroyed your team!', 5000);
  gameState.team.forEach(p => { p.currentHp = Math.max(1, Math.floor(getMaxHp(p)*0.20)); });
  gameState.currentFighterIdx = 0;
  playerAttackCooldown = 0;
  enemyAttackCooldown = 0;
  renderAll();
  const nextSpawn = (savedRoad && savedRoad.active) ? (savedRoad.mode === 'farm' ? spawnFarmEnemy : spawnRoadEnemy) : spawnEnemy;
  setTimeout(nextSpawn, 2500);
}

initStarterScreen();

// ============================================================
// DEBUG PANEL
// ============================================================
const DEBUG_PASSWORD = 'mesaschlecht099';
let debugUnlocked = false;

function openDebugPanel() {
  if (!debugUnlocked) {
    const pw = prompt('üîí Enter debug password:');
    if (pw !== DEBUG_PASSWORD) { toast('‚ùå Wrong password!', 2000); return; }
    debugUnlocked = true;
    toast('üõ† Debug panel unlocked!', 2000);
  }
  const fighter = getCurrentFighter();
  const el = document.getElementById('dbg-current-poke');
  if (fighter) el.textContent = `${fighter.isShiny ? (isCosmic(fighter)?'üåå':'‚òÖ') + ' ' : ''}${fighter.name} ¬∑ Lv.${fighter.level}`;
  else el.textContent = 'No active fighter';

  loadDebugStatRows(fighter);
  document.getElementById('debug-overlay').style.display = 'flex';
}

function closeDebug() {
  document.getElementById('debug-overlay').style.display = 'none';
}

function debugSetGold() {
  const val = parseInt(document.getElementById('dbg-gold').value);
  if (isNaN(val) || val < 0) { toast('Invalid value!', 1500); return; }
  gameState.gold = val;
  updateResourceUI();
  toast(`üí∞ Gold set to ${val.toLocaleString()}`, 1500);
}

function debugAddGold() {
  const val = parseInt(document.getElementById('dbg-gold').value);
  if (isNaN(val)) { toast('Invalid value!', 1500); return; }
  gameState.gold = Math.max(0, gameState.gold + val);
  updateResourceUI();
  toast(`üí∞ Added ${val.toLocaleString()} gold`, 1500);
}

function debugSetGems() {
  const val = parseInt(document.getElementById('dbg-gems').value);
  if (isNaN(val) || val < 0) { toast('Invalid value!', 1500); return; }
  gameState.gems = val;
  updateResourceUI();
  toast(`üíé Gems set to ${val}`, 1500);
}

function debugAddGems() {
  const val = parseInt(document.getElementById('dbg-gems').value);
  if (isNaN(val)) { toast('Invalid value!', 1500); return; }
  gameState.gems = Math.max(0, gameState.gems + val);
  updateResourceUI();
  toast(`üíé Added ${val} gems`, 1500);
}

function debugAddLevels() {
  const fighter = getCurrentFighter();
  if (!fighter) { toast('No active fighter!', 1500); return; }
  const lvls = parseInt(document.getElementById('dbg-levels').value);
  if (isNaN(lvls) || lvls < 1) { toast('Invalid level amount!', 1500); return; }
  const oldLvl = fighter.level;
  fighter.level = Math.min(250, fighter.level + lvls);
  fighter.expToNext = calcExpToNext(fighter.level);
  fighter.exp = 0;
  if (fighter.statsLoaded) fighter.currentHp = getMaxHp(fighter);
  checkEvolution(fighter);
  renderAll();
  updatePlayerUI(fighter);
  document.getElementById('dbg-current-poke').textContent = `${fighter.isShiny ? '‚òÖ ' : ''}${fighter.name} ¬∑ Lv.${fighter.level}`;
  toast(`‚¨ÜÔ∏è ${fighter.name}: Lv.${oldLvl} ‚Üí Lv.${fighter.level}`, 2000);
}
</script>
</body>
</html>
